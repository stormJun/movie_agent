name: core-only

on:
  push:
    paths:
      - "backend/graphrag_agent/**"
      - "setup.py"
      - "pyproject.toml"
      - "MANIFEST.in"
      - "scripts/verify_core_import.py"
      - "scripts/verify_core_sdist.sh"
      - "test/test_core_import.py"
      - "test/test_lazy_import_hints.py"
      - "test/test_agents_import_hints.py"
      - "test/test_tool_registry_lazy_import.py"
      - "test/test_layer_boundary_imports.py"
      - "test/test_bootstrap_provider_entrypoints.py"
      - ".github/workflows/core-only.yml"
  pull_request:
    paths:
      - "backend/graphrag_agent/**"
      - "setup.py"
      - "pyproject.toml"
      - "MANIFEST.in"
      - "scripts/verify_core_import.py"
      - "scripts/verify_core_sdist.sh"
      - "test/test_core_import.py"
      - "test/test_lazy_import_hints.py"
      - "test/test_agents_import_hints.py"
      - "test/test_tool_registry_lazy_import.py"
      - "test/test_layer_boundary_imports.py"
      - "test/test_bootstrap_provider_entrypoints.py"
      - ".github/workflows/core-only.yml"

jobs:
  core-import:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install (core only)
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install .
      - name: Verify import
        run: |
          python scripts/verify_core_import.py
      - name: Core-only unit tests
        run: |
          python -m unittest discover -s test -p 'test_core_import.py' -v
          python -m unittest discover -s test -p 'test_lazy_import_hints.py' -v
          python -m unittest discover -s test -p 'test_agents_import_hints.py' -v
          python -m unittest discover -s test -p 'test_tool_registry_lazy_import.py' -v
          python -m unittest discover -s test -p 'test_layer_boundary_imports.py' -v
          python -m unittest discover -s test -p 'test_bootstrap_provider_entrypoints.py' -v
      - name: Verify sdist boundary
        run: |
          bash scripts/verify_core_sdist.sh
      - name: Assert minimal deps
        run: |
          python - <<'PY'
          import importlib.util
          forbidden = ["langchain", "langchain_core", "langgraph", "pandas", "numpy"]
          missing = [m for m in forbidden if importlib.util.find_spec(m) is not None]
          if missing:
              raise SystemExit(f"Core-only install should not pull optional deps, but found: {missing}")
          print("OK: minimal deps (no optional stack installed)")
          PY
