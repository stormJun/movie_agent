# 安装指南

> **目标读者**：项目新手、首次使用者
> **阅读时间**：15 分钟
> **前置知识**：基本的 Linux/macOS 命令、Docker 基础
> **难度等级**：⭐

## 📋 本文大纲

- [1. 系统要求](#1-系统要求)
- [2. 安装 Docker 环境](#2-安装-docker-环境)
- [3. 部署 Neo4j 数据库](#3-部署-neo4j-数据库)
- [4. 部署 API 代理（可选）](#4-部署-api-代理可选)
- [5. 创建 Python 环境](#5-创建-python-环境)
- [6. 配置环境变量](#6-配置环境变量)
- [7. 模型兼容性说明](#7-模型兼容性说明)
- [8. 验证安装](#8-验证安装)

---

## 1. 系统要求

### 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 4核 | 8核+ |
| 内存 | 8GB | 16GB+ |
| 磁盘 | 20GB | 50GB+ SSD |

### 软件要求

- **操作系统**: Linux / macOS / Windows (WSL2)
- **Docker**: 20.10+ 和 Docker Compose
- **Conda** 或 **Python**: 3.10
- **Git**: 用于克隆代码仓库

---

## 2. 安装 Docker 环境

### 2.1 安装 Docker

**Linux (Ubuntu/Debian)**:
```bash
# 更新软件包
sudo apt-get update

# 安装 Docker
curl -fsSL https://get.docker.com | bash -s docker

# 添加当前用户到 docker 组
sudo usermod -aG docker $USER

# 重新登录以使组权限生效
newgrp docker
```

**macOS**:
下载并安装 [Docker Desktop for Mac](https://www.docker.com/products/docker-desktop)

**Windows**:
1. 启用 WSL2
2. 下载并安装 [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop)

### 2.2 验证 Docker 安装

```bash
docker --version
docker-compose --version
```

预期输出：
```
Docker version 20.10.x
docker-compose version 1.29.x
```

---

## 3. 部署 Neo4j 数据库

### 3.1 克隆项目代码

```bash
git clone https://github.com/1517005260/graph-rag-agent.git
cd graph-rag-agent
```

### 3.2 启动 Neo4j

项目已包含 `docker/docker-compose.yaml` 配置文件：

```bash
docker compose -f docker/docker-compose.yaml up -d
```

### 3.3 验证 Neo4j 运行

浏览器访问：http://localhost:7474

**默认账号密码**：
```
用户名：neo4j
密码：12345678
```

成功登录后会看到 Neo4j Browser 界面。

---

## 4. 部署 API 代理（可选）

如果您没有 OpenAI API 直连，可以使用以下方案之一作为代理。

### 方案 1：One-API（推荐）

One-API 是一个 OpenAI 接口管理 & 分发系统。

**启动 One-API**:
```bash
docker run --name one-api -d --restart always \
  -p 13000:3000 \
  -e TZ=Asia/Shanghai \
  -v /home/ubuntu/data/one-api:/data \
  justsong/one-api
```

**访问控制台**: http://localhost:13000

**默认管理员账号**：
```
用户名：root
密码：123456
```

**配置说明**:
1. 登录后修改默认密码
2. 添加渠道（如 DeepSeek、OpenAI、Azure 等）
3. 创建令牌（Token）用于项目调用

详细配置参考：[One-API 配置教程](https://github.com/1517005260/graph-rag-agent/issues/7#issuecomment-2906770240)

**项目地址**: https://github.com/songquanpeng/one-api

### 方案 2：New-API（更先进）

New-API 是 One-API 的增强版：

```bash
docker run --name new-api -d --restart always \
  -p 3000:3000 \
  -e TZ=Asia/Shanghai \
  -v /home/ubuntu/data/new-api:/data \
  calciumion/new-api:latest
```

**项目地址**: https://github.com/QuantumNous/new-api

### 方案 3：第三方代理平台

直接使用第三方代理平台（如 [云雾 API](https://yunwu.ai/)），无需自己部署。

---

## 5. 创建 Python 环境

### 5.1 使用 Conda（推荐）

```bash
# 创建虚拟环境
conda create -n graphrag python==3.10

# 激活环境
conda activate graphrag

# 进入项目目录
cd graph-rag-agent

# 安装依赖
pip install -r requirements.txt

# 以可编辑模式安装项目
pip install -e .
```

### 5.2 特殊依赖说明

#### 处理 .doc 格式文件（旧版 Word）

**Linux**:
```bash
sudo apt-get install python-dev-is-python3 libxml2-dev libxslt1-dev antiword unrtf poppler-utils
pip install textract==1.6.3
```

**Windows**:
```bash
pip install pywin32>=302
# Windows 上无需安装 textract
```

#### Torch 版本问题

如果遇到错误：
```
OSError: [WinError 1114] 动态链接库(DLL)初始化例程失败
```

手动降级 Torch：
```bash
pip install torch==2.8.0
```

---

## 6. 配置环境变量

### 6.1 复制配置模板

```bash
cp .env.example .env
```

### 6.2 必选配置项

编辑 `.env` 文件，填写以下**必须配置**的项：

```env
# ===== LLM 模型配置 =====
OPENAI_API_KEY = 'sk-xxx'  # 您的 API Key
OPENAI_BASE_URL = 'http://localhost:13000/v1'  # One-API 地址
OPENAI_EMBEDDINGS_MODEL = 'text-embedding-3-large'  # 向量模型
OPENAI_LLM_MODEL = 'gpt-4o'  # 生成模型

# ===== Neo4j 数据库配置 =====
NEO4J_URI = 'neo4j://localhost:7687'
NEO4J_USERNAME = 'neo4j'
NEO4J_PASSWORD = '12345678'
```

### 6.3 推荐修改配置项

根据实际情况调整：

```env
# ===== 运行时目录（生成产物 / 第三方依赖缓存）=====
RUNTIME_ROOT = './files'

# ===== 并发与性能配置 =====
# 根据机器 CPU 核心数调整
MAX_WORKERS = 4  # 推荐设置为 CPU 核心数
BATCH_SIZE = 100

# ===== GDS 内存配置 =====
# 根据服务器内存调整，单位 GB
GDS_MEMORY_LIMIT = 6  # 推荐设置为可用内存的 50%

# ===== 文本处理参数 =====
CHUNK_SIZE = 500  # 文本分块大小
CHUNK_OVERLAP = 100  # 分块重叠大小
# hanlp（中文分词，推荐）或 simple（快速但粗糙）
TEXT_CHUNKER_PROVIDER = 'hanlp'

# ===== 构建模式（以当前实现为准）=====
# document: 文档模式（如“学生管理”知识库）
# structured: 结构化模式（如“电影推荐”知识库）
GRAPH_BUILD_MODE = 'document'

# ===== 可选：阶段开关（统一入口）=====
# BUILD_RUN_GRAPH: 是否执行 Phase 2（图谱构建；document 会包含分块与实体抽取）
# BUILD_RUN_INDEX_AND_COMMUNITY: 是否执行 Phase 3（实体索引与社区检测）
# BUILD_RUN_CHUNK_INDEX: 是否执行 Chunk 向量索引
# BUILD_DROP_ALL_INDEXES: 是否清理全库索引（同库多知识库共存时建议 false）
# BUILD_RUN_GRAPH = true
# BUILD_RUN_INDEX_AND_COMMUNITY = true
# BUILD_RUN_CHUNK_INDEX = true
# BUILD_DROP_ALL_INDEXES = false
```

### 6.4 可选配置项

LangSmith 监控（不需要可注释掉）：

```env
# ===== LangSmith 监控（可选）=====
# LANGSMITH_TRACING = true
# LANGSMITH_ENDPOINT = "https://api.smith.langchain.com"
# LANGSMITH_API_KEY = "xxx"
# LANGSMITH_PROJECT = "xxx"
```

**完整配置说明**：详见 `.env.example` 文件中的注释。

---

## 7. 模型兼容性说明

### 7.1 测试通过的模型

| 模型 | 版本 | 状态 | 备注 |
|------|------|------|------|
| **DeepSeek** | 20241226 | ✅ 推荐 | 全流程测试通过 |
| **GPT-4o** | - | ✅ 推荐 | 全流程测试通过 |

### 7.2 已知问题模型

| 模型 | 问题 | 建议 |
|------|------|------|
| **DeepSeek** (20250324) | 严重幻觉，实体抽取失败 | ⚠️ 不推荐使用 |
| **Qwen 系列** | LangChain/LangGraph 兼容性问题 | 使用 [Qwen-Agent](https://qwen.readthedocs.io/zh-cn/latest/framework/qwen_agent.html) 框架 |

### 7.3 模型选择建议

**成本优先**：DeepSeek (20241226)
**效果优先**：GPT-4o
**平衡选择**：DeepSeek (20241226)

---

## 8. 验证安装

### 8.1 检查 Docker 容器

```bash
docker ps
```

预期输出：
```
CONTAINER ID   IMAGE            STATUS
xxx            neo4j:latest     Up X minutes
xxx            one-api:latest   Up X minutes  (如果部署了 One-API)
```

### 8.2 检查 Python 环境

```bash
# 激活环境
conda activate graphrag

# 检查 Python 版本
python --version  # 应输出 Python 3.10.x

# 检查关键包
python -c "import langchain; import neo4j; print('OK')"
```

预期输出：`OK`

### 8.3 检查 Neo4j 连接

```bash
python -c "from infrastructure.providers.neo4jdb import get_db_manager; get_db_manager().close(); print('Neo4j 连接成功')"
```

预期输出：`Neo4j 连接成功`

### 8.4 测试 API 调用

```bash
# 测试 embedding
python -c "from infrastructure.providers.models import get_embeddings_model; model = get_embeddings_model(); print(model.embed_query('测试')[:5])"
```

预期输出：一个向量的前5个值，例如 `[0.123, -0.456, ...]`

---

## ✅ 安装完成！

恭喜！您已成功完成环境搭建。

**下一步**：
- [第一次构建知识图谱](./第一次构建知识图谱.md) - 导入数据并构建图谱
- [第一次对话](./第一次对话.md) - 启动服务并体验问答

---

## 🔗 相关文档

- [部署指南](../03-部署指南/README.md) - 生产环境部署
- [配置说明](../04-开发指南/代码结构说明.md) - 详细配置参数说明
- [常见问题](../99-参考资料/常见问题.md) - 安装问题排查

---

## 📝 更新日志

- 2026-01-04: 初始版本

**返回**: [快速开始首页](./README.md) | [文档首页](../README.md)
