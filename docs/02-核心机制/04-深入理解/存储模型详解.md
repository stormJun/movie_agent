# å­˜å‚¨æ¨¡å‹è¯¦è§£

---

## ğŸ“‹ å…ƒä¿¡æ¯

- **ç›®æ ‡è¯»è€…**ï¼šäºŒæ¬¡å¼€å‘è€…ã€è´¡çŒ®è€…ã€æ•°æ®åº“ç®¡ç†å‘˜
- **é˜…è¯»æ—¶é—´**ï¼š90åˆ†é’Ÿ
- **éš¾åº¦**ï¼šâ­â­â­â­
- **å‰ç½®çŸ¥è¯†**ï¼šNeo4j å›¾æ•°æ®åº“ã€Cypher æŸ¥è¯¢è¯­è¨€ã€å‘é‡æ•°æ®åº“ã€åµŒå…¥æŠ€æœ¯
- **æœ€åæ›´æ–°**ï¼š2026-01-04

---

## ğŸ“– æœ¬æ–‡å¤§çº²

- [ä»€ä¹ˆæ˜¯å­˜å‚¨æ¨¡å‹](#ä»€ä¹ˆæ˜¯å­˜å‚¨æ¨¡å‹)
- [Neo4j å›¾æ•°æ®åº“æ¶æ„](#neo4j-å›¾æ•°æ®åº“æ¶æ„)
- [èŠ‚ç‚¹ç±»å‹ä¸å±æ€§](#èŠ‚ç‚¹ç±»å‹ä¸å±æ€§)
- [å…³ç³»ç±»å‹ä¸å±æ€§](#å…³ç³»ç±»å‹ä¸å±æ€§)
- [å‘é‡ç´¢å¼•è®¾è®¡](#å‘é‡ç´¢å¼•è®¾è®¡)
- [æ•°æ®æ¨¡å‹è¯¦è§£](#æ•°æ®æ¨¡å‹è¯¦è§£)
- [å­˜å‚¨ä¼˜åŒ–ç­–ç•¥](#å­˜å‚¨ä¼˜åŒ–ç­–ç•¥)
- [æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
- [æ•°æ®ä¸€è‡´æ€§ä¿è¯](#æ•°æ®ä¸€è‡´æ€§ä¿è¯)
- [å¤‡ä»½ä¸æ¢å¤](#å¤‡ä»½ä¸æ¢å¤)
- [ç›‘æ§ä¸è¯Šæ–­](#ç›‘æ§ä¸è¯Šæ–­)
- [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ä»€ä¹ˆæ˜¯å­˜å‚¨æ¨¡å‹

### å®šä¹‰å’Œä½œç”¨

å­˜å‚¨æ¨¡å‹æ˜¯ GraphRAG-Agent ç³»ç»Ÿçš„æ•°æ®æŒä¹…åŒ–å±‚è®¾è®¡ï¼Œå®šä¹‰äº†å¦‚ä½•åœ¨ Neo4j å›¾æ•°æ®åº“ä¸­ç»„ç»‡å’Œå­˜å‚¨çŸ¥è¯†å›¾è°±æ•°æ®ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
1. **é«˜æ•ˆå­˜å‚¨**ï¼šåˆç†è®¾è®¡èŠ‚ç‚¹å’Œå…³ç³»ç»“æ„ï¼Œæœ€å°åŒ–å­˜å‚¨ç©ºé—´
2. **å¿«é€Ÿæ£€ç´¢**ï¼šé€šè¿‡ç´¢å¼•ä¼˜åŒ–ï¼Œæ”¯æŒæ¯«ç§’çº§æŸ¥è¯¢å“åº”
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯å›¾æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§çº¦æŸ
4. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒç™¾ä¸‡çº§èŠ‚ç‚¹å’Œå…³ç³»çš„é«˜æ•ˆç®¡ç†

### å­˜å‚¨å±‚æ¶æ„

```mermaid
graph TB
    subgraph åº”ç”¨å±‚[åº”ç”¨å±‚]
        Agent[Agentç³»ç»Ÿ]
        Search[æœç´¢å¼•æ“]
        Build[æ„å»ºæµç¨‹]
    end

    subgraph æŠ½è±¡å±‚[æŠ½è±¡å±‚]
        GraphWriter[GraphWriter<br/>å›¾å†™å…¥æ¥å£]
        GraphReader[GraphReader<br/>å›¾è¯»å–æ¥å£]
        IndexManager[IndexManager<br/>ç´¢å¼•ç®¡ç†]
    end

    subgraph Neo4jå±‚[Neo4j å›¾æ•°æ®åº“å±‚]
        Nodes[(èŠ‚ç‚¹å­˜å‚¨<br/>Document/Chunk/Entity<br/>Community)]
        Rels[(å…³ç³»å­˜å‚¨<br/>CONTAINS/RELATES_TO<br/>IN_COMMUNITY)]
        VectorIdx[(å‘é‡ç´¢å¼•<br/>Entity Index<br/>Chunk Index)]
        Properties[(å±æ€§å­˜å‚¨<br/>id/name/description<br/>embedding)]
    end

    subgraph ç‰©ç†å±‚[ç‰©ç†å­˜å‚¨å±‚]
        Disk[ç£ç›˜å­˜å‚¨<br/>graph.db]
        Cache[å†…å­˜ç¼“å­˜<br/>Page Cache]
    end

    Agent --> GraphWriter
    Search --> GraphReader
    Build --> GraphWriter

    GraphWriter --> Nodes
    GraphWriter --> Rels
    GraphReader --> VectorIdx
    IndexManager --> VectorIdx

    Nodes --> Disk
    Rels --> Disk
    VectorIdx --> Disk
    Properties --> Cache

    style åº”ç”¨å±‚ fill:#e3f2fd
    style æŠ½è±¡å±‚ fill:#fff3e0
    style Neo4jå±‚ fill:#e8f5e9
    style ç‰©ç†å±‚ fill:#fce4ec
```

### è®¾è®¡åŸåˆ™

1. **å›¾ä¼˜å…ˆè®¾è®¡**
   - åˆ©ç”¨å›¾çš„å¤©ç„¶å…³è”æ€§ï¼Œé¿å… JOIN æ“ä½œ
   - å…³ç³»å³ç´¢å¼•ï¼Œéå†æ€§èƒ½ O(1)
   - æ”¯æŒå¤šè·³æŸ¥è¯¢å’Œè·¯å¾„åˆ†æ

2. **å‘é‡æ··åˆå­˜å‚¨**
   - å‘é‡åµŒå…¥ä½œä¸ºèŠ‚ç‚¹å±æ€§å­˜å‚¨
   - ä¸“ç”¨å‘é‡ç´¢å¼•æ”¯æŒç›¸ä¼¼åº¦æœç´¢
   - ç»“åˆå›¾ç»“æ„å’Œå‘é‡æ£€ç´¢ä¼˜åŠ¿

3. **Schema-Free çµæ´»æ€§**
   - Neo4j æ”¯æŒåŠ¨æ€å±æ€§æ·»åŠ 
   - ä¸åŒç±»å‹èŠ‚ç‚¹å¯æœ‰ä¸åŒå±æ€§é›†
   - ä¾¿äºè¿­ä»£å¼€å‘å’ŒåŠŸèƒ½æ‰©å±•

4. **ç´¢å¼•é©±åŠ¨æŸ¥è¯¢**
   - æ‰€æœ‰æŸ¥è¯¢è·¯å¾„éƒ½æœ‰ç´¢å¼•æ”¯æŒ
   - å‘é‡ç´¢å¼• + å…¨æ–‡ç´¢å¼• + å±æ€§ç´¢å¼•
   - æŸ¥è¯¢æ€§èƒ½ä¸æ•°æ®è§„æ¨¡è§£è€¦

---

## Neo4j å›¾æ•°æ®åº“æ¶æ„

### æ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph Client[å®¢æˆ·ç«¯å±‚]
        App[Pythonåº”ç”¨<br/>neo4j-driver]
        GDS_Client[GDSå®¢æˆ·ç«¯<br/>graphdatascience]
    end

    subgraph API[APIå±‚]
        Bolt[Boltåè®®<br/>ç«¯å£7687]
        HTTP[HTTP API<br/>ç«¯å£7474]
    end

    subgraph Core[æ ¸å¿ƒå¼•æ“]
        QueryEngine[CypheræŸ¥è¯¢å¼•æ“]
        TxManager[äº‹åŠ¡ç®¡ç†å™¨]
        StorageEngine[å­˜å‚¨å¼•æ“]
    end

    subgraph GDS[Graph Data Science]
        Projection[å›¾æŠ•å½±]
        Algorithms[å›¾ç®—æ³•<br/>Leiden/PageRank]
        ML[æœºå™¨å­¦ä¹ ]
    end

    subgraph Storage[å­˜å‚¨å±‚]
        NodeStore[èŠ‚ç‚¹å­˜å‚¨<br/>neostore.nodestore.db]
        RelStore[å…³ç³»å­˜å‚¨<br/>neostore.relationshipstore.db]
        PropStore[å±æ€§å­˜å‚¨<br/>neostore.propertystore.db]
        Index[ç´¢å¼•å­˜å‚¨<br/>schema/index/]
    end

    subgraph Memory[å†…å­˜ç®¡ç†]
        PageCache[é¡µç¼“å­˜<br/>dbms.memory.pagecache.size]
        HeapMem[å †å†…å­˜<br/>dbms.memory.heap]
    end

    App --> Bolt
    GDS_Client --> Bolt
    Bolt --> QueryEngine
    HTTP --> QueryEngine

    QueryEngine --> TxManager
    TxManager --> StorageEngine

    QueryEngine --> GDS
    GDS --> Projection
    Projection --> Algorithms

    StorageEngine --> NodeStore
    StorageEngine --> RelStore
    StorageEngine --> PropStore
    StorageEngine --> Index

    NodeStore --> PageCache
    RelStore --> PageCache
    PropStore --> PageCache
    Index --> HeapMem

    style Client fill:#e3f2fd
    style Core fill:#fff3e0
    style GDS fill:#e8f5e9
    style Storage fill:#fce4ec
    style Memory fill:#f3e5f5
```

### å­˜å‚¨æ–‡ä»¶ç»“æ„

```bash
neo4j/data/databases/neo4j/
â”œâ”€â”€ neostore                              # æ•°æ®åº“å…ƒä¿¡æ¯
â”œâ”€â”€ neostore.nodestore.db                 # èŠ‚ç‚¹å­˜å‚¨ï¼ˆå®šé•¿ï¼‰
â”œâ”€â”€ neostore.nodestore.db.labels          # èŠ‚ç‚¹æ ‡ç­¾ç´¢å¼•
â”œâ”€â”€ neostore.relationshipstore.db         # å…³ç³»å­˜å‚¨ï¼ˆå®šé•¿ï¼‰
â”œâ”€â”€ neostore.relationshiptypestore.db     # å…³ç³»ç±»å‹ç´¢å¼•
â”œâ”€â”€ neostore.propertystore.db             # å±æ€§å­˜å‚¨ï¼ˆå˜é•¿ï¼‰
â”œâ”€â”€ neostore.propertystore.db.strings     # å­—ç¬¦ä¸²å±æ€§
â”œâ”€â”€ neostore.propertystore.db.arrays      # æ•°ç»„å±æ€§ï¼ˆå‘é‡ï¼‰
â”œâ”€â”€ schema/
â”‚   â”œâ”€â”€ index/                            # å±æ€§ç´¢å¼•
â”‚   â”‚   â”œâ”€â”€ lucene/                       # å…¨æ–‡ç´¢å¼•
â”‚   â”‚   â””â”€â”€ vector/                       # å‘é‡ç´¢å¼•
â”‚   â””â”€â”€ label/                            # æ ‡ç­¾ç´¢å¼•
â””â”€â”€ transactions/                         # äº‹åŠ¡æ—¥å¿—
    â”œâ”€â”€ neostore.transaction.db.0
    â””â”€â”€ neostore.transaction.db.1
```

### å†…å­˜ç®¡ç†

```mermaid
graph TB
    subgraph TotalMemory[æ€»å†…å­˜é…ç½®]
        Total[ç³»ç»Ÿæ€»å†…å­˜<br/>ä¾‹: 16GB]
    end

    subgraph Neo4jMemory[Neo4j å†…å­˜åˆ†é…]
        PageCache[Page Cache<br/>6-8GB<br/>ç¼“å­˜èŠ‚ç‚¹/å…³ç³»/å±æ€§]
        Heap[Heap Memory<br/>2-4GB<br/>æŸ¥è¯¢æ‰§è¡Œ/äº‹åŠ¡]
        OS[æ“ä½œç³»ç»Ÿé¢„ç•™<br/>4-6GB<br/>ç³»ç»Ÿè¿›ç¨‹]
    end

    subgraph PageCacheUsage[Page Cache ç”¨é€”]
        NodeCache[èŠ‚ç‚¹ç¼“å­˜]
        RelCache[å…³ç³»ç¼“å­˜]
        PropCache[å±æ€§ç¼“å­˜]
    end

    subgraph HeapUsage[Heap ç”¨é€”]
        QueryExec[æŸ¥è¯¢æ‰§è¡Œ]
        TxBuffer[äº‹åŠ¡ç¼“å†²]
        Lucene[Luceneç´¢å¼•]
    end

    Total --> PageCache
    Total --> Heap
    Total --> OS

    PageCache --> NodeCache
    PageCache --> RelCache
    PageCache --> PropCache

    Heap --> QueryExec
    Heap --> TxBuffer
    Heap --> Lucene

    style TotalMemory fill:#e3f2fd
    style PageCache fill:#fff3e0
    style Heap fill:#e8f5e9
    style OS fill:#f3e5f5
```

**å†…å­˜é…ç½®å»ºè®®**ï¼š

```properties
# neo4j.conf

# Page Cache: èŠ‚ç‚¹/å…³ç³»/å±æ€§çš„ç¼“å­˜ï¼ˆå»ºè®®: æ€»å†…å­˜çš„ 40-50%ï¼‰
dbms.memory.pagecache.size=6g

# Heap Memory: æŸ¥è¯¢æ‰§è¡Œå’Œäº‹åŠ¡ç®¡ç†ï¼ˆå»ºè®®: æ€»å†…å­˜çš„ 20-30%ï¼‰
dbms.memory.heap.initial_size=2g
dbms.memory.heap.max_size=4g

# Transaction Log: äº‹åŠ¡æ—¥å¿—ä¿ç•™
dbms.tx_log.rotation.retention_policy=2 days
dbms.tx_log.rotation.size=100M
```

---

## èŠ‚ç‚¹ç±»å‹ä¸å±æ€§

### èŠ‚ç‚¹ç±»å‹æ€»è§ˆ

ç³»ç»Ÿå®šä¹‰äº† 4 ç§æ ¸å¿ƒèŠ‚ç‚¹ç±»å‹ï¼š

```mermaid
graph TB
    subgraph æ–‡æ¡£å±‚[æ–‡æ¡£å±‚]
        Doc[__Document__<br/>æ–‡æ¡£èŠ‚ç‚¹]
    end

    subgraph æ–‡æœ¬å±‚[æ–‡æœ¬å±‚]
        Chunk[__Chunk__<br/>æ–‡æœ¬å—èŠ‚ç‚¹]
    end

    subgraph çŸ¥è¯†å±‚[çŸ¥è¯†å±‚]
        Entity[__Entity__<br/>å®ä½“èŠ‚ç‚¹]
    end

    subgraph ç¤¾åŒºå±‚[ç¤¾åŒºå±‚]
        Community[__Community__<br/>ç¤¾åŒºèŠ‚ç‚¹]
    end

    Doc -->|CONTAINS| Chunk
    Chunk -->|MENTIONS| Entity
    Entity -->|IN_COMMUNITY| Community

    style æ–‡æ¡£å±‚ fill:#e3f2fd
    style æ–‡æœ¬å±‚ fill:#fff3e0
    style çŸ¥è¯†å±‚ fill:#e8f5e9
    style ç¤¾åŒºå±‚ fill:#fce4ec
```

### 1. Document èŠ‚ç‚¹ï¼ˆæ–‡æ¡£ï¼‰

**ç”¨é€”**ï¼šè¡¨ç¤ºåŸå§‹æ–‡æ¡£ï¼Œä½œä¸ºæ•°æ®æº¯æºçš„æ ¹èŠ‚ç‚¹

**æ ‡ç­¾**ï¼š`__Document__`

**å±æ€§ç»“æ„**ï¼š

| å±æ€§å | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| `id` | String | âœ… | æ–‡æ¡£å”¯ä¸€æ ‡è¯† | `"doc_001"` |
| `file_name` | String | âœ… | æ–‡ä»¶å | `"student_handbook.pdf"` |
| `file_path` | String | âœ… | æ–‡ä»¶è·¯å¾„ | `"files/student_handbook.pdf"` |
| `file_type` | String | âœ… | æ–‡ä»¶ç±»å‹ | `"pdf"` / `"txt"` / `"md"` |
| `content_hash` | String | âœ… | å†…å®¹å“ˆå¸Œï¼ˆSHA256ï¼‰ | `"a3f5e9..."` |
| `file_size` | Integer | âœ… | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ | `1048576` |
| `chunk_count` | Integer | âœ… | åŒ…å«çš„æ–‡æœ¬å—æ•°é‡ | `42` |
| `created_at` | DateTime | âœ… | åˆ›å»ºæ—¶é—´ | `2026-01-04T10:00:00Z` |
| `updated_at` | DateTime | âŒ | æ›´æ–°æ—¶é—´ | `2026-01-04T15:30:00Z` |

**Cypher åˆ›å»ºç¤ºä¾‹**ï¼š

```cypher
CREATE (d:__Document__ {
    id: "doc_001",
    file_name: "student_handbook.pdf",
    file_path: "files/student_handbook.pdf",
    file_type: "pdf",
    content_hash: "a3f5e9d2c4b8a1f6e3d9c7b5a2f4e8d1c6b9a3f7e2d5c8b4a1f9e6d3c7b2a5",
    file_size: 1048576,
    chunk_count: 42,
    created_at: datetime()
})
```

**ç´¢å¼•**ï¼š

```cypher
-- æ–‡æ¡£IDå”¯ä¸€ç´¢å¼•ï¼ˆä¸»é”®ï¼‰
CREATE CONSTRAINT document_id_unique IF NOT EXISTS
FOR (d:__Document__) REQUIRE d.id IS UNIQUE;

-- æ–‡ä»¶è·¯å¾„ç´¢å¼•ï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰
CREATE INDEX document_file_path IF NOT EXISTS
FOR (d:__Document__) ON (d.file_path);

-- å†…å®¹å“ˆå¸Œç´¢å¼•ï¼ˆç”¨äºé‡å¤æ£€æµ‹ï¼‰
CREATE INDEX document_hash IF NOT EXISTS
FOR (d:__Document__) ON (d.content_hash);
```

### 2. Chunk èŠ‚ç‚¹ï¼ˆæ–‡æœ¬å—ï¼‰

**ç”¨é€”**ï¼šæ–‡æ¡£çš„åˆ†å—å•å…ƒï¼Œæ‰¿è½½åŸå§‹æ–‡æœ¬å’Œå‘é‡åµŒå…¥

**æ ‡ç­¾**ï¼š`__Chunk__`

**å±æ€§ç»“æ„**ï¼š

| å±æ€§å | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| `id` | String | âœ… | å—å”¯ä¸€æ ‡è¯† | `"chunk_001_0"` |
| `text` | String | âœ… | æ–‡æœ¬å†…å®¹ | `"å­¦ç”Ÿåº”éµå®ˆæ ¡è§„..."` |
| `chunk_index` | Integer | âœ… | åœ¨æ–‡æ¡£ä¸­çš„åºå· | `0` |
| `token_count` | Integer | âœ… | Token æ•°é‡ | `512` |
| `embedding` | List[Float] | âœ… | å‘é‡åµŒå…¥ï¼ˆ1536ç»´ï¼‰ | `[0.123, -0.456, ...]` |
| `created_at` | DateTime | âœ… | åˆ›å»ºæ—¶é—´ | `2026-01-04T10:00:00Z` |

**Cypher åˆ›å»ºç¤ºä¾‹**ï¼š

```cypher
CREATE (c:__Chunk__ {
    id: "chunk_001_0",
    text: "å­¦ç”Ÿåº”éµå®ˆæ ¡è§„æ ¡çºª...",
    chunk_index: 0,
    token_count: 512,
    embedding: [0.123, -0.456, ...],  // 1536 ç»´å‘é‡
    created_at: datetime()
})
```

**ç´¢å¼•**ï¼š

```cypher
-- Chunk ID å”¯ä¸€ç´¢å¼•
CREATE CONSTRAINT chunk_id_unique IF NOT EXISTS
FOR (c:__Chunk__) REQUIRE c.id IS UNIQUE;

-- å‘é‡ç´¢å¼•ï¼ˆç”¨äºç›¸ä¼¼åº¦æœç´¢ï¼‰
CALL db.index.vector.createNodeIndex(
    'chunk_index',                    // ç´¢å¼•åç§°
    '__Chunk__',                      // èŠ‚ç‚¹æ ‡ç­¾
    'embedding',                      // åµŒå…¥å±æ€§
    1536,                             // å‘é‡ç»´åº¦
    'cosine'                          // ç›¸ä¼¼åº¦åº¦é‡
);
```

### 3. Entity èŠ‚ç‚¹ï¼ˆå®ä½“ï¼‰

**ç”¨é€”**ï¼šçŸ¥è¯†å›¾è°±çš„æ ¸å¿ƒèŠ‚ç‚¹ï¼Œè¡¨ç¤ºé¢†åŸŸå†…çš„æ¦‚å¿µã€å¯¹è±¡ã€äº‹ä»¶ç­‰

**æ ‡ç­¾**ï¼š
- ä¸»æ ‡ç­¾ï¼š`__Entity__`
- åŠ¨æ€æ ‡ç­¾ï¼šæ ¹æ®å®ä½“ç±»å‹è‡ªåŠ¨æ·»åŠ ï¼ˆå¦‚ `å­¦ç”Ÿ`, `å¥–å­¦é‡‘`, `å¤„åˆ†`ï¼‰

**å±æ€§ç»“æ„**ï¼š

| å±æ€§å | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| `id` | String | âœ… | å®ä½“å”¯ä¸€æ ‡è¯†ï¼ˆè§„èŒƒåç§°ï¼‰ | `"å›½å®¶å¥–å­¦é‡‘"` |
| `name` | String | âœ… | å®ä½“åç§°ï¼ˆæ˜¾ç¤ºç”¨ï¼‰ | `"å›½å®¶å¥–å­¦é‡‘"` |
| `type` | String | âœ… | å®ä½“ç±»å‹ | `"å¥–å­¦é‡‘ç±»å‹"` |
| `description` | String | âœ… | å®ä½“æè¿° | `"é¢å‘å­¦ä¸šæˆç»©ä¼˜å¼‚çš„å­¦ç”Ÿ..."` |
| `embedding` | List[Float] | âœ… | å‘é‡åµŒå…¥ï¼ˆ1536ç»´ï¼‰ | `[0.789, -0.234, ...]` |
| `canonical_id` | String | âŒ | è§„èŒƒå®ä½“IDï¼ˆæ¶ˆæ­§åï¼‰ | `"å›½å®¶å¥–å­¦é‡‘"` |
| `mention_count` | Integer | âŒ | æåŠæ¬¡æ•° | `15` |
| `degree` | Integer | âŒ | å…³ç³»åº¦æ•°ï¼ˆç¼“å­˜ï¼‰ | `8` |
| `created_at` | DateTime | âœ… | åˆ›å»ºæ—¶é—´ | `2026-01-04T10:00:00Z` |

**å®ä½“æ¶ˆæ­§ç›¸å…³å±æ€§**ï¼š

| å±æ€§å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `canonical_id` | String | æŒ‡å‘è§„èŒƒå®ä½“çš„IDï¼ˆå¦‚æœæ˜¯å˜ä½“ï¼‰ |
| `is_canonical` | Boolean | æ˜¯å¦ä¸ºè§„èŒƒå®ä½“ |
| `variants` | List[String] | å·²çŸ¥å˜ä½“åˆ—è¡¨ï¼ˆä»…è§„èŒƒå®ä½“æœ‰ï¼‰ |

**Cypher åˆ›å»ºç¤ºä¾‹**ï¼š

```cypher
// åˆ›å»ºè§„èŒƒå®ä½“
CREATE (e:__Entity__:å¥–å­¦é‡‘ç±»å‹ {
    id: "å›½å®¶å¥–å­¦é‡‘",
    name: "å›½å®¶å¥–å­¦é‡‘",
    type: "å¥–å­¦é‡‘ç±»å‹",
    description: "é¢å‘å­¦ä¸šæˆç»©ä¼˜å¼‚çš„å­¦ç”Ÿï¼Œæ¯å¹´è¯„é€‰ä¸€æ¬¡ï¼Œå¥–é‡‘8000å…ƒ",
    embedding: [0.789, -0.234, ...],
    is_canonical: true,
    variants: ["å›½å¥–", "National Scholarship"],
    mention_count: 15,
    degree: 8,
    created_at: datetime()
})

// åˆ›å»ºå˜ä½“å®ä½“ï¼ˆæŒ‡å‘è§„èŒƒå®ä½“ï¼‰
CREATE (e2:__Entity__:å¥–å­¦é‡‘ç±»å‹ {
    id: "å›½å¥–",
    name: "å›½å¥–",
    type: "å¥–å­¦é‡‘ç±»å‹",
    description: "å›½å®¶å¥–å­¦é‡‘çš„ç®€ç§°",
    canonical_id: "å›½å®¶å¥–å­¦é‡‘",
    is_canonical: false,
    created_at: datetime()
})
```

**ç´¢å¼•**ï¼š

```cypher
-- å®ä½“IDå”¯ä¸€ç´¢å¼•
CREATE CONSTRAINT entity_id_unique IF NOT EXISTS
FOR (e:__Entity__) REQUIRE e.id IS UNIQUE;

-- å®ä½“ç±»å‹ç´¢å¼•
CREATE INDEX entity_type IF NOT EXISTS
FOR (e:__Entity__) ON (e.type);

-- è§„èŒƒIDç´¢å¼•ï¼ˆç”¨äºæ¶ˆæ­§æŸ¥è¯¢ï¼‰
CREATE INDEX entity_canonical IF NOT EXISTS
FOR (e:__Entity__) ON (e.canonical_id);

-- å‘é‡ç´¢å¼•
CALL db.index.vector.createNodeIndex(
    'entity_index',
    '__Entity__',
    'embedding',
    1536,
    'cosine'
);

-- å…¨æ–‡ç´¢å¼•ï¼ˆç”¨äºæ–‡æœ¬æœç´¢ï¼‰
CALL db.index.fulltext.createNodeIndex(
    'entity_fulltext',
    ['__Entity__'],
    ['name', 'description']
);
```

### 4. Community èŠ‚ç‚¹ï¼ˆç¤¾åŒºï¼‰

**ç”¨é€”**ï¼šè¡¨ç¤ºå›¾ä¸­çš„ç¤¾åŒºèšç±»ï¼Œæ”¯æŒå…¨å±€æœç´¢

**æ ‡ç­¾**ï¼š`__Community__`

**å±æ€§ç»“æ„**ï¼š

| å±æ€§å | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| `id` | String | âœ… | ç¤¾åŒºå”¯ä¸€æ ‡è¯† | `"0-123"` / `"1-45"` |
| `level` | Integer | âœ… | ç¤¾åŒºå±‚çº§ï¼ˆ0/1/2/3ï¼‰ | `0` |
| `community_rank` | Float | âœ… | ç¤¾åŒºé‡è¦æ€§åˆ†æ•° | `0.85` |
| `summary` | String | âœ… | LLMç”Ÿæˆçš„ç¤¾åŒºæ‘˜è¦ | `"æœ¬ç¤¾åŒºèšç„¦äºå¥–å­¦é‡‘ä½“ç³»..."` |
| `full_content` | String | âŒ | å®Œæ•´ç¤¾åŒºä¿¡æ¯ | `"å®ä½“: [...], å…³ç³»: [...]"` |
| `entity_count` | Integer | âœ… | åŒ…å«çš„å®ä½“æ•°é‡ | `15` |
| `summary_created_at` | DateTime | âŒ | æ‘˜è¦ç”Ÿæˆæ—¶é—´ | `2026-01-04T12:00:00Z` |
| `created_at` | DateTime | âœ… | åˆ›å»ºæ—¶é—´ | `2026-01-04T10:00:00Z` |

**Cypher åˆ›å»ºç¤ºä¾‹**ï¼š

```cypher
CREATE (c:__Community__ {
    id: "0-123",
    level: 0,
    community_rank: 0.85,
    summary: "æœ¬ç¤¾åŒºèšç„¦äºå›½å®¶å¥–å­¦é‡‘è¯„é€‰ä½“ç³»ã€‚æ ¸å¿ƒå®ä½“åŒ…æ‹¬å›½å®¶å¥–å­¦é‡‘ã€è¯„å®¡å§”å‘˜ä¼šå’Œä¼˜ç§€å­¦ç”Ÿã€‚",
    full_content: "å®ä½“: [å›½å®¶å¥–å­¦é‡‘, è¯„å®¡å§”å‘˜ä¼š, ...], å…³ç³»: [è¯„é€‰, ç”³è¯·, ...]",
    entity_count: 15,
    summary_created_at: datetime(),
    created_at: datetime()
})
```

**ç´¢å¼•**ï¼š

```cypher
-- ç¤¾åŒºIDå”¯ä¸€ç´¢å¼•
CREATE CONSTRAINT community_id_unique IF NOT EXISTS
FOR (c:__Community__) REQUIRE c.id IS UNIQUE;

-- ç¤¾åŒºå±‚çº§ç´¢å¼•
CREATE INDEX community_level IF NOT EXISTS
FOR (c:__Community__) ON (c.level);

-- ç¤¾åŒºæ’åç´¢å¼•ï¼ˆç”¨äºæ’åºï¼‰
CREATE INDEX community_rank IF NOT EXISTS
FOR (c:__Community__) ON (c.community_rank);
```

---

## å…³ç³»ç±»å‹ä¸å±æ€§

### å…³ç³»ç±»å‹æ€»è§ˆ

```mermaid
graph LR
    Doc[__Document__] -->|CONTAINS| Chunk[__Chunk__]
    Chunk -->|MENTIONS| Entity[__Entity__]
    Entity -->|RELATES_TO| Entity2[__Entity__]
    Entity -->|IN_COMMUNITY| Community[__Community__]
    Community -->|IN_COMMUNITY| Community2[__Community__]

    style Doc fill:#e3f2fd
    style Chunk fill:#fff3e0
    style Entity fill:#e8f5e9
    style Community fill:#fce4ec
```

### 1. CONTAINSï¼ˆåŒ…å«å…³ç³»ï¼‰

**æ–¹å‘**ï¼š`Document` â†’ `Chunk`

**ç”¨é€”**ï¼šè¡¨ç¤ºæ–‡æ¡£åŒ…å«å“ªäº›æ–‡æœ¬å—

**å±æ€§**ï¼š

| å±æ€§å | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|--------|------|------|------|
| `chunk_index` | Integer | âœ… | å—åœ¨æ–‡æ¡£ä¸­çš„åºå· |

**Cypher ç¤ºä¾‹**ï¼š

```cypher
MATCH (d:__Document__ {id: "doc_001"})
MATCH (c:__Chunk__ {id: "chunk_001_0"})
CREATE (d)-[:CONTAINS {chunk_index: 0}]->(c)
```

### 2. MENTIONSï¼ˆæåŠå…³ç³»ï¼‰

**æ–¹å‘**ï¼š`Chunk` â†’ `Entity`

**ç”¨é€”**ï¼šè¡¨ç¤ºæ–‡æœ¬å—æåŠäº†å“ªäº›å®ä½“

**å±æ€§**ï¼š

| å±æ€§å | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|--------|------|------|------|
| `mention_count` | Integer | âŒ | æåŠæ¬¡æ•°ï¼ˆå¯é€‰ï¼‰ |

**Cypher ç¤ºä¾‹**ï¼š

```cypher
MATCH (c:__Chunk__ {id: "chunk_001_0"})
MATCH (e:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})
CREATE (c)-[:MENTIONS {mention_count: 1}]->(e)
```

### 3. RELATES_TOï¼ˆå®ä½“å…³ç³»ï¼‰

**æ–¹å‘**ï¼š`Entity` â†’ `Entity`

**ç”¨é€”**ï¼šè¡¨ç¤ºå®ä½“ä¹‹é—´çš„è¯­ä¹‰å…³ç³»

**åŠ¨æ€å…³ç³»ç±»å‹**ï¼š
- ç³»ç»Ÿä¼šæ ¹æ®é¢†åŸŸå®šä¹‰åŠ¨æ€åˆ›å»ºå…³ç³»ç±»å‹
- ä¾‹å¦‚ï¼š`ç”³è¯·`, `è¯„é€‰`, `è¿çºª`, `ç®¡ç†` ç­‰

**å±æ€§**ï¼š

| å±æ€§å | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|--------|------|------|------|
| `description` | String | âœ… | å…³ç³»æè¿° |
| `weight` | Float | âŒ | å…³ç³»æƒé‡ï¼ˆ1.0ï¼‰ |
| `source_chunk` | String | âŒ | æ¥æºchunk ID |

**Cypher ç¤ºä¾‹**ï¼š

```cypher
MATCH (e1:__Entity__ {id: "å­¦ç”Ÿ"})
MATCH (e2:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})
CREATE (e1)-[:ç”³è¯· {
    description: "å­¦ç”Ÿå¯ä»¥ç”³è¯·å›½å®¶å¥–å­¦é‡‘",
    weight: 1.0,
    source_chunk: "chunk_001_0"
}]->(e2)
```

### 4. IN_COMMUNITYï¼ˆç¤¾åŒºå½’å±ï¼‰

**æ–¹å‘**ï¼š`Entity` â†’ `Community` æˆ– `Community` â†’ `Community`

**ç”¨é€”**ï¼š
- Entity â†’ Community: å®ä½“å±äºæŸä¸ªç¤¾åŒº
- Community â†’ Community: ç¤¾åŒºå±‚çº§å…³ç³»ï¼ˆLevel 0 â†’ Level 1 â†’ Level 2ï¼‰

**å±æ€§**ï¼šæ— é¢å¤–å±æ€§

**Cypher ç¤ºä¾‹**ï¼š

```cypher
-- å®ä½“å½’å±ç¤¾åŒº
MATCH (e:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})
MATCH (c:__Community__ {id: "0-123"})
CREATE (e)-[:IN_COMMUNITY]->(c)

-- ç¤¾åŒºå±‚çº§å…³ç³»
MATCH (c0:__Community__ {id: "0-123", level: 0})
MATCH (c1:__Community__ {id: "1-45", level: 1})
CREATE (c0)-[:IN_COMMUNITY]->(c1)
```

---

## å‘é‡ç´¢å¼•è®¾è®¡

### å‘é‡ç´¢å¼•æ¶æ„

```mermaid
graph TB
    subgraph åº”ç”¨å±‚[åº”ç”¨å±‚æŸ¥è¯¢]
        Query[ç”¨æˆ·æŸ¥è¯¢<br/>"å›½å®¶å¥–å­¦é‡‘çš„ç”³è¯·æ¡ä»¶"]
        Embed[åµŒå…¥æ¨¡å‹<br/>text-embedding-3-large]
        QueryVec[æŸ¥è¯¢å‘é‡<br/>1536ç»´]
    end

    subgraph ç´¢å¼•å±‚[Neo4j å‘é‡ç´¢å¼•]
        EntityIdx[Entity Index<br/>entity_index]
        ChunkIdx[Chunk Index<br/>chunk_index]
    end

    subgraph å­˜å‚¨å±‚[å‘é‡å­˜å‚¨]
        EntityVec[Entity Embeddings<br/>å­˜å‚¨åœ¨embeddingå±æ€§]
        ChunkVec[Chunk Embeddings<br/>å­˜å‚¨åœ¨embeddingå±æ€§]
    end

    subgraph ç»“æœå±‚[æ£€ç´¢ç»“æœ]
        EntityRes[ç›¸ä¼¼å®ä½“<br/>Top-K]
        ChunkRes[ç›¸ä¼¼æ–‡æœ¬å—<br/>Top-K]
    end

    Query --> Embed
    Embed --> QueryVec

    QueryVec --> EntityIdx
    QueryVec --> ChunkIdx

    EntityIdx --> EntityVec
    ChunkIdx --> ChunkVec

    EntityVec --> EntityRes
    ChunkVec --> ChunkRes

    style åº”ç”¨å±‚ fill:#e3f2fd
    style ç´¢å¼•å±‚ fill:#fff3e0
    style å­˜å‚¨å±‚ fill:#e8f5e9
    style ç»“æœå±‚ fill:#fce4ec
```

### 1. Entity å‘é‡ç´¢å¼•

**ç´¢å¼•é…ç½®**ï¼š

```cypher
// åˆ›å»º Entity å‘é‡ç´¢å¼•
CALL db.index.vector.createNodeIndex(
    'entity_index',                   // ç´¢å¼•åç§°
    '__Entity__',                     // èŠ‚ç‚¹æ ‡ç­¾
    'embedding',                      // åµŒå…¥å±æ€§å
    1536,                             // å‘é‡ç»´åº¦ï¼ˆtext-embedding-3-largeï¼‰
    'cosine'                          // ç›¸ä¼¼åº¦åº¦é‡ï¼ˆcosine/euclidean/dotï¼‰
)
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```cypher
// å‘é‡ç›¸ä¼¼åº¦æœç´¢
CALL db.index.vector.queryNodes(
    'entity_index',                   // ç´¢å¼•åç§°
    10,                               // Top-K
    [0.123, -0.456, ...]              // æŸ¥è¯¢å‘é‡ï¼ˆ1536ç»´ï¼‰
)
YIELD node, score
RETURN node.id, node.name, node.description, score
ORDER BY score DESC
```

**æ€§èƒ½ç‰¹å¾**ï¼š

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| ç´¢å¼•å¤§å° | ~9KB/å®ä½“ | 1536ç»´ Ã— 4å­—èŠ‚ + å…ƒæ•°æ® |
| æ£€ç´¢å»¶è¿Ÿ | 10-50ms | Top-10ï¼Œ10Kå®ä½“ |
| å¬å›ç‡ | >95% | ä½¿ç”¨HNSWç®—æ³• |

### 2. Chunk å‘é‡ç´¢å¼•

**ç´¢å¼•é…ç½®**ï¼š

```cypher
// åˆ›å»º Chunk å‘é‡ç´¢å¼•
CALL db.index.vector.createNodeIndex(
    'chunk_index',
    '__Chunk__',
    'embedding',
    1536,
    'cosine'
)
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```cypher
// Chunk ç›¸ä¼¼åº¦æœç´¢
CALL db.index.vector.queryNodes(
    'chunk_index',
    5,
    [0.789, -0.234, ...]
)
YIELD node, score
RETURN node.id, node.text, score
ORDER BY score DESC
```

### å‘é‡ç´¢å¼•ä¼˜åŒ–

**1. HNSW å‚æ•°è°ƒä¼˜**

Neo4j çš„å‘é‡ç´¢å¼•åŸºäº HNSWï¼ˆHierarchical Navigable Small Worldï¼‰ç®—æ³•ï¼š

```properties
# neo4j.conf

# HNSW ç´¢å¼•é…ç½®
db.index.vector.hnsw.ef_construction=200    # æ„å»ºæ—¶çš„æœç´¢å®½åº¦ï¼ˆé»˜è®¤200ï¼Œè¶Šå¤§è¶Šç²¾ç¡®ï¼‰
db.index.vector.hnsw.m=16                   # æ¯å±‚æœ€å¤§è¿æ¥æ•°ï¼ˆé»˜è®¤16ï¼‰
```

**å‚æ•°å½±å“**ï¼š

| å‚æ•° | å€¼è¶Šå¤§ | ç´¢å¼•æ„å»º | æŸ¥è¯¢æ€§èƒ½ | å¬å›ç‡ |
|------|--------|----------|----------|--------|
| ef_construction | â†‘ | è¶Šæ…¢ | æ— å½±å“ | è¶Šé«˜ |
| m | â†‘ | è¶Šæ…¢ | è¶Šå¿« | è¶Šé«˜ |

**2. æ‰¹é‡ç´¢å¼•æ„å»º**

```python
# æ‰¹é‡åˆ›å»ºå‘é‡ç´¢å¼•
from graphrag_agent.graph.indexing import EntityIndexBuilder

builder = EntityIndexBuilder()
builder.build_index(
    batch_size=100,           # æ‰¹å¤§å°
    max_workers=4             # å¹¶è¡Œåº¦
)
```

**3. ç´¢å¼•ç›‘æ§**

```cypher
// æŸ¥çœ‹ç´¢å¼•çŠ¶æ€
SHOW INDEXES
YIELD name, type, state, populationPercent, entityType
WHERE type = 'VECTOR'
RETURN *;

// æŸ¥çœ‹ç´¢å¼•å¤§å°
CALL db.index.vector.queryNodes('entity_index', 1, [0.0, 0.0, ...])
YIELD node
RETURN count(*) as total_indexed;
```

---

## æ•°æ®æ¨¡å‹è¯¦è§£

### å®Œæ•´æ•°æ®æ¨¡å‹å›¾

```mermaid
graph TB
    subgraph Documents[æ–‡æ¡£å±‚]
        D1[Document 1<br/>student_handbook.pdf]
        D2[Document 2<br/>regulations.txt]
    end

    subgraph Chunks[æ–‡æœ¬å—å±‚]
        C1[Chunk 1-0]
        C2[Chunk 1-1]
        C3[Chunk 2-0]
    end

    subgraph Entities[å®ä½“å±‚]
        E1[å›½å®¶å¥–å­¦é‡‘<br/>canonical]
        E2[å­¦ç”Ÿ]
        E3[è¯„å®¡å§”å‘˜ä¼š]
        E4[å›½å¥–<br/>variantâ†’å›½å®¶å¥–å­¦é‡‘]
    end

    subgraph Relations[å…³ç³»å±‚]
        R1[ç”³è¯·]
        R2[è¯„é€‰]
    end

    subgraph Communities[ç¤¾åŒºå±‚]
        Com0_1[Community 0-1<br/>L0: å¥–å­¦é‡‘è¯„é€‰]
        Com0_2[Community 0-2<br/>L0: å­¦ç”Ÿç®¡ç†]
        Com1_1[Community 1-1<br/>L1: å­¦ç”Ÿäº‹åŠ¡]
    end

    D1 -->|CONTAINS| C1
    D1 -->|CONTAINS| C2
    D2 -->|CONTAINS| C3

    C1 -->|MENTIONS| E1
    C1 -->|MENTIONS| E2
    C2 -->|MENTIONS| E3
    C3 -->|MENTIONS| E4

    E2 -->|ç”³è¯·| E1
    E3 -->|è¯„é€‰| E1

    E1 -->|IN_COMMUNITY| Com0_1
    E2 -->|IN_COMMUNITY| Com0_2
    E3 -->|IN_COMMUNITY| Com0_1

    Com0_1 -->|IN_COMMUNITY| Com1_1
    Com0_2 -->|IN_COMMUNITY| Com1_1

    style Documents fill:#e3f2fd
    style Chunks fill:#fff3e0
    style Entities fill:#e8f5e9
    style Communities fill:#fce4ec
```

### æ•°æ®æ¨¡å‹ç¤ºä¾‹

**åœºæ™¯**ï¼šå­¦ç”Ÿæ‰‹å†Œä¸­å…³äºå›½å®¶å¥–å­¦é‡‘çš„å†…å®¹

**1. Document èŠ‚ç‚¹**

```cypher
(:__Document__ {
    id: "doc_handbook",
    file_name: "student_handbook.pdf",
    file_path: "files/student_handbook.pdf",
    file_type: "pdf",
    content_hash: "a3f5e9...",
    file_size: 2048576,
    chunk_count: 85,
    created_at: datetime("2026-01-04T10:00:00Z")
})
```

**2. Chunk èŠ‚ç‚¹**

```cypher
(:__Chunk__ {
    id: "chunk_handbook_15",
    text: "å›½å®¶å¥–å­¦é‡‘æ˜¯å¥–åŠ±å­¦ä¸šæˆç»©ä¼˜å¼‚å­¦ç”Ÿçš„æœ€é«˜è£èª‰ã€‚æ¯å¹´è¯„é€‰ä¸€æ¬¡ï¼Œå¥–é‡‘8000å…ƒã€‚å­¦ç”Ÿéœ€æˆç»©æ’åå‰3%æ‰å¯ç”³è¯·ã€‚",
    chunk_index: 15,
    token_count: 512,
    embedding: [0.023, -0.145, 0.289, ...],  // 1536ç»´
    created_at: datetime("2026-01-04T10:05:00Z")
})
```

**3. Entity èŠ‚ç‚¹**

```cypher
// è§„èŒƒå®ä½“
(:__Entity__:å¥–å­¦é‡‘ç±»å‹ {
    id: "å›½å®¶å¥–å­¦é‡‘",
    name: "å›½å®¶å¥–å­¦é‡‘",
    type: "å¥–å­¦é‡‘ç±»å‹",
    description: "å¥–åŠ±å­¦ä¸šæˆç»©ä¼˜å¼‚å­¦ç”Ÿçš„æœ€é«˜è£èª‰ï¼Œæ¯å¹´è¯„é€‰ä¸€æ¬¡ï¼Œå¥–é‡‘8000å…ƒ",
    embedding: [0.156, -0.289, 0.445, ...],
    is_canonical: true,
    variants: ["å›½å¥–", "National Scholarship"],
    mention_count: 23,
    degree: 12,
    created_at: datetime("2026-01-04T10:10:00Z")
})

// å˜ä½“å®ä½“
(:__Entity__:å¥–å­¦é‡‘ç±»å‹ {
    id: "å›½å¥–",
    name: "å›½å¥–",
    type: "å¥–å­¦é‡‘ç±»å‹",
    canonical_id: "å›½å®¶å¥–å­¦é‡‘",
    is_canonical: false,
    created_at: datetime("2026-01-04T10:15:00Z")
})

// å…¶ä»–å®ä½“
(:__Entity__:å­¦ç”Ÿç±»å‹ {
    id: "ä¼˜ç§€å­¦ç”Ÿ",
    name: "ä¼˜ç§€å­¦ç”Ÿ",
    type: "å­¦ç”Ÿç±»å‹",
    description: "å­¦ä¸šæˆç»©ä¼˜å¼‚çš„å­¦ç”Ÿ",
    embedding: [0.234, -0.112, 0.567, ...],
    is_canonical: true,
    mention_count: 18,
    degree: 15,
    created_at: datetime("2026-01-04T10:12:00Z")
})
```

**4. å…³ç³»**

```cypher
// æ–‡æ¡£åŒ…å«chunk
(:__Document__ {id: "doc_handbook"})-[:CONTAINS {chunk_index: 15}]->(:__Chunk__ {id: "chunk_handbook_15"})

// ChunkæåŠå®ä½“
(:__Chunk__ {id: "chunk_handbook_15"})-[:MENTIONS]->(:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})
(:__Chunk__ {id: "chunk_handbook_15"})-[:MENTIONS]->(:__Entity__ {id: "ä¼˜ç§€å­¦ç”Ÿ"})

// å®ä½“ä¹‹é—´çš„å…³ç³»
(:__Entity__ {id: "ä¼˜ç§€å­¦ç”Ÿ"})-[:ç”³è¯· {
    description: "ä¼˜ç§€å­¦ç”Ÿå¯ä»¥ç”³è¯·å›½å®¶å¥–å­¦é‡‘",
    weight: 1.0,
    source_chunk: "chunk_handbook_15"
}]->(:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})
```

**5. Community èŠ‚ç‚¹**

```cypher
(:__Community__ {
    id: "0-25",
    level: 0,
    community_rank: 0.89,
    summary: "æœ¬ç¤¾åŒºèšç„¦äºå›½å®¶å¥–å­¦é‡‘è¯„é€‰ä½“ç³»ã€‚æ ¸å¿ƒå®ä½“åŒ…æ‹¬å›½å®¶å¥–å­¦é‡‘ã€ä¼˜ç§€å­¦ç”Ÿã€è¯„å®¡å§”å‘˜ä¼šã€‚",
    entity_count: 8,
    created_at: datetime("2026-01-04T11:00:00Z")
})

// å®ä½“å½’å±ç¤¾åŒº
(:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})-[:IN_COMMUNITY]->(:__Community__ {id: "0-25"})
```

---

## å­˜å‚¨ä¼˜åŒ–ç­–ç•¥

### 1. å±æ€§å‹ç¼©

**å‘é‡å‹ç¼©**ï¼š

è™½ç„¶ Neo4j ä¸ç›´æ¥æ”¯æŒå‘é‡é‡åŒ–ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–ï¼š

```python
# ä½¿ç”¨è¾ƒä½ç»´åº¦çš„åµŒå…¥æ¨¡å‹ï¼ˆæƒè¡¡ï¼šå‡†ç¡®ç‡ vs å­˜å‚¨ï¼‰
# text-embedding-3-large: 1536ç»´ï¼ˆé»˜è®¤ï¼‰
# text-embedding-3-small: 512ç»´ï¼ˆèŠ‚çœ 67% å­˜å‚¨ï¼‰

from graphrag_agent.config import settings

# é…ç½®ä½¿ç”¨å°æ¨¡å‹
settings.OPENAI_EMBEDDINGS_MODEL = "text-embedding-3-small"
settings.EMBEDDING_DIM = 512
```

**å­—ç¬¦ä¸²å»é‡**ï¼š

```cypher
// Neo4j è‡ªåŠ¨å¯¹ç›¸åŒå­—ç¬¦ä¸²å»é‡ï¼ˆString Interningï¼‰
// å¤šä¸ªèŠ‚ç‚¹å¼•ç”¨ç›¸åŒæè¿°æ—¶ï¼Œå®é™…åªå­˜å‚¨ä¸€ä»½
```

### 2. æ‰¹é‡æ“ä½œ

**æ‰¹é‡å†™å…¥**ï¼š

```python
# ä½¿ç”¨ UNWIND æ‰¹é‡åˆ›å»ºèŠ‚ç‚¹
batch_size = 100
entities_batch = entities[i:i+batch_size]

query = """
UNWIND $batch AS row
MERGE (e:__Entity__ {id: row.id})
SET e.name = row.name,
    e.type = row.type,
    e.description = row.description,
    e.embedding = row.embedding
"""

graph.query(query, params={"batch": entities_batch})
```

**æ‰¹é‡åˆ é™¤**ï¼š

```cypher
// åˆ†æ‰¹åˆ é™¤ï¼ˆé¿å…å¤§äº‹åŠ¡ï¼‰
CALL apoc.periodic.iterate(
    "MATCH (c:__Chunk__) WHERE c.id STARTS WITH 'old_' RETURN c",
    "DETACH DELETE c",
    {batchSize: 1000, parallel: false}
)
```

### 3. ç´¢å¼•ç­–ç•¥

**æŒ‰éœ€åˆ›å»ºç´¢å¼•**ï¼š

```cypher
// ä»…ä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
// âœ… æ¨èï¼šæŸ¥è¯¢é¢‘ç¹çš„å­—æ®µ
CREATE INDEX entity_type IF NOT EXISTS FOR (e:__Entity__) ON (e.type);

// âŒ é¿å…ï¼šä½é¢‘æŸ¥è¯¢å­—æ®µ
// CREATE INDEX entity_mention_count IF NOT EXISTS FOR (e:__Entity__) ON (e.mention_count);
```

**å¤åˆç´¢å¼•**ï¼ˆNeo4j 5.x+ï¼‰ï¼š

```cypher
// å¤šå­—æ®µç»„åˆç´¢å¼•
CREATE INDEX entity_type_canonical IF NOT EXISTS
FOR (e:__Entity__) ON (e.type, e.is_canonical);
```

### 4. å…³ç³»ä¼˜åŒ–

**é¿å…åˆ›å»ºå†—ä½™å…³ç³»**ï¼š

```cypher
// âœ… æ¨èï¼šä½¿ç”¨ MERGE é¿å…é‡å¤
MATCH (e1:__Entity__ {id: "å­¦ç”Ÿ"})
MATCH (e2:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})
MERGE (e1)-[r:ç”³è¯·]->(e2)
ON CREATE SET r.description = "å­¦ç”Ÿå¯ä»¥ç”³è¯·å›½å®¶å¥–å­¦é‡‘"

// âŒ é¿å…ï¼šç›´æ¥ CREATE å¯èƒ½åˆ›å»ºé‡å¤å…³ç³»
// CREATE (e1)-[:ç”³è¯·]->(e2)
```

**å…³ç³»æ–¹å‘ä¼˜åŒ–**ï¼š

```cypher
// ç»Ÿä¸€å…³ç³»æ–¹å‘ï¼Œé¿å…åŒå‘å­˜å‚¨
// âœ… æ¨èï¼šå•å‘å…³ç³» + æŸ¥è¯¢æ—¶åå‘
(:å­¦ç”Ÿ)-[:ç”³è¯·]->(:å›½å®¶å¥–å­¦é‡‘)

// æŸ¥è¯¢åå‘å…³ç³»
MATCH (:å›½å®¶å¥–å­¦é‡‘)<-[:ç”³è¯·]-(s:å­¦ç”Ÿ)
RETURN s

// âŒ é¿å…ï¼šå­˜å‚¨åŒå‘å…³ç³»
// (:å­¦ç”Ÿ)-[:ç”³è¯·]->(:å›½å®¶å¥–å­¦é‡‘)
// (:å›½å®¶å¥–å­¦é‡‘)-[:è¢«ç”³è¯·]->(:å­¦ç”Ÿ)
```

---

## æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

### 1. æŸ¥è¯¢è®¡åˆ’åˆ†æ

**ä½¿ç”¨ EXPLAIN å’Œ PROFILE**ï¼š

```cypher
// EXPLAIN: æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
EXPLAIN
MATCH (e:__Entity__ {type: "å¥–å­¦é‡‘ç±»å‹"})
RETURN e.id, e.name
LIMIT 10;

// PROFILE: æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ + å®é™…æ€§èƒ½æ•°æ®
PROFILE
MATCH (e:__Entity__ {type: "å¥–å­¦é‡‘ç±»å‹"})-[:ç”³è¯·]-(s:__Entity__)
RETURN e.id, count(s) as applicants
ORDER BY applicants DESC
LIMIT 10;
```

**å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | ä¼˜åŒ–ç›®æ ‡ |
|------|------|----------|
| db hits | æ•°æ®åº“è®¿é—®æ¬¡æ•° | è¶Šå°‘è¶Šå¥½ |
| rows | è¿”å›è¡Œæ•° | - |
| estimated rows | ä¼°è®¡è¡Œæ•° | è¶Šå‡†è¶Šå¥½ |
| Index Seek | ç´¢å¼•æŸ¥æ‰¾ | ä¼˜å…ˆä½¿ç”¨ |
| Node By Label Scan | æ ‡ç­¾æ‰«æ | å¯æ¥å— |
| All Nodes Scan | å…¨è¡¨æ‰«æ | âŒ é¿å… |

### 2. ç´¢å¼•æç¤º

**å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•**ï¼š

```cypher
// ä½¿ç”¨ USING INDEX æç¤º
MATCH (e:__Entity__)
USING INDEX e:__Entity__(type)
WHERE e.type = "å¥–å­¦é‡‘ç±»å‹"
RETURN e
```

**å‘é‡ç´¢å¼•æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```cypher
// âœ… æ¨èï¼šé™åˆ¶ Top-K
CALL db.index.vector.queryNodes('entity_index', 10, $queryVector)
YIELD node, score
WHERE score > 0.8  // è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼
RETURN node
LIMIT 10

// âŒ é¿å…ï¼šä¸é™åˆ¶ç»“æœæ•°
// CALL db.index.vector.queryNodes('entity_index', 10000, $queryVector)
```

### 3. æŸ¥è¯¢ä¼˜åŒ–æ¨¡å¼

**æ¨¡å¼1ï¼šé¿å…ç¬›å¡å°”ç§¯**

```cypher
// âŒ é¿å…ï¼šç¬›å¡å°”ç§¯
MATCH (e1:__Entity__)
MATCH (e2:__Entity__)
WHERE e1.type = e2.type
RETURN e1, e2

// âœ… æ¨èï¼šä½¿ç”¨å…³ç³»æˆ– WITH åˆ†éš”
MATCH (e1:__Entity__)
WITH e1
MATCH (e2:__Entity__ {type: e1.type})
WHERE id(e1) < id(e2)
RETURN e1, e2
```

**æ¨¡å¼2ï¼šæå‰è¿‡æ»¤**

```cypher
// âŒ é¿å…ï¼šåè¿‡æ»¤
MATCH (e:__Entity__)-[r]-(e2:__Entity__)
WHERE e.type = "å¥–å­¦é‡‘ç±»å‹"
RETURN e, r, e2

// âœ… æ¨èï¼šå…ˆè¿‡æ»¤å†éå†
MATCH (e:__Entity__ {type: "å¥–å­¦é‡‘ç±»å‹"})-[r]-(e2:__Entity__)
RETURN e, r, e2
```

**æ¨¡å¼3ï¼šä½¿ç”¨å­æŸ¥è¯¢**

```cypher
// å¤æ‚æŸ¥è¯¢ä½¿ç”¨ CALL å­æŸ¥è¯¢
MATCH (c:__Community__ {level: 0})
CALL {
    WITH c
    MATCH (c)<-[:IN_COMMUNITY]-(e:__Entity__)
    RETURN count(e) as entity_count
}
WHERE entity_count > 5
RETURN c.id, entity_count
ORDER BY entity_count DESC
```

### 4. ç¼“å­˜ç­–ç•¥

**æŸ¥è¯¢ç»“æœç¼“å­˜**ï¼ˆåº”ç”¨å±‚ï¼‰ï¼š

```python
from functools import lru_cache

@lru_cache(maxsize=1000)
def get_entity_by_id(entity_id: str):
    """å¸¦ç¼“å­˜çš„å®ä½“æŸ¥è¯¢"""
    result = graph.query("""
        MATCH (e:__Entity__ {id: $id})
        RETURN e
    """, params={"id": entity_id})
    return result[0] if result else None
```

**Neo4j Page Cache**ï¼š

```properties
# neo4j.conf
# å¢åŠ  Page Cache å¤§å°ï¼Œç¼“å­˜æ›´å¤šèŠ‚ç‚¹/å…³ç³»
dbms.memory.pagecache.size=8g
```

---

## æ•°æ®ä¸€è‡´æ€§ä¿è¯

### 1. çº¦æŸå®šä¹‰

**å”¯ä¸€æ€§çº¦æŸ**ï¼š

```cypher
-- æ–‡æ¡£IDå”¯ä¸€
CREATE CONSTRAINT document_id_unique IF NOT EXISTS
FOR (d:__Document__) REQUIRE d.id IS UNIQUE;

-- Chunk IDå”¯ä¸€
CREATE CONSTRAINT chunk_id_unique IF NOT EXISTS
FOR (c:__Chunk__) REQUIRE c.id IS UNIQUE;

-- Entity IDå”¯ä¸€
CREATE CONSTRAINT entity_id_unique IF NOT EXISTS
FOR (e:__Entity__) REQUIRE e.id IS UNIQUE;

-- Community IDå”¯ä¸€
CREATE CONSTRAINT community_id_unique IF NOT EXISTS
FOR (c:__Community__) REQUIRE c.id IS UNIQUE;
```

**å­˜åœ¨æ€§çº¦æŸ**ï¼ˆNeo4j Enterpriseï¼‰ï¼š

```cypher
-- å®ä½“å¿…é¡»æœ‰ name å±æ€§
CREATE CONSTRAINT entity_name_exists IF NOT EXISTS
FOR (e:__Entity__) REQUIRE e.name IS NOT NULL;

-- å®ä½“å¿…é¡»æœ‰ type å±æ€§
CREATE CONSTRAINT entity_type_exists IF NOT EXISTS
FOR (e:__Entity__) REQUIRE e.type IS NOT NULL;
```

### 2. äº‹åŠ¡ç®¡ç†

**æ‰¹é‡æ“ä½œçš„äº‹åŠ¡æ§åˆ¶**ï¼š

```python
from neo4j import GraphDatabase

class GraphTransactionManager:
    def __init__(self, uri, auth):
        self.driver = GraphDatabase.driver(uri, auth=auth)

    def batch_create_entities(self, entities, batch_size=100):
        """æ‰¹é‡åˆ›å»ºå®ä½“ï¼Œä½¿ç”¨äº‹åŠ¡"""
        with self.driver.session() as session:
            for i in range(0, len(entities), batch_size):
                batch = entities[i:i+batch_size]

                # ä½¿ç”¨äº‹åŠ¡å‡½æ•°
                session.execute_write(self._create_entities_tx, batch)

    @staticmethod
    def _create_entities_tx(tx, entities):
        """äº‹åŠ¡å‡½æ•°ï¼šåˆ›å»ºå®ä½“"""
        query = """
        UNWIND $batch AS row
        MERGE (e:__Entity__ {id: row.id})
        SET e.name = row.name,
            e.type = row.type,
            e.description = row.description
        """
        tx.run(query, batch=entities)
```

**äº‹åŠ¡éš”ç¦»çº§åˆ«**ï¼š

Neo4j ä½¿ç”¨ **READ COMMITTED** éš”ç¦»çº§åˆ«ï¼š
- è¯»æ“ä½œåªèƒ½çœ‹åˆ°å·²æäº¤çš„æ•°æ®
- å†™æ“ä½œä¼šé”å®šç›¸å…³èŠ‚ç‚¹å’Œå…³ç³»
- é¿å…è„è¯»ï¼Œä½†å¯èƒ½å‡ºç°ä¸å¯é‡å¤è¯»

### 3. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

**å®šæœŸæ£€æŸ¥è„šæœ¬**ï¼š

```cypher
// 1. æ£€æŸ¥å­¤ç«‹ Chunkï¼ˆæ²¡æœ‰è¿æ¥åˆ° Documentï¼‰
MATCH (c:__Chunk__)
WHERE NOT (c)<-[:CONTAINS]-(:__Document__)
RETURN count(c) as orphan_chunks;

// 2. æ£€æŸ¥å­¤ç«‹ Entityï¼ˆæ²¡æœ‰å…³ç³»ï¼‰
MATCH (e:__Entity__)
WHERE NOT (e)-[]-()
RETURN count(e) as orphan_entities;

// 3. æ£€æŸ¥å‘é‡åµŒå…¥ç¼ºå¤±
MATCH (e:__Entity__)
WHERE e.embedding IS NULL
RETURN count(e) as entities_without_embedding;

// 4. æ£€æŸ¥ç¤¾åŒºå½’å±
MATCH (e:__Entity__)
WHERE NOT (e)-[:IN_COMMUNITY]->(:__Community__)
RETURN count(e) as entities_without_community;
```

**è‡ªåŠ¨ä¿®å¤å·¥å…·**ï¼š

```python
# backend/graphrag_agent/graph/graph_consistency_validator.py

class GraphConsistencyValidator:
    def validate_and_fix(self):
        """éªŒè¯å¹¶ä¿®å¤å›¾ä¸€è‡´æ€§"""
        issues = []

        # 1. ä¿®å¤å­¤ç«‹ chunks
        orphan_chunks = self.find_orphan_chunks()
        if orphan_chunks:
            issues.append(f"å‘ç° {len(orphan_chunks)} ä¸ªå­¤ç«‹ chunks")
            self.delete_orphan_chunks(orphan_chunks)

        # 2. è¡¥å…¨ç¼ºå¤±çš„åµŒå…¥
        entities_without_embedding = self.find_entities_without_embedding()
        if entities_without_embedding:
            issues.append(f"å‘ç° {len(entities_without_embedding)} ä¸ªå®ä½“ç¼ºå¤±åµŒå…¥")
            self.regenerate_embeddings(entities_without_embedding)

        return issues
```

---

## å¤‡ä»½ä¸æ¢å¤

### 1. Neo4j å¤‡ä»½ç­–ç•¥

**åœ¨çº¿å¤‡ä»½**ï¼ˆNeo4j Enterpriseï¼‰ï¼š

```bash
# å…¨é‡å¤‡ä»½
neo4j-admin database backup --database=neo4j --to-path=/backups/full-backup

# å¢é‡å¤‡ä»½
neo4j-admin database backup --database=neo4j --to-path=/backups/incremental-backup --incremental
```

**å¯¼å‡ºä¸º Cypher**ï¼ˆCommunityï¼‰ï¼š

```bash
# ä½¿ç”¨ apoc å¯¼å‡º
cypher-shell "
CALL apoc.export.cypher.all('/backups/graph-export.cypher', {
    format: 'cypher-shell',
    useOptimizations: {type: 'UNWIND_BATCH', unwindBatchSize: 20}
})
"
```

**å¯¼å‡ºä¸º JSON**ï¼š

```cypher
// å¯¼å‡ºæ‰€æœ‰å®ä½“
CALL apoc.export.json.query(
    "MATCH (e:__Entity__) RETURN e",
    "/backups/entities.json",
    {}
)

// å¯¼å‡ºæ‰€æœ‰å…³ç³»
CALL apoc.export.json.query(
    "MATCH (e1:__Entity__)-[r]->(e2:__Entity__) RETURN e1, r, e2",
    "/backups/relationships.json",
    {}
)
```

### 2. å®šæ—¶å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup-neo4j.sh

BACKUP_DIR="/backups/neo4j"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="neo4j_backup_${DATE}"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ${BACKUP_DIR}/${BACKUP_NAME}

# åœæ­¢ Neo4j
docker-compose stop neo4j

# å¤åˆ¶æ•°æ®æ–‡ä»¶
cp -r /var/lib/neo4j/data ${BACKUP_DIR}/${BACKUP_NAME}/

# å¯åŠ¨ Neo4j
docker-compose start neo4j

# å‹ç¼©å¤‡ä»½
tar -czf ${BACKUP_DIR}/${BACKUP_NAME}.tar.gz ${BACKUP_DIR}/${BACKUP_NAME}

# åˆ é™¤ä¸´æ—¶ç›®å½•
rm -rf ${BACKUP_DIR}/${BACKUP_NAME}

# ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find ${BACKUP_DIR} -name "*.tar.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: ${BACKUP_NAME}.tar.gz"
```

**å®šæ—¶ä»»åŠ¡**ï¼š

```bash
# crontab -e
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /path/to/backup-neo4j.sh >> /var/log/neo4j-backup.log 2>&1
```

### 3. æ•°æ®æ¢å¤

**ä»å¤‡ä»½æ¢å¤**ï¼š

```bash
#!/bin/bash
# restore-neo4j.sh

BACKUP_FILE="/backups/neo4j/neo4j_backup_20260104_020000.tar.gz"

# åœæ­¢ Neo4j
docker-compose stop neo4j

# æ¸…ç©ºç°æœ‰æ•°æ®
rm -rf /var/lib/neo4j/data/*

# è§£å‹å¤‡ä»½
tar -xzf ${BACKUP_FILE} -C /tmp/

# æ¢å¤æ•°æ®
cp -r /tmp/neo4j_backup_*/data/* /var/lib/neo4j/data/

# å¯åŠ¨ Neo4j
docker-compose start neo4j

echo "æ¢å¤å®Œæˆ"
```

**ä» Cypher å¯¼å…¥**ï¼š

```bash
# æ¸…ç©ºæ•°æ®åº“
cypher-shell "MATCH (n) DETACH DELETE n"

# å¯¼å…¥å¤‡ä»½
cypher-shell < /backups/graph-export.cypher
```

---

## ç›‘æ§ä¸è¯Šæ–­

### 1. Neo4j ç›‘æ§æŒ‡æ ‡

**å…³é”®æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | æŸ¥è¯¢æ–¹æ³• | å¥åº·é˜ˆå€¼ |
|------|----------|----------|
| èŠ‚ç‚¹æ€»æ•° | `MATCH (n) RETURN count(n)` | - |
| å…³ç³»æ€»æ•° | `MATCH ()-[r]->() RETURN count(r)` | - |
| å­˜å‚¨å¤§å° | `CALL dbms.queryJmx("org.neo4j:name=Store file sizes")` | <80% ç£ç›˜ |
| Page Cache å‘½ä¸­ç‡ | `CALL dbms.queryJmx("org.neo4j:name=Page cache")` | >90% |
| äº‹åŠ¡ååé‡ | Metrics API | - |
| æŸ¥è¯¢å»¶è¿Ÿ | `CALL dbms.listQueries()` | <100ms |

**å®æ—¶ç›‘æ§æŸ¥è¯¢**ï¼š

```cypher
// æŸ¥çœ‹å½“å‰è¿è¡Œçš„æŸ¥è¯¢
CALL dbms.listQueries()
YIELD queryId, query, elapsedTimeMillis, status
WHERE elapsedTimeMillis > 1000  // è¶…è¿‡1ç§’çš„æŸ¥è¯¢
RETURN queryId, query, elapsedTimeMillis
ORDER BY elapsedTimeMillis DESC;

// ç»ˆæ­¢æ…¢æŸ¥è¯¢
CALL dbms.killQuery($queryId)
```

**å­˜å‚¨ç»Ÿè®¡**ï¼š

```cypher
// èŠ‚ç‚¹æ ‡ç­¾ç»Ÿè®¡
CALL db.labels() YIELD label
CALL apoc.cypher.run('MATCH (:`'+label+'`) RETURN count(*) as count', {})
YIELD value
RETURN label, value.count as count
ORDER BY count DESC;

// å…³ç³»ç±»å‹ç»Ÿè®¡
CALL db.relationshipTypes() YIELD relationshipType
CALL apoc.cypher.run('MATCH ()-[:`'+relationshipType+'`]->() RETURN count(*) as count', {})
YIELD value
RETURN relationshipType, value.count as count
ORDER BY count DESC;
```

### 2. æ€§èƒ½è¯Šæ–­å·¥å…·

**æ…¢æŸ¥è¯¢æ—¥å¿—**ï¼š

```properties
# neo4j.conf
# è®°å½•è¶…è¿‡ 1 ç§’çš„æŸ¥è¯¢
dbms.logs.query.enabled=true
dbms.logs.query.threshold=1s
dbms.logs.query.parameter_logging_enabled=true
```

**åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—**ï¼š

```bash
# æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
tail -f /var/lib/neo4j/logs/query.log

# åˆ†ææœ€æ…¢çš„æŸ¥è¯¢
cat /var/lib/neo4j/logs/query.log | grep -oP '(?<=runtime=)[0-9]+' | sort -n | tail -10
```

**å‘é‡ç´¢å¼•è¯Šæ–­**ï¼š

```cypher
// æ£€æŸ¥å‘é‡ç´¢å¼•çŠ¶æ€
SHOW INDEXES
YIELD name, type, state, populationPercent
WHERE type = 'VECTOR'
RETURN *;

// æµ‹è¯•å‘é‡æŸ¥è¯¢æ€§èƒ½
CALL db.index.vector.queryNodes('entity_index', 10, $testVector)
YIELD node, score
RETURN count(*);
```

### 3. ç›‘æ§ä»ªè¡¨æ¿

**Prometheus + Grafana é›†æˆ**ï¼š

```yaml
# docker-compose.yml
services:
  neo4j:
    image: neo4j:5.14.0
    environment:
      - NEO4J_metrics_prometheus_enabled=true
      - NEO4J_metrics_prometheus_endpoint=0.0.0.0:2004
    ports:
      - "2004:2004"  # Prometheus metrics

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
```

**Prometheus é…ç½®**ï¼š

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'neo4j'
    static_configs:
      - targets: ['neo4j:2004']
```

---

## å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šé«˜æ•ˆçš„å¤šè·³æŸ¥è¯¢

**éœ€æ±‚**ï¼šæŸ¥æ‰¾ä¸"å›½å®¶å¥–å­¦é‡‘"ç›¸å…³çš„æ‰€æœ‰å®ä½“ï¼ˆ2è·³å†…ï¼‰

```cypher
// âŒ ä½æ•ˆæ–¹æ¡ˆï¼šå¤šæ¬¡æŸ¥è¯¢
MATCH (e:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})
RETURN e;

MATCH (e:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})-[r1]-(e1)
RETURN e, r1, e1;

MATCH (e:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})-[r1]-(e1)-[r2]-(e2)
RETURN e, r1, e1, r2, e2;

// âœ… é«˜æ•ˆæ–¹æ¡ˆï¼šå•æ¬¡æŸ¥è¯¢
MATCH path = (e:__Entity__ {id: "å›½å®¶å¥–å­¦é‡‘"})-[*1..2]-(related)
RETURN
    e.id as center_entity,
    [n in nodes(path) | n.id] as path_entities,
    length(path) as hops
ORDER BY hops, related.degree DESC
LIMIT 100;
```

### æ¡ˆä¾‹2ï¼šå‘é‡æ£€ç´¢ + å›¾éå†æ··åˆ

**éœ€æ±‚**ï¼šæ‰¾åˆ°ä¸æŸ¥è¯¢æœ€ç›¸ä¼¼çš„å®ä½“ï¼Œå¹¶è¿”å›å…¶é‚»å±…

```cypher
// ç¬¬ä¸€æ­¥ï¼šå‘é‡ç›¸ä¼¼åº¦å¬å›
CALL db.index.vector.queryNodes('entity_index', 5, $queryVector)
YIELD node as center, score
WHERE score > 0.8

// ç¬¬äºŒæ­¥ï¼šå›¾éå†è·å–é‚»å±…
CALL {
    WITH center
    MATCH (center)-[r]-(neighbor:__Entity__)
    RETURN neighbor, r, type(r) as rel_type
    ORDER BY neighbor.degree DESC
    LIMIT 10
}

// ç¬¬ä¸‰æ­¥ï¼šèšåˆç»“æœ
RETURN
    center.id as entity,
    score,
    collect({
        neighbor: neighbor.id,
        relationship: rel_type,
        description: r.description
    }) as related_entities
ORDER BY score DESC;
```

### æ¡ˆä¾‹3ï¼šç¤¾åŒºçº§èšåˆæŸ¥è¯¢

**éœ€æ±‚**ï¼šç»Ÿè®¡æ¯ä¸ª Level 1 ç¤¾åŒºåŒ…å«çš„å®ä½“æ•°é‡å’Œç±»å‹åˆ†å¸ƒ

```cypher
MATCH (c:__Community__ {level: 1})
CALL {
    WITH c
    MATCH (c)<-[:IN_COMMUNITY*]-(e:__Entity__)
    RETURN
        count(distinct e) as entity_count,
        collect(distinct e.type) as entity_types
}
RETURN
    c.id as community,
    c.summary as summary,
    entity_count,
    entity_types,
    size(entity_types) as type_diversity
ORDER BY entity_count DESC;
```

### æ¡ˆä¾‹4ï¼šå¢é‡æ›´æ–°ä¸­çš„å†²çªæ£€æµ‹

**éœ€æ±‚**ï¼šæ£€æµ‹æ–°å®ä½“ä¸ç°æœ‰å®ä½“çš„æ½œåœ¨å†²çª

```cypher
// ç¬¬ä¸€æ­¥ï¼šå‘é‡ç›¸ä¼¼åº¦å¬å›å€™é€‰
CALL db.index.vector.queryNodes('entity_index', 20, $newEntityEmbedding)
YIELD node as candidate, score
WHERE score > 0.85 AND node.type = $newEntityType

// ç¬¬äºŒæ­¥ï¼šå­—ç¬¦ä¸²ç›¸ä¼¼åº¦è¿‡æ»¤
WITH candidate, score,
     apoc.text.levenshteinSimilarity(candidate.name, $newEntityName) as name_similarity
WHERE name_similarity > 0.8

// ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥å…³ç³»é‡å 
CALL {
    WITH candidate
    MATCH (candidate)-[r]-(neighbor)
    RETURN collect(distinct neighbor.id) as candidate_neighbors
}

WITH candidate, score, name_similarity, candidate_neighbors,
     [n in $newEntityNeighbors | n.id] as new_neighbors
WITH candidate, score, name_similarity,
     apoc.coll.intersection(candidate_neighbors, new_neighbors) as common_neighbors

// ç¬¬å››æ­¥ï¼šåˆ¤æ–­æ˜¯å¦å†²çª
RETURN
    candidate.id as potentially_duplicate,
    score as vector_similarity,
    name_similarity,
    size(common_neighbors) as common_neighbor_count,
    CASE
        WHEN score > 0.95 AND name_similarity > 0.9 THEN 'HIGH_CONFLICT'
        WHEN score > 0.90 AND name_similarity > 0.85 THEN 'MEDIUM_CONFLICT'
        WHEN score > 0.85 OR name_similarity > 0.80 THEN 'LOW_CONFLICT'
        ELSE 'NO_CONFLICT'
    END as conflict_level
ORDER BY score DESC, name_similarity DESC;
```

---

## å¸¸è§é—®é¢˜

### Q1: å‘é‡ç´¢å¼•æ„å»ºå¤±è´¥

**é—®é¢˜**ï¼š`db.index.vector.createNodeIndex` æŠ¥é”™

**å¯èƒ½åŸå› **ï¼š
1. Neo4j ç‰ˆæœ¬ < 5.13ï¼ˆå‘é‡ç´¢å¼•éœ€è¦ 5.13+ï¼‰
2. å‘é‡ç»´åº¦ä¸åŒ¹é…
3. å†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# 1. æ£€æŸ¥ Neo4j ç‰ˆæœ¬
cypher-shell "CALL dbms.components() YIELD versions RETURN versions[0]"

# 2. æ£€æŸ¥å‘é‡ç»´åº¦
cypher-shell "MATCH (e:__Entity__) RETURN size(e.embedding) LIMIT 1"

# 3. å¢åŠ å †å†…å­˜
# neo4j.conf
dbms.memory.heap.max_size=8g
```

### Q2: æŸ¥è¯¢æ€§èƒ½çªç„¶ä¸‹é™

**é—®é¢˜**ï¼šç›¸åŒæŸ¥è¯¢ä» 100ms å˜ä¸º 5s

**å¯èƒ½åŸå› **ï¼š
1. Page Cache ä¸è¶³
2. ç´¢å¼•å¤±æ•ˆæˆ–æœªä½¿ç”¨
3. æ•°æ®é‡çªå¢

**è¯Šæ–­æ­¥éª¤**ï¼š

```cypher
// 1. æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’
PROFILE
<your slow query>

// 2. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨
EXPLAIN
<your slow query>

// 3. æ£€æŸ¥ Page Cache å‘½ä¸­ç‡
CALL dbms.queryJmx("org.neo4j:name=Page cache")
YIELD attributes
RETURN attributes["HitRatio"]
```

### Q3: å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢å¬å›ç‡ä½

**é—®é¢˜**ï¼šé¢„æœŸåº”è¯¥å¬å›çš„å®ä½“æ²¡æœ‰è¿”å›

**å¯èƒ½åŸå› **ï¼š
1. ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡é«˜
2. å‘é‡åµŒå…¥è´¨é‡é—®é¢˜
3. Top-K è®¾ç½®è¿‡å°

**è§£å†³æ–¹æ¡ˆ**ï¼š

```cypher
// 1. é™ä½ç›¸ä¼¼åº¦é˜ˆå€¼
CALL db.index.vector.queryNodes('entity_index', 20, $queryVector)
YIELD node, score
WHERE score > 0.7  // ä» 0.9 é™ä½åˆ° 0.7
RETURN node

// 2. æ£€æŸ¥åµŒå…¥è´¨é‡
MATCH (e:__Entity__)
WHERE e.embedding IS NULL OR size(e.embedding) <> 1536
RETURN count(e) as problematic_entities

// 3. å¢åŠ  Top-K
CALL db.index.vector.queryNodes('entity_index', 50, $queryVector)  // ä» 10 å¢åŠ åˆ° 50
YIELD node, score
RETURN node
```

### Q4: å­˜å‚¨ç©ºé—´å ç”¨è¿‡å¤§

**é—®é¢˜**ï¼šçŸ¥è¯†å›¾è°±å ç”¨ 10GB+ å­˜å‚¨

**ä¼˜åŒ–å»ºè®®**ï¼š

```cypher
// 1. åˆ é™¤å­¤ç«‹èŠ‚ç‚¹
MATCH (e:__Entity__)
WHERE NOT (e)-[]-()
DETACH DELETE e

// 2. åˆå¹¶é‡å¤å®ä½“ï¼ˆè¿è¡Œæ¶ˆæ­§ï¼‰
// è§å®ä½“æ¶ˆæ­§æ–‡æ¡£

// 3. æ¸…ç†æ—§æ•°æ®
MATCH (d:__Document__)
WHERE d.created_at < datetime() - duration('P90D')  // 90å¤©å‰
DETACH DELETE d

// 4. å‹ç¼©æ•°æ®åº“
// åœæ­¢ Neo4jï¼Œåˆ é™¤ transaction logs
```

---

## ç›¸å…³æ–‡æ¡£

- [çŸ¥è¯†å›¾è°±æ„å»º](../02-æ ¸å¿ƒå­ç³»ç»Ÿ/çŸ¥è¯†å›¾è°±æ„å»º.md) - äº†è§£å›¾è°±æ„å»ºæµç¨‹
- [å®ä½“æ¶ˆæ­§å’Œå¯¹é½](../03-å…³é”®ç‰¹æ€§/å®ä½“æ¶ˆæ­§å’Œå¯¹é½.md) - å®ä½“è´¨é‡ä¿è¯æœºåˆ¶
- [ç¤¾åŒºæ£€æµ‹](../02-æ ¸å¿ƒå­ç³»ç»Ÿ/ç¤¾åŒºæ£€æµ‹.md) - ç¤¾åŒºç»“æ„è®¾è®¡
- [æ€§èƒ½è°ƒä¼˜](./æ€§èƒ½è°ƒä¼˜.md) - ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–
- [Neo4j å®˜æ–¹æ–‡æ¡£](https://neo4j.com/docs/) - Neo4j è¯¦ç»†æ–‡æ¡£

---

## æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 1.0 | 2026-01-04 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´è¦†ç›–å­˜å‚¨æ¨¡å‹è®¾è®¡ | Claude |
| - | - | - | - |
