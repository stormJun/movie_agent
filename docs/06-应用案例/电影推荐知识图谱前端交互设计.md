## 6. 前端交互设计

### 6.1 React 前端界面设计

本项目采用 **React 18 + TypeScript + Ant Design 5** 构建现代化前端界面，提供更好的用户体验和性能。

**技术栈**：
- **框架**: React 18 + TypeScript 5
- **UI 库**: Ant Design 5
- **构建工具**: Vite 6
- **图谱可视化**: @antv/g6
- **HTTP 客户端**: Axios
- **路由**: React Router DOM 6

**前端目录结构**：
```
frontend-react/
├── src/
│   ├── pages/
│   │   ├── ChatPage.tsx              # Chat 工作台（主界面）
│   │   ├── MovieExplorePage.tsx      # 电影探索页面
│   │   ├── MovieDetailPage.tsx       # 电影详情页面
│   │   └── MovieRecommendPage.tsx    # 推荐结果页面
│   ├── components/
│   │   ├── MovieCard.tsx             # 电影卡片组件
│   │   ├── MovieSearchPanel.tsx      # 电影搜索面板
│   │   ├── GraphView.tsx             # 知识图谱可视化
│   │   ├── RecommendationList.tsx    # 推荐列表
│   │   └── MovieKGPanel.tsx          # 电影知识图谱面板
│   ├── services/
│   │   ├── http.ts                   # Axios 配置
│   │   ├── chat.ts                   # 聊天 API
│   │   ├── movie.ts                  # 电影 API
│   │   └── graph.ts                  # 图谱 API
│   └── types/
│       ├── movie.ts                  # 电影类型定义
│       └── chat.ts                   # 聊天类型定义
└── package.json
```

#### 6.1.1 电影搜索面板组件

**文件**: `frontend-react/src/components/MovieSearchPanel.tsx`

**功能**：
- 实时搜索电影（支持模糊匹配）
- 显示搜索结果列表
- 点击电影跳转详情页

**TypeScript 类型定义**：
```typescript
// src/types/movie.ts
export interface Movie {
  movieId: number;
  tmdbId?: number;
  imdbId?: string;
  name: string;
  year: number;
  overview?: string;
  poster_path?: string;
  genres: string[];
  movielens_avg_rating?: number;
  tmdb_vote_average?: number;
  runtime?: number;
}

export interface MovieSearchRequest {
  query: string;
  limit?: number;
}

export interface MovieSearchResponse {
  movies: Movie[];
  total: number;
}
```

**组件实现**：
```tsx
import { useState } from 'react';
import { Input, List, Card, Tag, Rate } from 'antd';
import { SearchOutlined } from '@ant-design/icons';
import { searchMovies } from '../services/movie';
import type { Movie } from '../types/movie';

export function MovieSearchPanel() {
  const [query, setQuery] = useState('');
  const [movies, setMovies] = useState<Movie[]>([]);
  const [loading, setLoading] = useState(false);

  const handleSearch = async (value: string) => {
    if (!value.trim()) return;

    setLoading(true);
    try {
      const { data } = await searchMovies({ query: value, limit: 10 });
      setMovies(data.movies);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ padding: '16px' }}>
      <Input.Search
        placeholder="搜索电影名称..."
        prefix={<SearchOutlined />}
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        onSearch={handleSearch}
        loading={loading}
        allowClear
      />

      <List
        dataSource={movies}
        loading={loading}
        style={{ marginTop: '16px' }}
        renderItem={(movie) => (
          <List.Item>
            <Card
              hoverable
              style={{ width: '100%' }}
              onClick={() => window.location.href = `/movie/${movie.movieId}`}
            >
              <div style={{ display: 'flex', gap: '16px' }}>
                {movie.poster_path && (
                  <img
                    src={`https://image.tmdb.org/t/p/w92${movie.poster_path}`}
                    alt={movie.name}
                    style={{ width: 60, height: 90, objectFit: 'cover' }}
                  />
                )}
                <div style={{ flex: 1 }}>
                  <h4>{movie.name} ({movie.year})</h4>
                  <div>
                    {movie.genres.map(g => (
                      <Tag key={g} color="blue">{g}</Tag>
                    ))}
                  </div>
                  <Rate
                    disabled
                    value={movie.tmdb_vote_average ? movie.tmdb_vote_average / 2 : 0}
                    style={{ fontSize: 14 }}
                  />
                  <span style={{ marginLeft: 8 }}>
                    {movie.tmdb_vote_average?.toFixed(1) || 'N/A'}
                  </span>
                </div>
              </div>
            </Card>
          </List.Item>
        )}
      />
    </div>
  );
}
```

#### 6.1.2 电影详情卡片组件

**文件**: `frontend-react/src/components/MovieCard.tsx`

**功能**：
- 显示电影海报、标题、评分
- 展示导演、主演信息
- 显示类型标签和简介
- 提供"查看详情"和"推荐相似电影"按钮

**组件实现**：
```tsx
import { Card, Rate, Tag, Button, Space, Typography } from 'antd';
import { PlayCircleOutlined, StarOutlined } from '@ant-design/icons';
import type { Movie } from '../types/movie';

const { Paragraph } = Typography;

interface MovieCardProps {
  movie: Movie;
  onRecommend?: (movieId: number) => void;
}

export function MovieCard({ movie, onRecommend }: MovieCardProps) {
  return (
    <Card
      hoverable
      style={{ marginBottom: 16 }}
      cover={
        movie.poster_path && (
          <img
            alt={movie.name}
            src={`https://image.tmdb.org/t/p/w342${movie.poster_path}`}
            style={{ height: 400, objectFit: 'cover' }}
          />
        )
      }
    >
      <Card.Meta
        title={
          <Space direction="vertical" size={0}>
            <span style={{ fontSize: 18, fontWeight: 'bold' }}>
              {movie.name}
            </span>
            <span style={{ fontSize: 14, color: '#888' }}>
              ({movie.year})
            </span>
          </Space>
        }
        description={
          <Space direction="vertical" size={12} style={{ width: '100%' }}>
            {/* 评分 */}
            <div>
              <Rate
                disabled
                value={movie.tmdb_vote_average ? movie.tmdb_vote_average / 2 : 0}
              />
              <span style={{ marginLeft: 8, fontSize: 16, fontWeight: 'bold' }}>
                {movie.tmdb_vote_average?.toFixed(1) || 'N/A'}
              </span>
            </div>

            {/* 类型标签 */}
            <div>
              {movie.genres.map(genre => (
                <Tag key={genre} color="blue">{genre}</Tag>
              ))}
            </div>

            {/* 简介 */}
            {movie.overview && (
              <Paragraph ellipsis={{ rows: 3, expandable: true }}>
                {movie.overview}
              </Paragraph>
            )}

            {/* 操作按钮 */}
            <Space>
              <Button
                type="primary"
                icon={<PlayCircleOutlined />}
                onClick={() => window.location.href = `/movie/${movie.movieId}`}
              >
                查看详情
              </Button>
              <Button
                icon={<StarOutlined />}
                onClick={() => onRecommend?.(movie.movieId)}
              >
                推荐相似电影
              </Button>
            </Space>
          </Space>
        }
      />
    </Card>
  );
}
```

#### 6.1.3 知识图谱可视化组件

**文件**: `frontend-react/src/components/MovieKGPanel.tsx`

**功能**：
- 基于 @antv/g6 渲染电影知识图谱
- 显示电影、演员、导演、类型等实体
- 支持拖拽、缩放、节点高亮等交互

**类型定义**：
```typescript
// src/types/graph.ts
export interface GraphNode {
  id: string;
  label: string;
  type: 'movie' | 'actor' | 'director' | 'genre' | 'keyword';
  properties?: Record<string, any>;
}

export interface GraphEdge {
  source: string;
  target: string;
  label: string;
  properties?: Record<string, any>;
}

export interface MovieSubgraph {
  nodes: GraphNode[];
  edges: GraphEdge[];
}
```

**组件实现**：
```tsx
import { useEffect, useRef } from 'react';
import G6, { Graph, GraphData } from '@antv/g6';
import type { MovieSubgraph } from '../types/graph';

interface MovieKGPanelProps {
  data: MovieSubgraph;
  width?: number;
  height?: number;
}

export function MovieKGPanel({ data, width = 800, height = 600 }: MovieKGPanelProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const graphRef = useRef<Graph | null>(null);

  // 节点颜色映射
  const nodeColorMap = {
    movie: '#FF5733',     // 电影：红色
    actor: '#3498DB',     // 演员：蓝色
    director: '#2ECC71',  // 导演：绿色
    genre: '#F39C12',     // 类型：橙色
    keyword: '#9B59B6',   // 关键词：紫色
  };

  useEffect(() => {
    if (!containerRef.current) return;

    // 转换数据格式
    const graphData: GraphData = {
      nodes: data.nodes.map(node => ({
        id: node.id,
        label: node.label,
        style: {
          fill: nodeColorMap[node.type],
          lineWidth: 2,
          stroke: '#fff',
        },
        labelCfg: {
          style: {
            fill: '#000',
            fontSize: 12,
          },
        },
      })),
      edges: data.edges.map(edge => ({
        source: edge.source,
        target: edge.target,
        label: edge.label,
        style: {
          stroke: '#888',
          lineWidth: 1.5,
        },
        labelCfg: {
          style: {
            fill: '#666',
            fontSize: 10,
          },
        },
      })),
    };

    // 创建图谱实例
    const graph = new G6.Graph({
      container: containerRef.current,
      width,
      height,
      modes: {
        default: ['drag-canvas', 'zoom-canvas', 'drag-node'],
      },
      layout: {
        type: 'force',
        preventOverlap: true,
        linkDistance: 150,
        nodeStrength: -50,
        edgeStrength: 0.3,
      },
      defaultNode: {
        size: 40,
        type: 'circle',
      },
      defaultEdge: {
        type: 'line',
        style: {
          endArrow: {
            path: G6.Arrow.triangle(8, 10, 0),
            fill: '#888',
          },
        },
      },
    });

    graph.data(graphData);
    graph.render();
    graphRef.current = graph;

    // 节点点击事件
    graph.on('node:click', (evt) => {
      const node = evt.item;
      const nodeData = node?.getModel();
      console.log('Clicked node:', nodeData);
      // 可以在这里添加跳转逻辑
    });

    // 清理
    return () => {
      graph.destroy();
    };
  }, [data, width, height]);

  return <div ref={containerRef} />;
}
```

#### 6.1.4 推荐结果展示组件

**文件**: `frontend-react/src/components/RecommendationList.tsx`

**功能**：
- 显示推荐电影列表
- 展示推荐理由和相似度分数
- 支持排序和筛选

**类型定义**：
```typescript
// src/types/movie.ts (扩展)
export interface MovieRecommendation {
  movie: Movie;
  score: number;
  reason: string;
  similarity_type: string;
  evidence: string[];
}
```

**组件实现**：
```tsx
import { List, Card, Rate, Tag, Progress, Typography, Space } from 'antd';
import { TrophyOutlined } from '@ant-design/icons';
import type { MovieRecommendation } from '../types/movie';

const { Text, Paragraph } = Typography;

interface RecommendationListProps {
  recommendations: MovieRecommendation[];
  loading?: boolean;
}

export function RecommendationList({ recommendations, loading }: RecommendationListProps) {
  return (
    <div>
      <h2>
        <TrophyOutlined /> 推荐电影
      </h2>

      <List
        grid={{ gutter: 16, xs: 1, sm: 2, md: 2, lg: 3, xl: 3, xxl: 4 }}
        dataSource={recommendations}
        loading={loading}
        renderItem={(rec, index) => (
          <List.Item>
            <Card
              hoverable
              cover={
                rec.movie.poster_path && (
                  <img
                    alt={rec.movie.name}
                    src={`https://image.tmdb.org/t/p/w342${rec.movie.poster_path}`}
                    style={{ height: 300, objectFit: 'cover' }}
                  />
                )
              }
            >
              <Card.Meta
                title={
                  <Space direction="vertical" size={4}>
                    <Text strong>{index + 1}. {rec.movie.name}</Text>
                    <Text type="secondary">({rec.movie.year})</Text>
                  </Space>
                }
                description={
                  <Space direction="vertical" size={8} style={{ width: '100%' }}>
                    {/* 相似度分数 */}
                    <div>
                      <Text strong>相似度：</Text>
                      <Progress
                        percent={Math.round(rec.score * 100)}
                        size="small"
                        strokeColor="#52c41a"
                      />
                    </div>

                    {/* 评分 */}
                    <div>
                      <Rate
                        disabled
                        value={rec.movie.tmdb_vote_average ? rec.movie.tmdb_vote_average / 2 : 0}
                        style={{ fontSize: 14 }}
                      />
                      <span style={{ marginLeft: 8 }}>
                        {rec.movie.tmdb_vote_average?.toFixed(1) || 'N/A'}
                      </span>
                    </div>

                    {/* 类型标签 */}
                    <div>
                      {rec.movie.genres.slice(0, 3).map(g => (
                        <Tag key={g} color="blue" style={{ fontSize: 11 }}>
                          {g}
                        </Tag>
                      ))}
                    </div>

                    {/* 推荐理由 */}
                    <div>
                      <Text type="secondary" strong>推荐理由：</Text>
                      <Paragraph ellipsis={{ rows: 2 }} style={{ marginBottom: 4 }}>
                        {rec.reason}
                      </Paragraph>
                    </div>

                    {/* 相似类型标签 */}
                    <Tag color="green">{rec.similarity_type}</Tag>
                  </Space>
                }
              />
            </Card>
          </List.Item>
        )}
      />
    </div>
  );
}
```

#### 6.1.5 Chat 工作台集成

**文件**: `frontend-react/src/pages/ChatPage.tsx` (修改)

**新增电影领域配置**：
```tsx
// 在 agentOptions 中添加电影领域示例问题
const movieExamples = [
  "《Toy Story》的导演是谁？",
  "汤姆·汉克斯主演过哪些电影？",
  "推荐几部科幻电影",
  "哪些电影和《星球大战》相似？",
  "1995年有哪些高分电影？",
];

// 在界面中显示示例问题
<div style={{ marginBottom: 16 }}>
  <Text type="secondary">示例问题：</Text>
  <Space wrap>
    {movieExamples.map((q, i) => (
      <Tag
        key={i}
        color="blue"
        style={{ cursor: 'pointer' }}
        onClick={() => setInputValue(q)}
      >
        {q}
      </Tag>
    ))}
  </Space>
</div>
```

### 6.2 后端 API 新增接口

**修改文件**：`backend/server/api/rest/v1/chat.py` 或新增 `backend/server/api/rest/v1/movie.py`

**新增端点**：

```python
from fastapi import APIRouter, Query
from typing import List, Optional

router = APIRouter(prefix="/movie", tags=["movie"])

@router.get("/search")
async def search_movies(
    query: str = Query(..., description="电影名称关键词"),
    limit: int = Query(10, description="返回结果数量")
):
    """搜索电影（模糊匹配）"""
    # Cypher 查询
    cypher = """
    MATCH (m:电影)
    WHERE m.name CONTAINS $query
    RETURN m
    LIMIT $limit
    """
    # 执行并返回
    ...

@router.get("/detail/{movie_id}")
async def get_movie_detail(movie_id: int):
    """获取电影详情"""
    cypher = """
    MATCH (m:电影 {movieId: $movie_id})
    OPTIONAL MATCH (m)<-[:导演]-(director:人物)
    OPTIONAL MATCH (actor:人物)-[:出演]->(m)
    RETURN m, collect(DISTINCT director) AS directors, collect(DISTINCT actor) AS actors
    """
    ...

@router.get("/recommend/{movie_id}")
async def recommend_movies(
    movie_id: int,
    top_k: int = Query(10, description="推荐数量")
):
    """推荐相似电影"""
    # 调用 MovieRecommendationTool
    ...

@router.get("/subgraph/{movie_id}")
async def get_movie_subgraph(movie_id: int):
    """获取电影子图（用于可视化）"""
    cypher = """
    MATCH (m:电影 {movieId: $movie_id})
    OPTIONAL MATCH (m)<-[:导演]-(director:人物)
    OPTIONAL MATCH (actor:人物)-[:出演]->(m)
    OPTIONAL MATCH (m)-[r:相似]-(similar:电影)
    RETURN m, collect(DISTINCT director) AS directors,
           collect(DISTINCT actor) AS actors,
           collect(DISTINCT {movie: similar, score: r.similarity_score}) AS similar_movies
    """
    ...
```

---

