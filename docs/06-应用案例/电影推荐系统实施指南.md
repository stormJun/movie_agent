# 电影推荐知识图谱系统实施指南

本文档提供电影推荐知识图谱系统的快速实施步骤和命令。

## 前置条件

### 1. 环境准备

```bash
# 确保已激活 graphrag 环境
conda activate graphrag

# 安装额外依赖
pip install requests pandas tqdm python-dotenv
```

### 2. 配置 TMDB API

将 TMDB API Token 添加到 `.env` 文件：

```bash
# 编辑 .env 文件（如果不存在，从 .env.example 复制）
cp .env.example .env

# 添加 TMDB API 配置
echo "TMDB_API_TOKEN=<YOUR_TMDB_BEARER_TOKEN>" >> .env
```

### 3. 验证数据文件

确认 SparrowRecSys 数据文件存在：

```bash
ls -lh SparrowRecSys-master/target/classes/webroot/sampledata/
```

应该看到：
- `movies.csv` - 982 部电影
- `links.csv` - TMDB/IMDB ID 映射
- `ratings.csv` - 116万条评分记录

---

## Phase 1: 数据预处理与 TMDB 数据获取

### 步骤 1.1: 运行数据预处理脚本

```bash
# 进入项目根目录
cd graph-rag-agent

# 运行预处理脚本
python3 data/movie/movie_data_preprocessing.py \
    --source-dir SparrowRecSys-master/target/classes/webroot/sampledata \
    --output-dir files/movie_data \
    --cache-dir files/tmdb_cache \
    --rate-limit 4
```

**参数说明**：
- `--source-dir`: MovieLens 数据目录
- `--output-dir`: 输出 JSON 文件目录（默认: files/movie_data）
- `--cache-dir`: TMDB API 响应缓存目录（避免重复请求）
- `--rate-limit`: TMDB API 速率限制（每秒请求数，默认4）
- `--skip-optional`: 跳过可选 API（recommendations, similar）

**预期耗时**：
- 核心数据（详情 + 演员）: 约 8-10 分钟
- 包含关键词: 约 12-15 分钟
- 完整数据: 约 20-25 分钟

### 步骤 1.2: 验证输出文件

```bash
# 查看生成的 JSON 文件
ls -lh files/movie_data/*.json

# 预期输出：
# - movies_enriched.json (约 982 条记录)
# - persons.json (约 3000-4000 条记录)
# - keywords.json (约 1000 条记录)
# - companies.json (约 300 条记录)
# - countries.json (约 40-50 条记录)
# - languages.json (约 20-30 条记录)
```

### 步骤 1.3: 检查数据质量

```bash
# 查看电影数据样本
python3 -c "
import json
with open('files/movie_data/movies_enriched.json', 'r', encoding='utf-8') as f:
    movies = json.load(f)
print(f'总电影数: {len(movies)}')
tmdb_count = sum(1 for m in movies if m.get('data_source') == 'movielens+tmdb')
print(f'包含 TMDB 数据: {tmdb_count}')
print(f'仅 MovieLens 数据: {len(movies) - tmdb_count}')
print(f'\\n示例电影:')
for movie in movies[:3]:
    print(f'  - {movie[\"name\"]} ({movie.get(\"year\", \"未知年份\")})')
"
```

---

## Phase 2: 知识图谱构建

### 步骤 2.1: 更新配置文件

编辑 `.env`（如果不存在，从 `.env.example` 复制），配置电影域的 RAG 语义参数（对应 `backend/config/rag.py`）：

```bash
KB_NAME='电影推荐知识库'
GRAPH_THEME='电影知识图谱与推荐系统'
GRAPH_ENTITY_TYPES='电影,演员,导演,类型,关键词,制作公司,国家,语言'
GRAPH_RELATIONSHIP_TYPES='出演,导演,属于类型,包含关键词,制作,来自国家,使用语言,相似,推荐,共同出演,合作导演'

LC_DESCRIPTION='用于需要具体细节的查询。检索电影的剧情、演员、导演、类型等详细信息。适用于“某部电影的导演是谁”、“某演员主演过哪些电影”等问题。'
GL_DESCRIPTION='用于需要总结归纳的查询。分析电影类型分布、导演风格、演员合作网络等宏观内容。适用于“科幻电影的特点”、“某导演的作品风格”等需要系统性分析的问题。'
NAIVE_DESCRIPTION='基础检索工具，直接查找与问题最相关的电影信息，返回最匹配的文本片段。'

FRONTEND_EXAMPLES='《Toy Story》的导演是谁？,汤姆·汉克斯主演过哪些电影？,推荐几部科幻电影,哪些电影和《星球大战》相似？,1995年有哪些高分电影？'
```

### 步骤 2.2: 创建图谱构建脚本（待实现）

待创建 `backend/infrastructure/integrations/build/build_movie_graph.py`（根据设计文档 Section 4.3.2）：

**TODO**: 此脚本需要实现以下功能：
1. 读取 `files/movie_data/movies_enriched.json` 等 JSON 文件
2. 创建 Neo4j 节点（电影、演员、导演、类型等）
3. 创建关系边（出演、导演、属于类型等）
4. 计算电影相似度（基于类型、演员、关键词）
5. 创建索引

### 步骤 2.3: 运行图谱构建（脚本实现后）

```bash
# 清空现有图谱（可选，谨慎操作！）
bash scripts/python.sh -c "
from infrastructure.providers.neo4jdb import get_db_manager
db = get_db_manager()
db.execute_query('MATCH (n) DETACH DELETE n')
print('图谱已清空')
"

# 运行图谱构建脚本（build_movie_graph.py 实现后）
bash scripts/py.sh infrastructure.integrations.build.build_movie_graph \
    --movies-json files/movie_data/movies_enriched.json \
    --persons-json files/movie_data/persons.json \
    --keywords-json files/movie_data/keywords.json \
    --companies-json files/movie_data/companies.json \
    --countries-json files/movie_data/countries.json \
    --languages-json files/movie_data/languages.json
```

**预期输出**：
```
=== 电影知识图谱构建 ===

[1/10] 创建电影节点...
  导入电影: 982
  导入类型: 19
  创建"属于类型"关系: 2,004

[2/10] 创建演员节点与出演关系...
  导入演员: 3,245
  创建"出演"关系: 9,876

[3/10] 创建导演节点与导演关系...
  导入导演: 512
  创建"导演"关系: 1,024

... (省略其他步骤)

=== 图谱统计 ===
节点总数: 6,113
  - 电影: 982
  - 演员: 3,245
  - 导演: 512
  - 类型: 19
  - 关键词: 987
  - 制作公司: 287
  - 国家: 45
  - 语言: 28

关系总数: 27,534
  - 出演: 9,876
  - 导演: 1,024
  - 属于类型: 2,004
  - 包含关键词: 4,532
  - 制作: 1,876
  - 来自国家: 1,245
  - 使用语言: 1,098
  - 相似: 4,566
  - 共同出演: 6,789

完成! 耗时: 3 分 45 秒
```

---

## Phase 3: 向量索引与社区检测

### 步骤 3.1: 运行向量索引构建

```bash
# 使用现有的 main.py 流程
bash scripts/py.sh infrastructure.integrations.build.main
```

**自动执行的步骤**：
1. 实体向量化（使用 OpenAI Embeddings）
2. 文本分块索引（电影 overview 分块）
3. 社区检测（Leiden 算法）
4. 社区摘要生成

**预期耗时**: 10-15 分钟

### 步骤 3.2: 验证向量索引

```cypher
// 在 Neo4j Browser 中运行
// 检查向量索引
SHOW INDEXES

// 查看电影节点数量
MATCH (m:电影) RETURN count(m)

// 查看实体向量维度
MATCH (m:电影) WHERE m.embedding IS NOT NULL
RETURN m.name, size(m.embedding) AS embedding_dim
LIMIT 5
```

---

## Phase 4: 测试搜索与推荐功能

### 步骤 4.1: 测试基本查询

```bash
cd test/

# 修改 search_without_stream.py 中的测试问题
# 将问题改为电影相关
python search_without_stream.py
```

**测试问题示例**：
```python
TEST_QUERIES = [
    "《Toy Story》的导演是谁？",
    "汤姆·汉克斯主演过哪些电影？",
    "推荐几部科幻电影",
    "哪些电影和《星球大战》相似？",
    "1995年有哪些高分电影？"
]
```

### 步骤 4.2: 启动服务

```bash
# 启动后端 API
bash scripts/dev.sh backend

# 在另一个终端启动前端
streamlit run frontend/app.py
```

访问 `http://localhost:8501` 测试电影推荐系统。

---

## 常见问题排查

### 1. TMDB API 限流 (HTTP 429)

**现象**: 脚本输出 "触发限流 (429)"

**解决方案**:
- 脚本会自动等待 10 秒后重试
- 如频繁触发，调整 `--rate-limit` 参数为更小值（如 3 或 2）

### 2. 网络连接超时

**现象**: `requests.exceptions.ConnectTimeout`

**解决方案**:
- 检查网络连接
- 检查是否需要代理
- 增加超时时间（在脚本中修改 `timeout=30` 为更大值）

### 3. 缓存损坏

**现象**: JSON 解析错误

**解决方案**:
```bash
# 清空缓存重新获取
rm -rf files/tmdb_cache/*
python3 data/movie/movie_data_preprocessing.py ...
```

### 4. Neo4j 连接失败

**现象**: `neo4j.exceptions.ServiceUnavailable`

**解决方案**:
```bash
# 检查 Neo4j 是否运行
docker ps | grep neo4j

# 如未运行，启动 Neo4j
docker compose up -d
```

### 5. 内存不足

**现象**: `MemoryError` 或系统卡顿

**解决方案**:
- 调整 `.env` 中的批处理参数
- 减小 `GDS_MEMORY_LIMIT`、`BATCH_SIZE` 等

---

## 数据规模参考

| 数据类型 | 数量 | 备注 |
|---------|------|------|
| 电影 | 982 | 1926-1998年 |
| 有 TMDB ID | 971 (98.9%) | 可直接调用 API |
| 无 TMDB ID | 11 (1.1%) | 当前保持 `movielens_only`（如需可扩展 `/search/movie` 补齐） |
| 演员 | ~3,000 | 从演员表提取 |
| 导演 | ~500 | 从 crew 提取 |
| 类型 | 19 | 标准类型 |
| 关键词 | ~1,000 | 从 TMDB 获取 |
| 制作公司 | ~300 | 从 TMDB 获取 |
| 评分记录 | 1,168,638 | MovieLens 用户评分 |
| 用户数 | 29,776 | 可用于协同过滤 |

## TMDB API 调用估算

| API 端点 | 调用次数 | 用途 | 优先级 |
|---------|---------|------|--------|
| `/movie/{id}` | 971 | 电影详情 | 必需 |
| `/movie/{id}/credits` | 971 | 演员、导演 | 必需 |
| `/movie/{id}/keywords` | 971 | 关键词 | 推荐 |
| `/movie/{id}/recommendations` | 971 | 推荐关系 | 可选 |
| `/movie/{id}/similar` | 971 | 相似关系 | 可选 |
| **总计（必需）** | **1,942** | **约 8.1 分钟** | - |
| **总计（推荐）** | **2,913** | **约 12.1 分钟** | - |
| **总计（完整）** | **4,855** | **约 20.2 分钟** | - |

---

## 下一步优化方向

### 1. 自定义电影推荐工具

待创建 `backend/graphrag_agent/search/tool/movie_recommendation_tool.py`，实现：
- 基于内容的推荐（类型、演员、关键词）
- 基于图谱路径的推荐（共同出演、导演风格）
- 混合推荐（向量相似度 + 图谱关系）

### 2. 前端界面优化

修改 `frontend/app.py`，添加：
- 电影搜索面板
- 电影详情卡片（带海报）
- 知识图谱可视化（演员-电影-导演关系）
- 推荐结果展示（相似度、推荐理由）

### 3. 用户个性化推荐

导入 `ratings.csv` 中的用户数据，实现：
- 用户-电影评分网络
- 协同过滤推荐
- 个性化 Agent

### 4. 多轮对话推荐

实现对话式推荐：
```
用户：推荐科幻电影
系统：您喜欢硬科幻还是软科幻？
用户：硬科幻
系统：推荐《星际穿越》、《火星救援》...
```

---

## 参考文档

- [电影推荐知识图谱设计文档](./电影推荐知识图谱设计文档.md)
- [TMDB API 官方文档](https://developer.themoviedb.org/reference/intro/getting-started)
- [GraphRAG 项目主 README](../../README.md)
- [知识图谱构建流程](../../backend/infrastructure/integrations/build/readme.md)

---

**文档版本**: v1.0
**最后更新**: 2026-01-05
**作者**: GraphRAG Agent Team
