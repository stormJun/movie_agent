# 07-æ’ä»¶ç³»ç»Ÿ

æœ¬ç›®å½•åŒ…å« GraphRAG Agent æ’ä»¶ç³»ç»Ÿçš„å®Œæ•´è®¾è®¡æ–‡æ¡£ã€‚

## âš ï¸ ç°çŠ¶è¯´æ˜ï¼ˆè¯·å…ˆè¯»ï¼‰

å½“å‰ä»“åº“çš„â€œå¯æ‰©å±•èƒ½åŠ›â€ä¸»è¦ä»æ˜¯**ä»£ç æ³¨å†Œè¡¨/å·¥å‚æ¨¡å¼**ï¼ˆAgent/Tool/KB è·¯ç”±ï¼‰ï¼Œè€Œã€Šå¯é…ç½®æ’ä»¶æ¶æ„ã€‹æè¿°çš„æ˜¯**è§„åˆ’ä¸­çš„é…ç½®é©±åŠ¨æ’ä»¶ç³»ç»Ÿ**ï¼ˆRegistry + YAML + åŠ¨æ€åŠ è½½/å¯é€‰å­è¿›ç¨‹è¿è¡Œæ—¶ï¼‰ï¼Œå°šæœªåœ¨æœ¬ä»“åº“ä»¥ `backend/infrastructure/plugin_system/` çš„å½¢å¼è½åœ°ã€‚

å› æ­¤ï¼š
- æƒ³â€œç°åœ¨å°±æ‰©å±•â€ï¼šè¯·çœ‹æœ¬æ–‡æ¡£çš„ã€Œå½“å‰æ‰©å±•ç‚¹ï¼ˆå·²å®ç°ï¼‰ã€ã€‚
- æƒ³â€œè§„åˆ’ä¸ç›®æ ‡æ€â€ï¼šè¯·é˜…è¯»æœ¬ç›®å½•ä¸‹ä¸¤ä»½è®¾è®¡/å¯¹æ¯”æ–‡æ¡£ã€‚
- `backend/config/plugins/` ç›®å½•ç›®å‰å¯èƒ½ä¸ºç©ºï¼›æ–‡æ¡£ä¸­å…³äº `knowledge_bases.yaml` / `agents.yaml` / `tools.yaml` çš„å†…å®¹å±äºç›®æ ‡æ€è®¾è®¡ã€‚

## ğŸ“š æ–‡æ¡£åˆ—è¡¨

### æ ¸å¿ƒè®¾è®¡æ–‡æ¡£

1. **[å¯é…ç½®æ’ä»¶æ¶æ„è®¾è®¡æ–‡æ¡£](./CONFIGURABLE_PLUGIN_ARCHITECTURE.md)** (v3.0.0)
   - **å†…å®¹**ï¼šæ’ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒæ¶æ„è®¾è®¡
   - **åŒ…å«**ï¼š
     - èƒŒæ™¯ä¸ç›®æ ‡
     - æ ¸å¿ƒé—®é¢˜åˆ†æï¼ˆç¡¬ç¼–ç ç—›ç‚¹ï¼‰
     - æ¶æ„è®¾è®¡ï¼ˆRegistry + é…ç½®é©±åŠ¨ + åŠ¨æ€åŠ è½½ï¼‰
     - æ ¸å¿ƒç»„ä»¶å®ç°ï¼ˆProtocolã€Registryã€Loaderã€ConfigManagerï¼‰
     - é…ç½®æ–‡ä»¶æ ¼å¼ï¼ˆKB/Agent/Toolï¼‰
     - Subprocess Runtimeï¼ˆMVPï¼‰
     - å®æ–½è®¡åˆ’ï¼ˆ10å¤©å®Œæ•´è·¯çº¿å›¾ï¼‰
     - ç¤ºä¾‹ä»£ç ï¼ˆæ–°å¢ KB/Agent/Tool å®Œæ•´ç¤ºä¾‹ï¼‰
     - è¿ç§»æŒ‡å—ï¼ˆä¸€æ¬¡æ€§åˆ‡æ¢ç­–ç•¥ï¼‰
     - æœ€ä½³å®è·µï¼ˆé…ç½®ç»„ç»‡ã€å¼€å‘è§„èŒƒã€æµ‹è¯•è§„èŒƒï¼‰
     - æ’ä»¶æ›´æ–°ä¸å›æ»šæµç¨‹
   - **å›¾è¡¨**ï¼š
     - é…ç½®åŠ è½½æ—¶åºå›¾
     - è¯·æ±‚å¤„ç†æµç¨‹å›¾
     - æ’ä»¶ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœº
     - æ›´æ–°æµç¨‹è¯¦ç»†æ—¶åºå›¾
     - æ’ä»¶åŠ è½½é”™è¯¯è¯Šæ–­æµç¨‹å›¾

2. **[Dify æ’ä»¶ç³»ç»Ÿå¯¹æ¯”åˆ†æ](./DIFY_PLUGIN_COMPARISON.md)** (v1.0.0)
   - **å†…å®¹**ï¼šå­¦ä¹  Dify æ’ä»¶è®¾è®¡ï¼Œæ”¹è¿›æˆ‘ä»¬çš„æ’ä»¶ç³»ç»Ÿ
   - **åŒ…å«**ï¼š
     - Dify æ’ä»¶ç³»ç»Ÿæ¦‚è¿°ï¼ˆBeehive Architectureï¼‰
     - æ ¸å¿ƒè®¾è®¡å¯¹æ¯”ï¼ˆéš”ç¦»æ€§ã€å®‰å…¨æ€§ã€æ€§èƒ½ã€å…¼å®¹æ€§ï¼‰
     - æ¶æ„è®¾è®¡åˆ†æ
     - è¿è¡Œæ—¶æœºåˆ¶ï¼ˆæœ¬åœ°éƒ¨ç½² vs SaaSï¼‰
     - æ’ä»¶ç±»å‹å¯¹æ¯”ï¼ˆTool/Model/Extensionï¼‰
     - é…ç½®ä¸æ‰“åŒ…æ ¼å¼
     - å®‰å…¨ä¸éš”ç¦»æœºåˆ¶
     - å…³é”®å¯ç¤ºä¸æ”¹è¿›å»ºè®®
     - å®æ–½è·¯çº¿å›¾ï¼ˆ1-12ä¸ªæœˆï¼‰
   - **å›¾è¡¨**ï¼š
     - è¿è¡Œæ—¶é€‰æ‹©æµç¨‹å›¾
     - Subprocess é€šä¿¡æ—¶åºå›¾
     - æƒé™æ£€æŸ¥æµç¨‹å›¾
     - å®‰å…¨ç­–ç•¥å†³ç­–æ ‘
     - åå‘è°ƒç”¨æ—¶åºå›¾
     - Subprocess æ¨¡å¼ä¸‹çš„åå‘è°ƒç”¨æ¶æ„

## ğŸ¯ ç›®æ ‡æ€è®¾è®¡ç›®æ ‡ï¼ˆè®¾è®¡ä¸­ï¼‰

**æ ¸å¿ƒç›®æ ‡**ï¼šæ–°å¢ KB / Agent / Tool æ—¶ï¼Œåªéœ€ï¼š
1. âœ… ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆYAMLï¼‰
2. âœ… æ·»åŠ æ–°ä»£ç ï¼ˆä¸æ”¹æ—§ä»£ç ï¼‰
3. âœ… æ— éœ€é‡å¯æœåŠ¡ï¼ˆå¯é€‰ï¼Œé€šè¿‡ subprocess runtimeï¼‰

**è®¾è®¡åŸåˆ™**ï¼š
- **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **é…ç½®é©±åŠ¨**ï¼šä¸šåŠ¡è§„åˆ™å¤–ç½®åˆ°é…ç½®æ–‡ä»¶
- **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ Protocol + MyPy é™æ€æ£€æŸ¥
- **ä¸€æ¬¡æ€§åˆ‡æ¢**ï¼šç§»é™¤ç¡¬ç¼–ç ï¼Œä¸ä¿ç•™å…¼å®¹å±‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### å½“å‰æ‰©å±•ç‚¹ï¼ˆå·²å®ç°ï¼Œä»£ç ä¸ºå‡†ï¼‰

```
backend/
â”œâ”€â”€ graphrag_agent/
â”‚   â”œâ”€â”€ agents/                             # Agent å®ç°
â”‚   â””â”€â”€ search/
â”‚       â””â”€â”€ tool_registry.py                # Tool æ³¨å†Œè¡¨ï¼ˆLazyToolFactoryï¼‰
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ agents/rag_factory/
â”‚   â”‚   â””â”€â”€ factory.py                      # Agent å·¥å‚ï¼ˆagent_type -> Agent ç±»æ˜ å°„ï¼‰
â”‚   â””â”€â”€ routing/
â”‚       â”œâ”€â”€ types.py                        # KBPrefixï¼ˆLiteral: movie/edu/generalï¼‰
â”‚       â””â”€â”€ kb_router/
â”‚           â”œâ”€â”€ router.py                   # KB è·¯ç”±ï¼ˆheuristic -> LLMï¼‰
â”‚           â””â”€â”€ heuristics.py               # heuristic è§„åˆ™ï¼ˆä» YAML è¯»å–å…³é”®è¯ï¼‰
â””â”€â”€ domain/
    â””â”€â”€ config/
        â”œâ”€â”€ kb_routing.py                   # è§„åˆ™åŠ è½½ï¼ˆæ”¯æŒ env æŒ‡å®šè·¯å¾„/çƒ­åŠ è½½ï¼‰
        â””â”€â”€ kb_routing.yaml                 # å…³é”®è¯è§„åˆ™ï¼ˆedu/movieï¼‰
```

### ç›®æ ‡æ€ï¼ˆè®¾è®¡ä¸­ï¼Œæ–‡æ¡£ä¸­çš„å»ºè®®ç»“æ„ï¼‰

```
backend/
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ plugin_system/              # âœ… æ–°å¢ï¼šæ’ä»¶ç³»ç»Ÿæ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ protocols/              # Protocol å®šä¹‰ï¼ˆç±»å‹å®‰å…¨ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ kb_protocol.py
â”‚   â”‚   â”‚   â”œâ”€â”€ agent_protocol.py
â”‚   â”‚   â”‚   â””â”€â”€ tool_protocol.py
â”‚   â”‚   â”œâ”€â”€ registry/               # æ³¨å†Œä¸­å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ base_registry.py
â”‚   â”‚   â”‚   â”œâ”€â”€ kb_registry.py
â”‚   â”‚   â”‚   â”œâ”€â”€ agent_registry.py
â”‚   â”‚   â”‚   â””â”€â”€ tool_registry.py
â”‚   â”‚   â”œâ”€â”€ loader/                 # åŠ¨æ€åŠ è½½å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ config_loader.py
â”‚   â”‚   â”‚   â””â”€â”€ class_loader.py
â”‚   â”‚   â”œâ”€â”€ runtime/                # è¿è¡Œæ—¶ï¼ˆMVPï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ subprocess_runtime.py
â”‚   â”‚   â””â”€â”€ config/
â”‚   â”‚       â””â”€â”€ config_manager.py
â”‚   â”‚
â”‚   â”œâ”€â”€ routing/                    # âœ… é‡æ„ï¼šç§»é™¤ç¡¬ç¼–ç 
â”‚   â””â”€â”€ agents/                     # âœ… é‡æ„ï¼šä½¿ç”¨ Registry
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ plugins/                    # âœ… æ–°å¢ï¼šæ’ä»¶é…ç½®ç›®å½•
â”‚       â”œâ”€â”€ knowledge_bases.yaml
â”‚       â”œâ”€â”€ agents.yaml
â”‚       â””â”€â”€ tools.yaml
â”‚
â””â”€â”€ plugins/                        # âœ… æ–°å¢ï¼šæ’ä»¶ä»£ç ç›®å½•
    â””â”€â”€ <custom_plugins>/
```

## ğŸ“‹ ç›®æ ‡æ€ MVP èŒƒå›´ï¼ˆè®¾è®¡ä¸­ï¼‰

**åŒ…å«**ï¼š
- âœ… é…ç½®é©±åŠ¨ï¼ˆKB/Agent/Toolï¼‰+ Registry + åŠ¨æ€åŠ è½½
- âœ… Router / Factory / ToolRegistry å…¨é¢æ”¹ä¸º Registry
- âœ… é…ç½®çƒ­åŠ è½½ï¼ˆä»… YAMLï¼‰
- âœ… å­è¿›ç¨‹æ’ä»¶è¿è¡Œæ—¶ï¼ˆTool/Agent å¯é€‰å¯ç”¨ï¼‰
- âœ… åŸºç¡€è¶…æ—¶ä¸é”™è¯¯éš”ç¦»

**ä¸åŒ…å«**ï¼ˆéç›®æ ‡ï¼‰ï¼š
- âŒ æ’ä»¶å¸‚åœº / è¿œç¨‹ä»“åº“ / åŒ…ç­¾å
- âŒ Docker / Serverless è¿è¡Œæ—¶
- âŒ ç»†ç²’åº¦æƒé™ç³»ç»Ÿä¸ä¾èµ–éš”ç¦»

## âœ… å½“å‰æ‰©å±•ç‚¹ï¼ˆå·²å®ç°ï¼‰

### 1. è°ƒæ•´/æ‰©å±• KB è·¯ç”±å…³é”®è¯ï¼ˆheuristicï¼‰

ä¿®æ”¹ `backend/domain/config/kb_routing.yaml`ï¼ˆæˆ–é€šè¿‡ç¯å¢ƒå˜é‡ `KB_ROUTING_RULES_PATH` æŒ‡å‘è‡ªå®šä¹‰æ–‡ä»¶ï¼‰ï¼š

```yaml
heuristic_rules:
  min_score: 2
  kbs:
    edu:
      keywords: ["å­¦ç”Ÿ", "è¯¾ç¨‹"]
    movie:
      keywords: ["ç”µå½±", "å¯¼æ¼”"]
```

æ³¨æ„ï¼š
- å½“å‰ `KBPrefix` ä»åœ¨ `backend/infrastructure/routing/types.py` é‡Œä»¥ `Literal["movie","edu","general"]` æ–¹å¼ç¡¬ç¼–ç ï¼›è‹¥è¦çœŸæ­£æ–°å¢ KBï¼ˆä¾‹å¦‚ financeï¼‰ï¼Œä»éœ€è¦åŒæ­¥ä¿®æ”¹ç›¸å…³ç±»å‹/è·¯ç”±é€»è¾‘ã€‚
- è‹¥å¸Œæœ›è·¯ç”±è§„åˆ™å˜æ›´æ— éœ€é‡å¯ï¼Œå¯è®¾ç½® `KB_ROUTING_RULES_RELOAD=1`ï¼ˆæ¯æ¬¡è°ƒç”¨æ—¶å¼ºåˆ¶é‡è½½ï¼‰ã€‚

### 2. æ–°å¢å·¥å…·ï¼ˆToolï¼‰

åœ¨ `backend/graphrag_agent/search/tool/` ä¸‹å®ç°å·¥å…·ç±»ï¼Œç„¶åæŠŠå®ƒæ³¨å†Œåˆ° `backend/graphrag_agent/search/tool_registry.py` çš„ `TOOL_REGISTRY`ï¼ˆæˆ– `EXTRA_TOOL_FACTORIES`ï¼‰ä¸­ï¼š

```python
# backend/graphrag_agent/search/tool_registry.py
TOOL_REGISTRY["finance_search"] = LazyToolFactory(
    "graphrag_agent.search.tool.finance_search_tool", "FinanceSearchTool"
)
```

### 3. æ–°å¢ä»£ç†ï¼ˆAgentï¼‰

åœ¨ `backend/graphrag_agent/agents/` ä¸‹å®ç° Agentï¼Œç„¶ååœ¨ `backend/infrastructure/agents/rag_factory/factory.py` çš„ `agent_classes` æ˜ å°„ä¸­æ–°å¢ `agent_type -> Agent ç±»`ï¼š

```python
# backend/infrastructure/agents/rag_factory/factory.pyï¼ˆç¤ºæ„ï¼‰
agent_classes["finance_agent"] = FinanceAgent
```

### 4. Worker å‘½åçº¦å®š

Router-Worker çš„ worker åç§°æ ¼å¼ä¸º `{kb_prefix}:{agent_type}`ï¼Œè§£æé€»è¾‘åœ¨ `backend/infrastructure/routing/orchestrator/worker_registry.py`ã€‚

## ğŸš€ ç›®æ ‡æ€å¿«é€Ÿå¼€å§‹ï¼ˆè®¾è®¡ä¸­ï¼‰

å¦‚æœä½ å¸Œæœ›æŒ‰â€œé…ç½®é©±åŠ¨æ’ä»¶ç³»ç»Ÿï¼ˆYAML + åŠ¨æ€åŠ è½½ï¼‰â€çš„ç›®æ ‡æ€æ¥æ‰©å±•ï¼Œè¯·ç›´æ¥é˜…è¯»ï¼š
- ã€Šå¯é…ç½®æ’ä»¶æ¶æ„è®¾è®¡æ–‡æ¡£ã€‹ï¼š`docs/07-æ’ä»¶ç³»ç»Ÿ/CONFIGURABLE_PLUGIN_ARCHITECTURE.md`

## ğŸ“– å­¦ä¹ è·¯å¾„

å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºé˜…è¯»æ–‡æ¡£ï¼š

1. **å¿«é€Ÿäº†è§£**ï¼šå…ˆè¯»ã€Šå¯é…ç½®æ’ä»¶æ¶æ„è®¾è®¡æ–‡æ¡£ã€‹çš„ Section 1-3ï¼ˆèƒŒæ™¯ã€é—®é¢˜ã€æ¶æ„ï¼‰
2. **å¯¹æ¯”å­¦ä¹ **ï¼šé˜…è¯»ã€ŠDify å¯¹æ¯”åˆ†æã€‹äº†è§£ä¸šç•Œæœ€ä½³å®è·µ
3. **æ·±å…¥å®ç°**ï¼šå›åˆ°ã€Šå¯é…ç½®æ’ä»¶æ¶æ„è®¾è®¡æ–‡æ¡£ã€‹çš„ Section 4-7ï¼ˆæ ¸å¿ƒç»„ä»¶ã€é…ç½®æ ¼å¼ã€ç¤ºä¾‹ä»£ç ï¼‰
4. **å®æ–½è§„åˆ’**ï¼šé˜…è¯» Section 6ï¼ˆå®æ–½è®¡åˆ’ï¼‰å’Œ Section 8ï¼ˆè¿ç§»æŒ‡å—ï¼‰

## ğŸ”— ç›¸å…³èµ„æº

**å¤–éƒ¨å‚è€ƒ**ï¼š
- [Dify Plugin System å®˜æ–¹æ–‡æ¡£](https://docs.dify.ai/en/plugins)
- [LangChain Tools æ–‡æ¡£](https://python.langchain.com/docs/modules/agents/tools/)
- [Python Protocol (PEP 544)](https://peps.python.org/pep-0544/)

**é¡¹ç›®å†…æ–‡æ¡£**ï¼š
- [04-å¼€å‘æŒ‡å—/æ·»åŠ æ–°Agent.md](../04-å¼€å‘æŒ‡å—/æ·»åŠ æ–°Agent.md) - Agent å¼€å‘æŒ‡å—
- [04-å¼€å‘æŒ‡å—/æ‰©å±•æœç´¢ç­–ç•¥.md](../04-å¼€å‘æŒ‡å—/æ‰©å±•æœç´¢ç­–ç•¥.md) - æœç´¢å·¥å…·å¼€å‘

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ–‡æ¡£ | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| 3.0.0 | 2026-01-17 | å¯é…ç½®æ’ä»¶æ¶æ„è®¾è®¡æ–‡æ¡£ | åˆç‰ˆï¼šå®Œæ•´æ¶æ„è®¾è®¡ + å›¾è¡¨ |
| 1.0.0 | 2026-01-17 | Dify æ’ä»¶ç³»ç»Ÿå¯¹æ¯”åˆ†æ | åˆç‰ˆï¼šDify å¯¹æ¯”åˆ†æ + å›¾è¡¨ |

## ğŸ¤ è´¡çŒ®

å¦‚éœ€æ”¹è¿›æ’ä»¶ç³»ç»Ÿè®¾è®¡æˆ–æ·»åŠ æ–°åŠŸèƒ½ï¼Œè¯·ï¼š
1. é˜…è¯»å®Œæ•´è®¾è®¡æ–‡æ¡£
2. éµå¾ªè®¾è®¡åŸåˆ™å’Œæœ€ä½³å®è·µ
3. æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œå›¾è¡¨
4. æäº¤ PR å¹¶è¯´æ˜æ”¹åŠ¨ç†ç”±

---

**æœ€åæ›´æ–°**: 2026-01-18
**ç»´æŠ¤å›¢é˜Ÿ**: GraphRAG Team
