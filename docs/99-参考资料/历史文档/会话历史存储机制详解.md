# ä¼šè¯å†å²å­˜å‚¨æœºåˆ¶è¯¦è§£

**æ–‡ä»¶ä½ç½®**: `backend/graphrag_agent/agents/base.py`

---

## ğŸ¯ æ ¸å¿ƒå›ç­”

**ä¼šè¯å†å²å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ**

ç­”ï¼šå­˜å‚¨åœ¨ **å†…å­˜ä¸­**ï¼Œä½¿ç”¨ LangGraph çš„ `MemorySaver()` ç»„ä»¶ã€‚

---

## ğŸ“Š å­˜å‚¨æ¶æ„å›¾

```
ç”¨æˆ·è¯·æ±‚ (session_id="abc123")
    â”‚
    â–¼
BaseAgent.ask(query, thread_id="abc123")
    â”‚
    â–¼
config = {"configurable": {"thread_id": "abc123"}}
    â”‚
    â–¼
graph.stream(inputs, config=config)
    â”‚
    â–¼
ã€MemorySaver å­˜å‚¨ç»“æ„ã€‘
{
    "abc123": {  â† thread_id ä½œä¸ºé”®
        "channel_values": {
            "messages": [
                HumanMessage("ç”¨æˆ·é—®é¢˜ 1"),
                AIMessage("", tool_calls=[...]),
                ToolMessage("æ£€ç´¢ç»“æœ"),
                AIMessage("å›ç­” 1"),
                HumanMessage("ç”¨æˆ·é—®é¢˜ 2"),
                AIMessage("å›ç­” 2"),
                ...
            ]
        }
    },
    "xyz456": {  â† å¦ä¸€ä¸ªä¼šè¯
        "channel_values": { ... }
    }
}
```

---

## ğŸ” è¯¦ç»†å®ç°åˆ†æ

### 1. åˆå§‹åŒ– - MemorySaver åˆ›å»º

**ä½ç½®**: `backend/graphrag_agent/agents/base.py:41`

```python
class BaseAgent(ABC):
    def __init__(self, cache_dir="./cache", memory_only=False):
        # ... å…¶ä»–åˆå§‹åŒ– ...

        # ğŸ”‘ å…³é”®ï¼šåˆ›å»ºå†…å­˜å­˜å‚¨å™¨
        self.memory = MemorySaver()

        # MemorySaver æ˜¯ LangGraph æä¾›çš„æ£€æŸ¥ç‚¹å­˜å‚¨å™¨
        # ä½œç”¨ï¼š
        #   1. ä¿å­˜å·¥ä½œæµçš„æ‰€æœ‰çŠ¶æ€ï¼ˆåŒ…æ‹¬æ¶ˆæ¯å†å²ï¼‰
        #   2. æ”¯æŒå¤šè½®å¯¹è¯
        #   3. æ”¯æŒä¸­æ–­åæ¢å¤
        #   4. é€šè¿‡ thread_id éš”ç¦»ä¸åŒä¼šè¯
```

**MemorySaver çš„åº•å±‚å®ç°**:

```python
# LangGraph æºç ç®€åŒ–ç‰ˆ
from collections import defaultdict
from typing import Any, Dict

class MemorySaver:
    """å†…å­˜ä¸­çš„æ£€æŸ¥ç‚¹å­˜å‚¨å™¨"""

    def __init__(self):
        # ä½¿ç”¨ defaultdict å­˜å‚¨æ‰€æœ‰ä¼šè¯çš„æ£€æŸ¥ç‚¹
        self.storage: Dict[str, Dict[str, Any]] = defaultdict(dict)

    def put(self, config: Dict, checkpoint: Dict) -> None:
        """ä¿å­˜æ£€æŸ¥ç‚¹"""
        thread_id = config["configurable"]["thread_id"]
        self.storage[thread_id] = checkpoint

    def get(self, config: Dict) -> Dict:
        """è·å–æ£€æŸ¥ç‚¹"""
        thread_id = config["configurable"]["thread_id"]
        return self.storage.get(thread_id)
```

---

### 2. ç¼–è¯‘æ—¶ç»‘å®š - Graph ä¸ Memory å…³è”

**ä½ç½®**: `backend/graphrag_agent/agents/base.py:282`

```python
def _setup_graph(self):
    """æ„å»º LangGraph å·¥ä½œæµ"""
    workflow = StateGraph(AgentState)

    # ... æ·»åŠ èŠ‚ç‚¹å’Œè¾¹ ...

    # ğŸ”‘ å…³é”®ï¼šç¼–è¯‘æ—¶å°† MemorySaver ç»‘å®šåˆ°å›¾
    self.graph = workflow.compile(checkpointer=self.memory)

    """
    checkpointer å‚æ•°çš„ä½œç”¨:
        1. æ¯æ¬¡æ‰§è¡ŒèŠ‚ç‚¹åï¼Œè‡ªåŠ¨ä¿å­˜çŠ¶æ€åˆ° memory
        2. ä¸‹æ¬¡è°ƒç”¨æ—¶ï¼Œè‡ªåŠ¨åŠ è½½å†å²çŠ¶æ€
        3. å®ç°å¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¿æŒ
    """
```

**ç¼–è¯‘åçš„æ•ˆæœ**:

```python
# ç¼–è¯‘åï¼Œgraph å¯¹è±¡æ”¯æŒä»¥ä¸‹æ“ä½œï¼š
graph.invoke(inputs, config)     # æ‰§è¡Œå¹¶è‡ªåŠ¨ä¿å­˜çŠ¶æ€
graph.stream(inputs, config)     # æµå¼æ‰§è¡Œå¹¶ä¿å­˜
graph.get_state(config)          # è·å–å½“å‰çŠ¶æ€
graph.update_state(config, ...)  # æ›´æ–°çŠ¶æ€
```

---

### 3. è°ƒç”¨æ—¶é…ç½® - thread_id éš”ç¦»

**ä½ç½®**: `backend/graphrag_agent/agents/base.py:899-904`

```python
def ask(self, query: str, thread_id: str = "default", recursion_limit: Optional[int] = None):
    """å‘ Agent æé—®"""

    # ğŸ”‘ å…³é”®ï¼šæ„å»ºé…ç½®ï¼ŒæŒ‡å®š thread_id
    config = {
        "configurable": {
            "thread_id": thread_id,         # â† ä¼šè¯éš”ç¦»é”®
            "recursion_limit": recursion_value
        }
    }

    # åˆ›å»ºè¾“å…¥æ¶ˆæ¯
    inputs = {"messages": [HumanMessage(content=query)]}

    # æ‰§è¡Œå›¾å·¥ä½œæµ
    for output in self.graph.stream(inputs, config=config):
        pass  # é€æ­¥æ‰§è¡Œ
```

**config çš„ä½œç”¨**:

```python
config = {"configurable": {"thread_id": "session_abc"}}

# æ‰§è¡Œæµç¨‹ï¼š
# 1. LangGraph è¯»å– thread_id = "session_abc"
# 2. ä» MemorySaver åŠ è½½è¯¥ä¼šè¯çš„å†å²æ¶ˆæ¯
# 3. å°†å†å²æ¶ˆæ¯å’Œæ–°æ¶ˆæ¯ä¸€èµ·å‘é€ç»™ LLM
# 4. æ‰§è¡Œå®Œæˆåï¼Œæ›´æ–°è¯¥ä¼šè¯çš„æ£€æŸ¥ç‚¹
```

---

### 4. è·å–å†å² - ä» Memory è¯»å–æ¶ˆæ¯

**ä½ç½®**: `backend/graphrag_agent/agents/base.py:911-912`

```python
# æ‰§è¡Œå®Œæˆåï¼Œè·å–å®Œæ•´çš„å¯¹è¯å†å²
chat_history = self.memory.get(config)["channel_values"]["messages"]
answer = chat_history[-1].content  # æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ AI çš„å›ç­”
```

**chat_history çš„ç»“æ„**:

```python
chat_history = [
    # ç¬¬ 1 è½®å¯¹è¯
    HumanMessage(content="æ—·è¯¾å¤šå°‘å­¦æ—¶ä¼šè¢«é€€å­¦ï¼Ÿ", id="msg_001"),
    AIMessage(content="", tool_calls=[...], id="msg_002"),  # å†³å®šè°ƒç”¨å·¥å…·
    ToolMessage(content="æ£€ç´¢ç»“æœ: ...", id="msg_003"),     # å·¥å…·è¿”å›
    AIMessage(content="æ ¹æ®è§„å®šï¼Œæ—·è¯¾ç´¯è®¡è¾¾åˆ°40å­¦æ—¶...", id="msg_004"),

    # ç¬¬ 2 è½®å¯¹è¯
    HumanMessage(content="é‚£å¤„åˆ†æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ", id="msg_005"),
    AIMessage(content="", tool_calls=[...], id="msg_006"),
    ToolMessage(content="æ£€ç´¢ç»“æœ: ...", id="msg_007"),
    AIMessage(content="å¤„åˆ†æµç¨‹åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤...", id="msg_008"),
]
```

---

## ğŸ”„ å®Œæ•´è°ƒç”¨æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·è¿›è¡Œå¤šè½®å¯¹è¯

```python
# ========== ç¬¬ 1 æ¬¡è¯·æ±‚ ==========
agent = HybridAgent()

# ç”¨æˆ· A çš„ç¬¬ 1 æ¬¡æé—®
answer1 = agent.ask("ä»€ä¹ˆæ˜¯ GraphRAGï¼Ÿ", thread_id="user_a")

# å†…éƒ¨æµç¨‹ï¼š
# 1. config = {"configurable": {"thread_id": "user_a"}}
# 2. memory.get(config) â†’ è¿”å› Noneï¼ˆé¦–æ¬¡å¯¹è¯ï¼‰
# 3. æ‰§è¡Œå·¥ä½œæµï¼Œè°ƒç”¨å·¥å…·ã€ç”Ÿæˆç­”æ¡ˆ
# 4. memory.put(config, checkpoint) â†’ ä¿å­˜æ¶ˆæ¯å†å²
#
# å†…å­˜çŠ¶æ€ï¼š
# memory.storage = {
#     "user_a": {
#         "channel_values": {
#             "messages": [
#                 HumanMessage("ä»€ä¹ˆæ˜¯ GraphRAGï¼Ÿ"),
#                 AIMessage("GraphRAG æ˜¯ä¸€ç§...")
#             ]
#         }
#     }
# }


# ========== ç¬¬ 2 æ¬¡è¯·æ±‚ ==========
# ç”¨æˆ· A çš„ç¬¬ 2 æ¬¡æé—®ï¼ˆåˆ©ç”¨ä¸Šä¸‹æ–‡ï¼‰
answer2 = agent.ask("å®ƒæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ", thread_id="user_a")

# å†…éƒ¨æµç¨‹ï¼š
# 1. config = {"configurable": {"thread_id": "user_a"}}
# 2. memory.get(config) â†’ åŠ è½½å†å²æ¶ˆæ¯
# 3. LLM çœ‹åˆ°çš„è¾“å…¥ï¼š
#    [
#        HumanMessage("ä»€ä¹ˆæ˜¯ GraphRAGï¼Ÿ"),
#        AIMessage("GraphRAG æ˜¯ä¸€ç§..."),
#        HumanMessage("å®ƒæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ")  â† æ–°é—®é¢˜
#    ]
# 4. LLM ç†è§£"å®ƒ"æŒ‡çš„æ˜¯ GraphRAG
# 5. æ‰§è¡Œå®Œæˆåæ›´æ–°å†…å­˜
#
# å†…å­˜çŠ¶æ€ï¼š
# memory.storage = {
#     "user_a": {
#         "channel_values": {
#             "messages": [
#                 HumanMessage("ä»€ä¹ˆæ˜¯ GraphRAGï¼Ÿ"),
#                 AIMessage("GraphRAG æ˜¯ä¸€ç§..."),
#                 HumanMessage("å®ƒæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ"),
#                 AIMessage("ä¼˜åŠ¿åŒ…æ‹¬ï¼š1. å®ä½“çº§æ£€ç´¢...")
#             ]
#         }
#     }
# }


# ========== å¹¶å‘è¯·æ±‚ ==========
# ç”¨æˆ· B åŒæ—¶æé—®ï¼ˆä¸åŒä¼šè¯ï¼‰
answer3 = agent.ask("æ¨èç”µå½±", thread_id="user_b")

# å†…å­˜çŠ¶æ€ï¼š
# memory.storage = {
#     "user_a": {  â† ç”¨æˆ· A çš„å†å²
#         "channel_values": { ... }
#     },
#     "user_b": {  â† ç”¨æˆ· B çš„å†å²
#         "channel_values": {
#             "messages": [
#                 HumanMessage("æ¨èç”µå½±"),
#                 AIMessage("è¿™é‡Œæœ‰ä¸€äº›ç”µå½±æ¨è...")
#             ]
#         }
#     }
# }
```

---

## ğŸ” ä¼šè¯éš”ç¦»æœºåˆ¶

### 1. thread_id ä½œä¸ºéš”ç¦»é”®

```python
# ç”¨æˆ· A çš„ä¼šè¯
agent.ask("é—®é¢˜ 1", thread_id="user_a")

# ç”¨æˆ· B çš„ä¼šè¯
agent.ask("é—®é¢˜ 1", thread_id="user_b")

# å†…å­˜ä¸­çš„å­˜å‚¨ï¼š
memory.storage = {
    "user_a": { ... },  # â† å®Œå…¨ç‹¬ç«‹
    "user_b": { ... },  # â† å®Œå…¨ç‹¬ç«‹
}
```

### 2. ä¸ AgentManager å®ä¾‹æ± çš„é…åˆ

```python
# backend/application/services/agent_service.py

class AgentManager:
    def get_agent(self, agent_type: str, session_id: str):
        instance_key = f"{agent_type}:{session_id}"

        # å®ä¾‹æ± ï¼šæ¯ä¸ªä¼šè¯æœ‰ç‹¬ç«‹çš„ Agent å®ä¾‹
        agent_instances = {
            "hybrid_agent:user_a": <HybridAgent A>,  # â† ç‹¬ç«‹çš„ memory
            "hybrid_agent:user_b": <HybridAgent B>,  # â† ç‹¬ç«‹çš„ memory
        }
```

**ä¸¤å±‚éš”ç¦»**:

```
ã€ç¬¬ 1 å±‚ã€‘AgentManager å®ä¾‹æ± 
    â”œâ”€ "hybrid_agent:user_a" â†’ Agent A (memory A)
    â””â”€ "hybrid_agent:user_b" â†’ Agent B (memory B)

ã€ç¬¬ 2 å±‚ã€‘MemorySaver å†…éƒ¨å­˜å‚¨
    Agent A çš„ memory:
        â”œâ”€ "user_a" â†’ ä¼šè¯ A çš„æ¶ˆæ¯å†å²

    Agent B çš„ memory:
        â”œâ”€ "user_b" â†’ ä¼šè¯ B çš„æ¶ˆæ¯å†å²
```

---

## âš ï¸ é‡è¦ç‰¹æ€§ä¸é™åˆ¶

### âœ… ä¼˜åŠ¿

1. **å¿«é€Ÿ**: çº¯å†…å­˜å­˜å‚¨ï¼Œè¯»å†™é€Ÿåº¦æå¿«
2. **ç®€å•**: æ— éœ€é…ç½®æ•°æ®åº“
3. **éš”ç¦»**: thread_id å¤©ç„¶éš”ç¦»ä¸åŒä¼šè¯
4. **è‡ªåŠ¨**: LangGraph è‡ªåŠ¨ç®¡ç†ä¿å­˜å’ŒåŠ è½½

### âŒ é™åˆ¶

1. **éæŒä¹…åŒ–**: æœåŠ¡é‡å¯åæ‰€æœ‰å†å²ä¸¢å¤±
2. **å†…å­˜å ç”¨**: ä¼šè¯å¤šæ—¶å ç”¨å¤§é‡å†…å­˜
3. **æ— å¤‡ä»½**: æ²¡æœ‰æŒä¹…åŒ–å¤‡ä»½æœºåˆ¶
4. **å•æœºé™åˆ¶**: æ— æ³•è·¨æœåŠ¡å™¨å…±äº«

### âš ï¸ LangGraph å®˜æ–¹è­¦å‘Š

```python
# LangGraph æ–‡æ¡£åŸæ–‡
"""
âš ï¸ WARNING: InMemorySaver (MemorySaver) is only for debugging or testing purposes.

For production use cases, we recommend using one of the following:
    - PostgresSaver: PostgreSQL database backend
    - SqliteSaver: SQLite database backend
    - Custom: Implement your own checkpointer
"""
```

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### æ–¹æ¡ˆ 1: ä½¿ç”¨ PostgresSaverï¼ˆæ¨èï¼‰

```python
from langgraph.checkpoint.postgres import PostgresSaver

class BaseAgent(ABC):
    def __init__(self):
        # ä½¿ç”¨ PostgreSQL æŒä¹…åŒ–å­˜å‚¨
        self.memory = PostgresSaver(
            conn_string="postgresql://user:password@localhost:5432/graphrag"
        )

        # ... å…¶ä»–åˆå§‹åŒ– ...
```

**ä¼˜åŠ¿**:
- âœ… æŒä¹…åŒ–å­˜å‚¨ï¼ˆæœåŠ¡é‡å¯ä¸ä¸¢å¤±ï¼‰
- âœ… æ”¯æŒåˆ†å¸ƒå¼ï¼ˆå¤šæœåŠ¡å™¨å…±äº«ï¼‰
- âœ… å¯å¤‡ä»½ã€å¯æ¢å¤
- âœ… æ”¯æŒå†å²æŸ¥è¯¢

### æ–¹æ¡ˆ 2: ä½¿ç”¨ Redis + è¿‡æœŸç­–ç•¥

```python
from langgraph.checkpoint.redis import RedisSaver

class BaseAgent(ABC):
    def __init__(self):
        self.memory = RedisSaver(
            redis_url="redis://localhost:6379/0",
            ttl=3600  # 1 å°æ—¶è¿‡æœŸ
        )
```

**ä¼˜åŠ¿**:
- âœ… é«˜æ€§èƒ½ï¼ˆæ¥è¿‘å†…å­˜é€Ÿåº¦ï¼‰
- âœ… è‡ªåŠ¨è¿‡æœŸæ¸…ç†
- âœ… æ”¯æŒåˆ†å¸ƒå¼
- âœ… å‡å°‘å†…å­˜å ç”¨

### æ–¹æ¡ˆ 3: æ··åˆç­–ç•¥

```python
class BaseAgent(ABC):
    def __init__(self):
        # L1: å†…å­˜ç¼“å­˜ï¼ˆçƒ­æ•°æ®ï¼‰
        self.hot_memory = MemorySaver()

        # L2: Redis ç¼“å­˜ï¼ˆæ¸©æ•°æ®ï¼‰
        self.warm_memory = RedisSaver(...)

        # L3: PostgreSQL æŒä¹…åŒ–ï¼ˆå†·æ•°æ®ï¼‰
        self.cold_memory = PostgresSaver(...)

    def _get_history(self, config):
        # å…ˆæŸ¥å†…å­˜ â†’ å†æŸ¥ Redis â†’ æœ€åæŸ¥æ•°æ®åº“
        return (
            self.hot_memory.get(config) or
            self.warm_memory.get(config) or
            self.cold_memory.get(config)
        )
```

---

## ğŸ“ æ¸…é™¤å†å²æœºåˆ¶

### AgentManager.clear_history() æ–¹æ³•

**ä½ç½®**: `backend/application/services/agent_service.py`

```python
def clear_history(self, session_id: str) -> Dict:
    """æ¸…é™¤ç‰¹å®šä¼šè¯çš„èŠå¤©å†å²"""

    with self.agent_lock:
        for agent_type in self.agent_classes.keys():
            instance_key = f"{agent_type}:{session_id}"

            if instance_key in self.agent_instances:
                agent = self.agent_instances[instance_key]
                config = {"configurable": {"thread_id": session_id}}

                # 1. è·å–å†…å­˜ä¸­çš„æ¶ˆæ¯å†å²
                memory_content = agent.memory.get(config)
                if memory_content is None:
                    continue

                messages = memory_content["channel_values"]["messages"]

                # 2. åˆ é™¤æ¶ˆæ¯ï¼ˆä¿ç•™å‰ 2 æ¡ï¼Œé€šå¸¸æ˜¯ç³»ç»Ÿæç¤ºï¼‰
                for message in reversed(messages):
                    if len(messages) <= 2:
                        break

                    # ä½¿ç”¨ LangGraph çš„ RemoveMessage æœºåˆ¶
                    agent.graph.update_state(
                        config,
                        {"messages": RemoveMessage(id=message.id)}
                    )

    return {"status": "success", "remaining_messages": "å·²æ¸…é™¤ä¼šè¯å†å²"}
```

**å·¥ä½œåŸç†**:

```python
# æ¸…é™¤å‰
messages = [
    SystemMessage("ç³»ç»Ÿæç¤º"),          # ä¿ç•™
    AIMessage("æ¬¢è¿ä½¿ç”¨"),               # ä¿ç•™
    HumanMessage("é—®é¢˜ 1"),              # åˆ é™¤
    AIMessage("å›ç­” 1"),                 # åˆ é™¤
    HumanMessage("é—®é¢˜ 2"),              # åˆ é™¤
    AIMessage("å›ç­” 2"),                 # åˆ é™¤
]

# è°ƒç”¨ clear_history(session_id="abc")

# æ¸…é™¤å
messages = [
    SystemMessage("ç³»ç»Ÿæç¤º"),          # âœ… ä¿ç•™
    AIMessage("æ¬¢è¿ä½¿ç”¨"),               # âœ… ä¿ç•™
]
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å­˜å‚¨ä½ç½®**: `self.memory = MemorySaver()` (çº¯å†…å­˜)
2. **å­˜å‚¨æ—¶æœº**: æ¯æ¬¡ `graph.stream()` æ‰§è¡Œåè‡ªåŠ¨ä¿å­˜
3. **éš”ç¦»æœºåˆ¶**: `thread_id` ä½œä¸ºé”®éš”ç¦»ä¸åŒä¼šè¯
4. **æ•°æ®ç»“æ„**: `messages` åˆ—è¡¨åŒ…å«æ‰€æœ‰å¯¹è¯æ¶ˆæ¯
5. **è·å–æ–¹å¼**: `memory.get(config)["channel_values"]["messages"]`

### å…³é”®ä»£ç ä½ç½®

| ä½ç½® | æ–‡ä»¶ | è¡Œå· | è¯´æ˜ |
|------|------|------|------|
| åˆå§‹åŒ– | `backend/graphrag_agent/agents/base.py` | 41 | `self.memory = MemorySaver()` |
| ç¼–è¯‘ç»‘å®š | `backend/graphrag_agent/agents/base.py` | 282 | `workflow.compile(checkpointer=self.memory)` |
| é…ç½®ä¼ é€’ | `backend/graphrag_agent/agents/base.py` | 899-904 | `config = {"configurable": {"thread_id": ...}}` |
| è·å–å†å² | `backend/graphrag_agent/agents/base.py` | 911 | `memory.get(config)["channel_values"]["messages"]` |
| æ¸…é™¤å†å² | `backend/application/services/agent_service.py` | 58-85 | `clear_history()` æ–¹æ³• |

### ç”Ÿäº§ç¯å¢ƒè¿ç§»è·¯å¾„

```
ã€å½“å‰ã€‘MemorySaver (å†…å­˜)
    â†“
ã€è¿‡æ¸¡ã€‘RedisSaver (Redis + TTL)
    â†“
ã€ç”Ÿäº§ã€‘PostgresSaver (PostgreSQL)
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-29
**ä½œè€…**: Claude Code
**ç›¸å…³æ–‡æ¡£**:
- `docs/Chatå·¥ä½œå°å®Œæ•´è°ƒç”¨æµç¨‹.md`
- `docs/AgentManagerç±»åŠŸèƒ½åˆ†æ.md`
