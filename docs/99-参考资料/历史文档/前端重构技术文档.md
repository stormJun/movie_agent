# 前端重构技术文档：Streamlit → React 后台管理框架

> 注意：本文基于旧版接口与 legacy 服务（`backend/application/services/chat_service.py` 等），当前已下线；仅供历史参考。

## 1. 背景与目标

当前项目前端位于 `frontend/`，使用 **Streamlit**（Python）实现聊天界面与调试面板；后端位于 `backend/server/`，使用 **FastAPI** 提供聊天、流式输出（SSE）、知识图谱查询/推理、实体关系管理（CRUD）、源内容获取、反馈上报等接口。

本次重构目标是将前端替换为 **React 后台管理框架（Admin Console）**，实现：

1. **功能不降级（Feature Parity）**：覆盖现有 Streamlit 的核心能力（聊天、Agent 选择、流式输出、调试查看、图谱可视化、图谱管理、源内容查看、性能统计/基础可观测）。
2. **工程化与可维护**：前后端解耦、组件化、类型化（TypeScript）、可测试、可部署。
3. **可扩展为“电影推荐系统控制台”**：后续支持更多数据集、图谱重建、评估看板等模块的扩展。

---

## 2. 现状盘点

### 2.1 现有前端（Streamlit）主要功能

入口：`frontend/app.py`

- 聊天界面：发送消息、渲染回答、支持多 Agent 选择
- 流式输出：`POST /api/v1/chat/stream`（SSE），非调试模式下开启
- 会话与状态：前端生成 `session_id`（UUID），维护聊天历史；为避免重复提交，存在“处理锁/强制重置处理状态”
- 调试模式（debug_mode）：
  - 执行轨迹（execution_log / deep research 迭代信息）
  - 知识图谱可视化（回答相关图谱、全局图谱、推理问答）
  - 源内容查看（source content）
  - 知识图谱管理（实体/关系 CRUD）
  - 性能统计（前端侧 API 调用耗时统计）
- 反馈：对每条回答提供 👍/👎，提交 `POST /feedback`（并展示后端返回的 action 提示）
- 侧边栏示例问题：展示示例问题列表（当前为展示态，不会自动填充到输入框）
- 清理能力：一键清除对话历史（`/clear` + 前端 session_state 重置）

### 2.2 现有后端接口（FastAPI）

聊天：

- `POST /api/v1/chat`：返回 `ChatResponse`
- `POST /api/v1/chat/stream`：SSE 流式返回（注意是 **POST + text/event-stream**）
- `POST /clear`：清空会话

知识图谱：

- `GET /knowledge_graph`、`GET /knowledge_graph_from_message`
- `POST /kg_reasoning`（最短路径/多跳/社区/影响力等推理）
- `GET /entity_types`、`GET /relation_types`
- `POST /entities/search`、`POST /relations/search`
- `POST /entity/create|update|delete`、`POST /relation/create|update|delete`

源内容：

- `POST /source`、`POST /source_info`
- `POST /content_batch`、`POST /source_info_batch`

反馈：

- `POST /feedback`

### 2.3 现状痛点（促使重构）

- Streamlit 偏“单页脚本式 UI”，难以进行复杂交互与前端工程化扩展（权限、路由、复杂表格、图谱交互、多人并发会话等）。
- 浏览器侧可控性不足（路由/缓存/状态/组件复用）。
- 后台管理能力（实体/关系 CRUD、图谱推理工具）更适合用 React Admin 体系实现。

---

## 3. 重构后的目标形态

### 3.1 形态与定位

- 新前端为 **React SPA**（Single Page Application），提供“电影推荐系统 GraphRAG 控制台”：
  - **Chat 工作台**：面向业务/产品/使用者
  - **图谱工作台**：探索、推理、可视化
  - **图谱管理**：实体/关系 CRUD（管理员）
  - **源内容/证据**：查看检索证据与 chunk/source
  - **运行与性能**：基础性能统计（可逐步接入更标准的可观测体系）

### 3.2 技术选型（建议基线）

> “React 后台管理框架”可理解为：统一布局（菜单/面包屑/多页路由）+ 标准 CRUD 表格/表单 + 权限控制能力。

推荐基线（工程可控、二次开发友好）：

- 构建：`Vite + React 18 + TypeScript`
- UI：`Ant Design` + `@ant-design/pro-components`（ProLayout/ProTable/ProForm）
- 路由：`react-router-dom`
- 数据请求：`axios`（标准 REST/JSON）+ `fetch`（SSE 流式）
- 数据缓存：`@tanstack/react-query`（查询缓存/重试/失效）
- 状态管理：`zustand`（会话、UI 偏好、debug 开关等轻量状态）
- Markdown：`react-markdown` + `remark-gfm` + `rehype-highlight`
- 图谱可视化：优先 `@antv/g6`（或 `cytoscape.js`，二选一）
- 质量保障：`eslint`/`prettier`、`vitest`、`playwright`（可选）

备选（更“框架化”但侵入更高）：

- `Ant Design Pro（UmiJS）`：更完整的企业后台方案，但与现有仓库的 Python 技术栈耦合较低，需接受其工程约束。
- `react-admin`：偏“数据驱动 CRUD”，适合标准 REST；但本项目 API 并非标准 REST resource，需要写 DataProvider 适配层。

---

## 4. 新前端信息架构（IA）与页面设计

### 4.1 路由建议

```
/api/v1/chat
/graph/explore
/graph/reasoning
/graph/manage/entities
/graph/manage/relations
/sources/chunks
/sources/source/:sourceId
/settings
```

### 4.2 页面与功能映射

1) Chat 工作台（/api/v1/chat）
- 输入框、消息列表、Markdown 渲染
- Agent 选择：`graph_agent | hybrid_agent | naive_rag_agent | deep_research_agent | fusion_agent`
- 调试开关：debug 模式下展示“执行轨迹/图谱/源内容/性能”
- 流式输出：默认启用；调试模式可强制切换为非流式（对齐现状）
- 反馈按钮：👍/👎 调 `POST /feedback`
- DeepResearch 专项开关：`show_thinking`（显示推理过程）、`use_deeper_tool`（增强版研究工具）
- Fusion 专项开关：`use_chain_exploration`（链式探索）
- 示例问题：展示示例问题列表（可选增强：点击后自动填入输入框）
- 清空对话：清理会话（前端 + 后端 `/clear`）

2) 图谱探索（/graph/explore）
- 全局图谱：`GET /knowledge_graph?limit=...`
- “回答相关图谱”：调用 `GET /knowledge_graph_from_message?message=...`（或使用 `ChatResponse.kg_data`）
- 图谱交互：缩放、拖拽、节点 hover 提示、筛选类型、布局切换

3) 图谱推理（/graph/reasoning）
- 调用 `POST /kg_reasoning`：最短路径/多跳/共同邻居/社区/影响力等
- 输出：图谱可视化 + 结构化结果表格（节点/边列表）

4) 图谱管理（/graph/manage/*）
- 实体：搜索/创建/更新/删除（对齐后端 `/entity/*` 与 `/entities/search`）
- 关系：搜索/创建/更新/删除（对齐后端 `/relation/*` 与 `/relations/search`）
- 关键点：对“实体类型/关系类型”下拉框调用 `/entity_types`、`/relation_types`

5) 源内容与证据（/sources/*）
- chunk 列表：`GET /chunks?limit&offset`（用于调试/抽样检查）
- source 查看：`POST /source`、`POST /source_info`
- 批量接口：`/content_batch`、`/source_info_batch` 用于减少请求次数

6) 设置（/settings）
- API Base URL、默认 Agent、是否启用流式、图谱渲染参数等（持久化到 localStorage）

---

## 5. 前后端对接设计

### 5.1 API Base URL 与环境变量

建议使用 Vite 环境变量：

- `VITE_API_BASE_URL=http://localhost:8000`

并在生产环境通过 Nginx/网关统一域名（避免 CORS）。

### 5.2 CORS 与本地联调策略

当前后端未显式配置 CORS 中间件。推荐二选一：

1. **Vite dev proxy（推荐，零改后端）**  
   前端请求统一走 `/api`，由 Vite 代理到 FastAPI。
2. **后端加 CORS（生产更通用）**  
   在 FastAPI 中加入 `CORSMiddleware`（允许前端域名）。

### 5.3 Chat：请求/响应模型

`POST /api/v1/chat` 请求字段与 `backend/server/models/schemas.py:ChatRequest` 对齐：

- `message: string`
- `session_id: string`（前端生成并持久化）
- `debug: boolean`
- `agent_type: string`
- `use_deeper_tool?: boolean`
- `show_thinking?: boolean`
- `use_chain_exploration?: boolean`（fusion_agent）

响应 `ChatResponse`：

- `answer: string`
- `execution_log?: Array<object>`
- `kg_data?: { nodes: [], links: [] }`
- `reference?: object`
- `iterations?: Array<object>`

### 5.4 流式输出（关键）：POST + SSE 的浏览器实现

后端流式接口为 `POST /api/v1/chat/stream` 且 `text/event-stream`。浏览器原生 `EventSource` **不支持 POST**，因此前端需要实现“fetch + SSE 解析”。

建议实现一个 `postSSE(url, body, onMessage)` 工具：

- `fetch(url, { method: "POST", headers: { Accept: "text/event-stream", "Content-Type": "backend/application/json" }, body: JSON.stringify(body) })`
- 逐块读取 `ReadableStream`，按 `\n\n` 分帧，解析 `data: ...`
- 约定处理事件：`start | token | execution_log | execution_logs | done | error`（并兼容后端可能透传的其他 `status`）

### 5.5 性能统计

Streamlit 版本记录的是“前端 API 调用耗时”。React 版本建议：

- 对所有 API 请求做拦截计时（axios interceptor）
- 聚合到“性能面板”中：按 endpoint 统计 `count/avg/p95/max`
- 长期规划可接入 OpenTelemetry / Prometheus（后端已有性能装饰器雏形）

---

## 6. 前端工程结构（建议）

以 `frontend-react/` 作为新前端根目录（避免与现有 `frontend/` 冲突，便于并行开发与灰度切换）：

```
frontend-react/
  src/
    app/                 # 应用壳：布局、路由、权限守卫
    pages/
      chat/
      graph/
        explore/
        reasoning/
        manage-entities/
        manage-relations/
      sources/
      settings/
    components/          # 可复用组件（MessageList、GraphView、EntityForm…）
    services/
      apiClient.ts       # axios 实例、拦截器、错误映射
      chat.ts            # /api/v1/chat /api/v1/chat/stream
      graph.ts           # /knowledge_graph /kg_reasoning /entity* /relation*
      source.ts          # /source* /chunks /content_batch
      feedback.ts        # /feedback
    stores/              # zustand stores（session、ui、preferences）
    types/               # TS 类型（与后端 schema 对齐）
    utils/               # SSE parser、formatters、constants
  index.html
  vite.config.ts
  package.json
```

---

## 7. 权限与安全（建议纳入重构范围）

知识图谱管理（CRUD）属于“后台能力”。当前后端未提供认证鉴权接口，建议至少做到：

1. **最小可用（Phase 1）**：前端不做登录；通过网关/内网访问控制保护管理端
2. **可演进（Phase 2）**：后端加简单鉴权（API Key / JWT），前端提供登录页与 token 存储、路由守卫

> 若不做任何鉴权，管理端能力会对外暴露，存在数据被篡改风险。

---

## 8. 实施计划（里程碑）

### Phase 0：脚手架与联调（1–2 天）

- 初始化 `frontend-react/`，跑通 Vite + Antd + ProLayout
- 接入 API base url、dev proxy
- 实现统一 `apiClient` 与错误提示规范

### Phase 1：Chat 工作台（2–4 天）

- 支持 `/api/v1/chat` 非流式请求
- 支持 `/api/v1/chat/stream` POST-SSE 流式输出（fetch 解析）
- Agent 选择、debug 开关、session_id 持久化
- 反馈上报 `/feedback`

### Phase 2：图谱探索与推理（3–5 天）

- 图谱可视化组件（G6/cytoscape）
- 全局图谱 `/knowledge_graph`
- 推理 `/kg_reasoning` + 图谱/表格双视图

### Phase 3：图谱管理（3–6 天）

- 实体/关系：搜索、创建、更新、删除
- 类型下拉：`/entity_types`、`/relation_types`
- 表单校验、错误处理、操作审计（前端日志）

### Phase 4：源内容与调试增强（2–4 天）

- chunk 列表 `/chunks`
- source/content 批量接口对接
- 性能面板（前端侧统计）

### Phase 5：发布与切换（1–2 天）

- build + 部署（Nginx/静态资源/CDN）
- 旧 Streamlit 前端下线或保留为内部工具

---

## 9. 风险与对策

1. **POST + SSE 浏览器兼容性**
   - 对策：实现 fetch SSE parser；或新增 GET SSE endpoint（推荐中长期）

2. **CORS/跨域问题**
   - 对策：本地用 Vite proxy；生产用同域反代或后端加 CORS

3. **英文/电影数据导致抽取与展示变复杂**
   - 对策：前端展示层保持“结构化字段 + 原文证据”；图谱节点 tooltip 显示 description/labels

4. **管理端缺少鉴权**
   - 对策：短期通过内网/网关限制；中期补 JWT

---

## 10. 验收标准（前端重构）

1. Chat：
   - 能选择 Agent、能发送消息、能拿到回答
   - 流式输出能逐字展示（token 事件）
   - debug 模式可切换，能展示执行轨迹（若后端返回）

2. 图谱：
   - 能加载全局图谱并可视化
   - 能做一次推理查询并展示结果（图+表）

3. 管理：
   - 实体/关系 CRUD 能完成并提示成功/失败原因

4. 源内容：
   - 能通过 source_id 拉取源内容并展示

5. 工程：
   - 有清晰目录结构、环境变量、可一键启动 dev

---

## 11. 当前实现状态（以仓库为准）

> 说明：当前仓库同时保留 `frontend/`（Streamlit）与 `frontend-react/`（React）。本节描述 `frontend-react/` 的实现情况，用于回答“文档与代码是否一致、哪些已实现/未实现”。

### 11.1 已实现页面（React）

入口：`frontend-react/`（Vite + React + TS + Ant Design）

- `/api/v1/chat`：聊天工作台（支持非流式/流式、Agent 选择、调试面板、👍/👎 反馈、引用源内容标签、从回答提取图谱、示例问题点击填充）
- `/graph/explore`：全局图谱 + 从文本/回答提取图谱（可视化 + 表格 + 原始 JSON）
- `/graph/reasoning`：图谱推理（可视化 + 表格 + 原始 JSON）
- `/graph/manage/entities`：实体管理（查询/创建/更新/删除）
- `/graph/manage/relations`：关系管理（查询/创建/更新/删除）
- `/sources`：chunks 列表 + source 内容查看
- `/settings`：运行时配置 API Base URL + `GET /openapi.json` 连接测试

### 11.2 已实现能力点（React）

- 路由与页面框架：`react-router-dom`
- API Base URL：
  - 默认走 Vite 代理：`/api`（可通过 `frontend-react/vite.config.ts` 配置代理目标）
  - 运行时可在 `/settings` 写入 localStorage（对所有请求生效）
- SSE（POST + text/event-stream）：`frontend-react/src/utils/sse.ts` 采用 `fetch + ReadableStream` 解析 `data:` 帧
- 图谱可视化：`@antv/g6`（支持拖拽/缩放/节点提示、布局切换、按 group 过滤）

### 11.3 与“建议基线”的差异（当前选择）

文档第 3 章“技术选型”给的是建议基线；当前实现为了快速可用，做了收敛：

- 未引入：`@ant-design/pro-components`、`react-query`、`zustand`、`rehype-highlight`（后续需要再逐步补）
- 已引入：`antd`、`axios`、`react-markdown`、`remark-gfm`、`@antv/g6`

### 11.4 启动与联调（React）

- 进入目录：`cd frontend-react`
- 启动开发服务：`npm run dev`
- 代理后端：
  - 默认 `/api -> VITE_BACKEND_ORIGIN`（见 `frontend-react/.env.example`）
  - 或在 `/settings` 配置 `API Base URL` 直连（例如 `http://localhost:8122`）

---

## 12. 待完善（按优先级）

1) 可视化体验增强（可选）
- 节点/边点击交互（高亮邻居、展示详情面板）
- 更丰富的布局（层次布局、社区聚类上色、聚合/折叠）
- 大图谱性能（渲染降采样、按需加载/分页、后端 query filter）

2) 工程化增强（可选）
- 引入查询缓存与请求状态管理（如 `react-query`）并统一错误处理
- 统一表单校验/字段提示，补齐更多参数说明
- 增加前端 e2e/组件测试（若需要）

3) SSE 兼容性优化（可选）
- 在后端新增 `GET /api/v1/chat/stream`（query 参数传参或先 POST 创建任务再 GET 订阅），则可用原生 EventSource，浏览器兼容更好。
