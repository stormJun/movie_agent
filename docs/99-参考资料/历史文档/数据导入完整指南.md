# æ•°æ®å¯¼å…¥å®Œæ•´æŒ‡å— - æœ¬åœ° Docker Neo4j

**ç›®æ ‡**: å°†æºæ–‡æ¡£å¯¼å…¥åˆ°æœ¬åœ° Docker Neo4j æ•°æ®åº“ï¼Œæ„å»ºå®Œæ•´çš„çŸ¥è¯†å›¾è°±å’Œå‘é‡ç´¢å¼•ã€‚

---

## ğŸ“‹ å‰ç½®æ£€æŸ¥

### 1ï¸âƒ£ ç¡®è®¤ Docker Neo4j è¿è¡ŒçŠ¶æ€

```bash
# æŸ¥çœ‹ Neo4j å®¹å™¨çŠ¶æ€
docker ps | grep neo4j

# æœŸæœ›è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰:
# f1a9534342ed   neo4j:5.18   ...   Up 45 hours   0.0.0.0:7474->7474/tcp, 0.0.0.0:7687->7687/tcp   neo4j_faq
```

**å¦‚æœå®¹å™¨æœªè¿è¡Œ**ï¼Œå¯åŠ¨å®¹å™¨ï¼š
```bash
# æ–¹æ³•1: å¦‚æœæœ‰ docker-compose.yml
docker compose up -d

# æ–¹æ³•2: æ‰‹åŠ¨å¯åŠ¨ï¼ˆå¦‚æœå®¹å™¨å·²å­˜åœ¨ä½†åœæ­¢äº†ï¼‰
docker start neo4j_faq

# æ–¹æ³•3: åˆ›å»ºæ–°å®¹å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰å®¹å™¨ï¼‰
docker run -d \
  --name neo4j_faq \
  -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/password123 \
  -e NEO4J_PLUGINS='["apoc", "graph-data-science"]' \
  -e NEO4J_apoc_export_file_enabled=true \
  -e NEO4J_apoc_import_file_enabled=true \
  -e NEO4J_apoc_import_file_use__neo4j__config=true \
  -e NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.* \
  -v neo4j_data:/data \
  -v neo4j_logs:/logs \
  -v neo4j_import:/var/lib/neo4j/import \
  -v neo4j_plugins:/plugins \
  neo4j:5.18
```

### 2ï¸âƒ£ æµ‹è¯• Neo4j è¿æ¥

```bash
# æµ‹è¯•è¿æ¥
docker exec neo4j_faq cypher-shell -u neo4j -p password123 \
  "MATCH (n) RETURN count(n) as node_count LIMIT 1"

# æœŸæœ›è¾“å‡º:
# node_count
# <æ•°å­—>
```

âœ… **å¦‚æœçœ‹åˆ°æ•°å­—ï¼Œè¯´æ˜è¿æ¥æˆåŠŸï¼**

### 3ï¸âƒ£ æ£€æŸ¥é…ç½®æ–‡ä»¶

```bash
# æŸ¥çœ‹é¡¹ç›®æ ¹ç›®å½•çš„ .env æ–‡ä»¶
cat .env | grep NEO4J

# åº”è¯¥çœ‹åˆ°:
# NEO4J_URI='neo4j://localhost:7687'
# NEO4J_USERNAME='neo4j'
# NEO4J_PASSWORD='password123'
```

**å¦‚æœæ²¡æœ‰ .env æ–‡ä»¶æˆ–é…ç½®ä¸æ­£ç¡®**ï¼š
```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œç¡®ä¿ Neo4j é…ç½®æ­£ç¡®
vim .env  # æˆ–ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨
```

**å¿…é¡»ç¡®ä¿ .env ä¸­çš„é…ç½®**ï¼š
```env
# === Neo4j è¿æ¥ä¿¡æ¯ ===
NEO4J_URI='neo4j://localhost:7687'
NEO4J_USERNAME='neo4j'
NEO4J_PASSWORD='password123'  # æ”¹ä¸ºä½ çš„å®é™…å¯†ç 
NEO4J_MAX_POOL_SIZE=10
NEO4J_REFRESH_SCHEMA=false
```

### 4ï¸âƒ£ æ£€æŸ¥ Python ç¯å¢ƒ

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
conda activate graphrag  # æˆ– source .venv/bin/activate

# éªŒè¯ç¯å¢ƒ
python --version  # åº”è¯¥æ˜¯ Python 3.10.x
pip list | grep neo4j  # åº”è¯¥çœ‹åˆ° neo4j å’Œ langchain-neo4j

# å¦‚æœç¼ºå°‘ä¾èµ–
pip install -r requirements.txt
```

---

## ğŸ“ å‡†å¤‡æºæ–‡æ¡£

### 1ï¸âƒ£ åˆ›å»ºæ–‡æ¡£ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
mkdir -p files
```

### 2ï¸âƒ£ æ”¾ç½®æºæ–‡æ¡£

å°†æ‚¨çš„æºæ–‡æ¡£æ”¾å…¥ `files/` ç›®å½•ï¼š

```bash
# ç¤ºä¾‹ï¼šå¤åˆ¶æ–‡æ¡£åˆ° files/ ç›®å½•
cp ~/Documents/å­¦ç”Ÿç®¡ç†è§„å®š.pdf files/
cp ~/Documents/è€ƒå‹¤åˆ¶åº¦.docx files/
cp ~/Documents/FAQ.txt files/

# æŸ¥çœ‹å·²å‡†å¤‡çš„æ–‡æ¡£
ls -lh files/
```

**æ”¯æŒçš„æ–‡ä»¶æ ¼å¼**ï¼š
- âœ… æ–‡æœ¬æ–‡ä»¶: `.txt`, `.md`
- âœ… æ–‡æ¡£æ–‡ä»¶: `.pdf`, `.docx`, `.doc`
- âœ… æ•°æ®æ–‡ä»¶: `.csv`, `.json`, `.yaml`, `.yml`

**æ¨èæ–‡æ¡£å‡†å¤‡**ï¼š
```bash
files/
â”œâ”€â”€ å­¦ç”Ÿç®¡ç†è§„å®š.pdf          # ä¸»è¦ç®¡ç†è§„å®š
â”œâ”€â”€ è€ƒå‹¤ç®¡ç†åŠæ³•.docx         # è€ƒå‹¤ç›¸å…³
â”œâ”€â”€ å¥–å­¦é‡‘è¯„é€‰æ¡ä¾‹.pdf        # å¥–å­¦é‡‘æ”¿ç­–
â”œâ”€â”€ è¿çºªå¤„åˆ†è§„å®š.docx         # å¤„åˆ†åˆ¶åº¦
â””â”€â”€ å­¦ç”Ÿå¸¸è§é—®é¢˜FAQ.txt       # FAQ é›†åˆ
```

### 3ï¸âƒ£ éªŒè¯æ–‡æ¡£å¯è¯»æ€§

```bash
# æµ‹è¯•æ–‡æ¡£å¤„ç†å™¨
python -c "
from backend.infrastructure.pipelines.ingestion.document_processor import DocumentProcessor
from pathlib import Path

processor = DocumentProcessor(Path('files'), chunk_size=500, overlap=100)
docs = processor.process_directory()

print(f'æˆåŠŸè¯»å– {len(docs)} ä¸ªæ–‡æ¡£')
for doc in docs:
    print(f\"  - {doc['filename']}: {doc['content_length']} å­—ç¬¦, {doc.get('chunk_count', 0)} ä¸ªåˆ†å—\")
"
```

---

## ğŸš€ æ‰§è¡Œå®Œæ•´å¯¼å…¥æµç¨‹

### æ–¹æ³• 1: ä¸€é”®å®Œæ•´å¯¼å…¥ï¼ˆæ¨èï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
python -m backend.infrastructure.integrations.build.main
```

**æ‰§è¡Œè¿‡ç¨‹**ï¼ˆé¢„è®¡ 2-10 åˆ†é’Ÿï¼Œå–å†³äºæ–‡æ¡£æ•°é‡ï¼‰ï¼š

```
å¼€å§‹çŸ¥è¯†å›¾è°±å¤„ç†æµç¨‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ­¥éª¤ 0: æ¸…é™¤æ‰€æœ‰æ—§ç´¢å¼•
æ­¥éª¤ 1: æ„å»ºåŸºç¡€å›¾è°±
  âœ“ åˆå§‹åŒ–ç»„ä»¶
  âœ“ å¤„ç†æ–‡ä»¶
  âœ“ æ„å»ºå›¾ç»“æ„
  âœ“ æå–å®ä½“å’Œå…³ç³»
  âœ“ å†™å…¥æ•°æ®åº“

æ­¥éª¤ 2: æ„å»ºå®ä½“ç´¢å¼•å’Œç¤¾åŒº
  âœ“ åˆ›å»ºå®ä½“ç´¢å¼•
  âœ“ ç›¸ä¼¼å®ä½“æ£€æµ‹
  âœ“ å®ä½“åˆå¹¶
  âœ“ å®ä½“è´¨é‡æå‡
  âœ“ ç¤¾åŒºæ£€æµ‹
  âœ“ ç¤¾åŒºæ‘˜è¦

æ­¥éª¤ 3: æ„å»º Chunk ç´¢å¼•
  âœ“ åˆ›å»º Chunk ç´¢å¼•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
çŸ¥è¯†å›¾è°±å¤„ç†æµç¨‹å®Œæˆ
æ€»è€—æ—¶: 00:05:23
```

### æ–¹æ³• 2: åˆ†æ­¥æ‰§è¡Œï¼ˆé€‚ç”¨äºè°ƒè¯•æˆ–å¤§æ•°æ®é›†ï¼‰

#### æ­¥éª¤ 1: æ„å»ºåŸºç¡€å›¾è°±

```bash
python -c "
from backend.infrastructure.integrations.build.build_graph import KnowledgeGraphBuilder

builder = KnowledgeGraphBuilder()
builder.process()
"
```

**é¢„æœŸè¾“å‡º**ï¼š
```
ç³»ç»Ÿä¿¡æ¯: CPUæ ¸å¿ƒæ•° 8, å†…å­˜ 16.0GB
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¼€å§‹çŸ¥è¯†å›¾è°±æ„å»ºæµç¨‹

æ„å»ºåŸºç¡€çŸ¥è¯†å›¾è°±
  âœ“ å¤„ç†æ–‡ä»¶ (2.3ç§’)
  âœ“ æ„å»ºå›¾ç»“æ„ (1.8ç§’)
  âœ“ æå–å®ä½“å’Œå…³ç³» (45.7ç§’)
  âœ“ å†™å…¥æ•°æ®åº“ (3.2ç§’)

åŸºç¡€çŸ¥è¯†å›¾è°±æ„å»ºå®Œæˆ
æ€»è€—æ—¶: 00:00:53
```

#### æ­¥éª¤ 2: æ„å»ºå®ä½“ç´¢å¼•å’Œç¤¾åŒº

```bash
python -c "
from backend.infrastructure.integrations.build.build_index_and_community import IndexCommunityBuilder

builder = IndexCommunityBuilder()
builder.process()
"
```

**é¢„æœŸè¾“å‡º**ï¼š
```
æ„å»ºç´¢å¼•å’Œç¤¾åŒº
  âœ“ åˆ›å»ºå®ä½“ç´¢å¼• (12.5ç§’)
  âœ“ æ£€æµ‹ç›¸ä¼¼å®ä½“ (15.8ç§’)
  âœ“ åˆå¹¶å®ä½“ (8.2ç§’)
  âœ“ å®ä½“è´¨é‡æå‡ (6.3ç§’)
  âœ“ ç¤¾åŒºæ£€æµ‹ (6.2ç§’)
  âœ“ ç¤¾åŒºæ‘˜è¦ (22.1ç§’)

ç´¢å¼•å’Œç¤¾åŒºæ„å»ºæµç¨‹å®Œæˆ
æ€»è€—æ—¶: 00:01:11
```

#### æ­¥éª¤ 3: æ„å»º Chunk ç´¢å¼•

```bash
python -c "
from backend.infrastructure.integrations.build.build_chunk_index import ChunkIndexBuilder

builder = ChunkIndexBuilder()
builder.process()
"
```

**é¢„æœŸè¾“å‡º**ï¼š
```
æ„å»º Chunk ç´¢å¼•
  âœ“ åˆ›å»º Chunk ç´¢å¼• (19.4ç§’)

Chunk ç´¢å¼•æ„å»ºå®Œæˆ
æ€»è€—æ—¶: 00:00:19
```

---

## âœ… éªŒè¯å¯¼å…¥ç»“æœ

### 1ï¸âƒ£ ä½¿ç”¨ Cypher-Shell éªŒè¯

```bash
# è¿›å…¥ Neo4j Shell
docker exec -it neo4j_faq cypher-shell -u neo4j -p password123
```

**åœ¨ Cypher Shell ä¸­æ‰§è¡ŒæŸ¥è¯¢**ï¼š

```cypher
// 1. æŸ¥çœ‹æ€»ä½“ç»Ÿè®¡
MATCH (n)
RETURN
  labels(n)[0] as NodeType,
  count(n) as Count
ORDER BY Count DESC;

// æœŸæœ›è¾“å‡ºç¤ºä¾‹:
// â•’â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â••
// â”‚ NodeType   â”‚ Count â”‚
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•¡
// â”‚ __Entity__ â”‚ 156   â”‚
// â”‚ __Chunk__  â”‚ 89    â”‚
// â”‚ Document   â”‚ 5     â”‚
// â”‚ __Community__ â”‚ 12 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜

// 2. æŸ¥çœ‹å…³ç³»ç»Ÿè®¡
MATCH ()-[r]->()
RETURN
  type(r) as RelationType,
  count(r) as Count
ORDER BY Count DESC;

// 3. éªŒè¯ Entity æ˜¯å¦æœ‰ embedding
MATCH (e:__Entity__)
RETURN
  count(e) as Total,
  count(e.embedding) as WithEmbedding,
  (count(e.embedding) * 100.0 / count(e)) as Percentage;

// æœŸæœ›è¾“å‡º:
// â•’â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â••
// â”‚ Total â”‚ WithEmbeddingâ”‚ Percentage â”‚
// â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•¡
// â”‚ 156   â”‚ 156          â”‚ 100.0      â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// 4. éªŒè¯ Chunk æ˜¯å¦æœ‰ embedding
MATCH (c:__Chunk__)
RETURN
  count(c) as Total,
  count(c.embedding) as WithEmbedding,
  (count(c.embedding) * 100.0 / count(c)) as Percentage;

// 5. æŸ¥çœ‹å‘é‡ç´¢å¼•
SHOW INDEXES;

// 6. æŸ¥çœ‹ç¤ºä¾‹å®ä½“
MATCH (e:__Entity__)
RETURN e.id, e.description, e.type
LIMIT 10;

// 7. æŸ¥çœ‹ç¤ºä¾‹å…³ç³»
MATCH (e1:__Entity__)-[r]->(e2:__Entity__)
RETURN e1.id, type(r), e2.id
LIMIT 10;

// 8. æŸ¥çœ‹ç¤¾åŒº
MATCH (c:__Community__)
RETURN c.id, c.level, c.title
LIMIT 5;

// é€€å‡º Shell
:exit
```

### 2ï¸âƒ£ ä½¿ç”¨ Neo4j æµè§ˆå™¨éªŒè¯

```bash
# 1. æµè§ˆå™¨è®¿é—®
http://localhost:7474

# 2. ç™»å½•
ç”¨æˆ·å: neo4j
å¯†ç : password123

# 3. åœ¨æŸ¥è¯¢æ¡†ä¸­æ‰§è¡Œ Cypher
MATCH (n)
RETURN n
LIMIT 50

# 4. æŸ¥çœ‹å›¾è°±å¯è§†åŒ–
MATCH p=(e1:__Entity__)-[r]->(e2:__Entity__)
RETURN p
LIMIT 25
```

### 3ï¸âƒ£ ä½¿ç”¨ Python éªŒè¯

```bash
python -c "
from infrastructure.providers.neo4jdb import get_db_manager
from neo4j import GraphDatabase

# è·å–è¿æ¥
db = get_db_manager()
graph = db.graph

# ç»Ÿè®¡èŠ‚ç‚¹
result = graph.query('MATCH (n) RETURN labels(n)[0] as type, count(n) as count')
print('èŠ‚ç‚¹ç»Ÿè®¡:')
for row in result:
    print(f\"  {row['type']}: {row['count']}\")

# ç»Ÿè®¡å…³ç³»
result = graph.query('MATCH ()-[r]->() RETURN type(r) as type, count(r) as count')
print('\\nå…³ç³»ç»Ÿè®¡:')
for row in result:
    print(f\"  {row['type']}: {row['count']}\")

# æ£€æŸ¥ embedding
result = graph.query('''
    MATCH (e:__Entity__)
    RETURN count(e) as total, count(e.embedding) as with_embedding
''')
row = result[0]
print(f\"\\nå®ä½“ Embedding: {row['with_embedding']}/{row['total']} ({row['with_embedding']*100.0/row['total']:.1f}%)\")

result = graph.query('''
    MATCH (c:__Chunk__)
    RETURN count(c) as total, count(c.embedding) as with_embedding
''')
row = result[0]
print(f\"Chunk Embedding: {row['with_embedding']}/{row['total']} ({row['with_embedding']*100.0/row['total']:.1f}%)\")

print('\\nâœ… å¯¼å…¥éªŒè¯å®Œæˆï¼')
"
```

### 4ï¸âƒ£ æµ‹è¯•å‘é‡æ£€ç´¢

```bash
	python -c "
	from langchain_community.vectorstores import Neo4jVector
	from infrastructure.providers.models import get_embeddings_model
	from infrastructure.providers.neo4jdb import get_db_manager

db = get_db_manager()
embeddings = get_embeddings_model()

# æµ‹è¯• Entity æ£€ç´¢
print('æµ‹è¯• Entity å‘é‡æ£€ç´¢:')
entity_store = Neo4jVector.from_existing_graph(
    embeddings,
    node_label='__Entity__',
    text_node_properties=['id', 'description'],
    embedding_node_property='embedding'
)

results = entity_store.similarity_search('æ—·è¯¾', k=3)
print(f'æ‰¾åˆ° {len(results)} ä¸ªç›¸å…³å®ä½“:')
for i, doc in enumerate(results):
    print(f\"  {i+1}. {doc.page_content[:50]}...\")

# æµ‹è¯• Chunk æ£€ç´¢
print('\\næµ‹è¯• Chunk å‘é‡æ£€ç´¢:')
chunk_store = Neo4jVector.from_existing_graph(
    embeddings,
    node_label='__Chunk__',
    text_node_properties=['text'],
    embedding_node_property='embedding'
)

results = chunk_store.similarity_search('æ—·è¯¾å¤šå°‘å­¦æ—¶ä¼šè¢«é€€å­¦', k=3)
print(f'æ‰¾åˆ° {len(results)} ä¸ªç›¸å…³æ–‡æœ¬å—:')
for i, doc in enumerate(results):
    print(f\"  {i+1}. {doc.page_content[:80]}...\")

print('\\nâœ… å‘é‡æ£€ç´¢æµ‹è¯•é€šè¿‡ï¼')
"
```

---

## ğŸ”„ å¢é‡æ›´æ–°ï¼ˆæ·»åŠ æ–°æ–‡æ¡£ï¼‰

### åœºæ™¯ï¼šå·²æœ‰çŸ¥è¯†å›¾è°±ï¼Œç°åœ¨è¦æ·»åŠ æ–°æ–‡æ¡£

```bash
# 1. å°†æ–°æ–‡æ¡£æ”¾å…¥ files/ ç›®å½•
cp ~/Documents/æ–°è§„å®š.pdf files/

# 2. æ‰§è¡Œå¢é‡æ›´æ–°
python -m backend.infrastructure.integrations.build.incremental_update --once

# æˆ–è€…å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ï¼ˆè‡ªåŠ¨ç›‘æ§æ–‡ä»¶å˜åŒ–ï¼‰
python -m backend.infrastructure.integrations.build.incremental_update --daemon
```

**å¢é‡æ›´æ–°ç‰¹ç‚¹**ï¼š
- âœ… åªå¤„ç†æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡æ¡£
- âœ… è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å˜åŒ–
- âœ… ä¿ç•™åŸæœ‰æ•°æ®
- âœ… è‡ªåŠ¨å®ä½“å¯¹é½å’Œå†²çªè§£å†³

---

## ğŸ”§ å¸¸è§é—®é¢˜å¤„ç†

### é—®é¢˜ 1: Neo4j è¿æ¥è¶…æ—¶

**ç—‡çŠ¶**ï¼š
```
neo4j.exceptions.ServiceUnavailable: Failed to establish connection
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep neo4j

# 2. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs neo4j_faq --tail 50

# 3. é‡å¯å®¹å™¨
docker restart neo4j_faq

# 4. ç­‰å¾… 30 ç§’åå†æ¬¡æµ‹è¯•è¿æ¥
sleep 30
docker exec neo4j_faq cypher-shell -u neo4j -p password123 "RETURN 1"
```

### é—®é¢˜ 2: å¯†ç é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
neo4j.exceptions.AuthError: The client is unauthorized due to authentication failure.
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ–¹æ³•1: é‡ç½® Neo4j å¯†ç 
docker exec neo4j_faq cypher-shell -u neo4j -p <æ—§å¯†ç > \
  "ALTER CURRENT USER SET PASSWORD FROM '<æ—§å¯†ç >' TO '<æ–°å¯†ç >'"

# æ–¹æ³•2: å®Œå…¨é‡å»ºå®¹å™¨ï¼ˆä¼šä¸¢å¤±æ•°æ®ï¼ï¼‰
docker stop neo4j_faq
docker rm neo4j_faq
docker volume rm neo4j_data  # åˆ é™¤æ•°æ®å·

# é‡æ–°åˆ›å»ºï¼ˆå‚è€ƒå‰ç½®æ£€æŸ¥æ­¥éª¤ï¼‰
```

### é—®é¢˜ 3: OpenAI API è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
openai.error.AuthenticationError: Incorrect API key provided
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ .env é…ç½®
cat .env | grep OPENAI

# ç¡®ä¿é…ç½®æ­£ç¡®
OPENAI_API_KEY='sk-xxx'  # æ›¿æ¢ä¸ºçœŸå® API Key
OPENAI_BASE_URL='http://localhost:13000/v1'  # æˆ–å®˜æ–¹åœ°å€
OPENAI_LLM_MODEL='gpt-4o'
OPENAI_EMBEDDINGS_MODEL='text-embedding-3-large'
```

### é—®é¢˜ 4: å†…å­˜ä¸è¶³

**ç—‡çŠ¶**ï¼š
```
OutOfMemoryError: Java heap space
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¢åŠ  Neo4j å®¹å™¨å†…å­˜é™åˆ¶
docker update --memory 8g --memory-swap 8g neo4j_faq

# æˆ–åœ¨åˆ›å»ºå®¹å™¨æ—¶æŒ‡å®š
docker run -d --memory 8g --memory-swap 8g ...

# è°ƒæ•´ GDS å†…å­˜é™åˆ¶ï¼ˆ.env æ–‡ä»¶ï¼‰
GDS_MEMORY_LIMIT=4  # é™ä½åˆ° 4GB
```

### é—®é¢˜ 5: å¯¼å…¥ä¸­æ–­æ¢å¤

**å¦‚æœå¯¼å…¥è¿‡ç¨‹ä¸­æ–­**ï¼š

```bash
# 1. æ¸…ç†ä¸å®Œæ•´çš„æ•°æ®
docker exec -it neo4j_faq cypher-shell -u neo4j -p password123

# åœ¨ Cypher Shell ä¸­æ‰§è¡Œ
MATCH (n) WHERE n.embedding IS NULL DETACH DELETE n;
MATCH (n:__Chunk__) WHERE n.embedding IS NULL DELETE n;

# 2. é‡æ–°æ‰§è¡Œå®Œæ•´å¯¼å…¥
python -m backend.infrastructure.integrations.build.main
```

### é—®é¢˜ 6: Embedding æœªç”Ÿæˆ

**æ£€æŸ¥**ï¼š
```bash
python -c "
from infrastructure.providers.neo4jdb import get_db_manager
db = get_db_manager()

# æ£€æŸ¥ç¼ºå¤± embedding çš„èŠ‚ç‚¹
result = db.graph.query('''
    MATCH (e:__Entity__)
    WHERE e.embedding IS NULL
    RETURN count(e) as missing_embeddings
''')
print(f\"ç¼ºå¤± embedding çš„å®ä½“: {result[0]['missing_embeddings']}\")
"
```

**æ‰‹åŠ¨ä¿®å¤**ï¼š
```bash
# åªé‡æ–°ç”Ÿæˆç´¢å¼•ï¼ˆä¸é‡æ–°æ„å»ºå›¾è°±ï¼‰
python -c "
from backend.infrastructure.integrations.build.build_index_and_community import IndexCommunityBuilder

builder = IndexCommunityBuilder()
builder.build_index_and_communities()
"
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å°æ•°æ®é›†ï¼ˆ< 10 ä¸ªæ–‡æ¡£ï¼‰
```env
MAX_WORKERS=2
BATCH_SIZE=50
ENTITY_BATCH_SIZE=25
CHUNK_BATCH_SIZE=50
EMBEDDING_BATCH_SIZE=32
```

### ä¸­ç­‰æ•°æ®é›†ï¼ˆ10-50 ä¸ªæ–‡æ¡£ï¼‰
```env
MAX_WORKERS=4
BATCH_SIZE=100
ENTITY_BATCH_SIZE=50
CHUNK_BATCH_SIZE=100
EMBEDDING_BATCH_SIZE=64
```

### å¤§æ•°æ®é›†ï¼ˆ> 50 ä¸ªæ–‡æ¡£ï¼‰
```env
MAX_WORKERS=8
BATCH_SIZE=200
ENTITY_BATCH_SIZE=100
CHUNK_BATCH_SIZE=200
EMBEDDING_BATCH_SIZE=128
GDS_MEMORY_LIMIT=8
```

---

## ğŸ” å¯¼å…¥åæ£€æŸ¥æ¸…å•

- [ ] Neo4j å®¹å™¨æ­£å¸¸è¿è¡Œ
- [ ] æ‰€æœ‰æ–‡æ¡£éƒ½æˆåŠŸå¤„ç†ï¼ˆæ— é”™è¯¯æ—¥å¿—ï¼‰
- [ ] Document èŠ‚ç‚¹æ•°é‡ = æºæ–‡æ¡£æ•°é‡
- [ ] __Entity__ èŠ‚ç‚¹éƒ½æœ‰ embedding
- [ ] __Chunk__ èŠ‚ç‚¹éƒ½æœ‰ embedding
- [ ] å‘é‡ç´¢å¼•åˆ›å»ºæˆåŠŸï¼ˆSHOW INDEXES å¯è§ï¼‰
- [ ] ç¤¾åŒºæ£€æµ‹å®Œæˆï¼ˆæœ‰ __Community__ èŠ‚ç‚¹ï¼‰
- [ ] å‘é‡æ£€ç´¢æµ‹è¯•é€šè¿‡
- [ ] å¯åŠ¨æœåŠ¡æµ‹è¯•é—®ç­”åŠŸèƒ½

---

## ğŸš€ å¿«é€Ÿå¯¼å…¥è„šæœ¬

åˆ›å»ºä¾¿æ·è„šæœ¬ `import_data.sh`ï¼š

```bash
#!/bin/bash
# æ–‡ä»¶: import_data.sh
# ç”¨é€”: ä¸€é”®å¯¼å…¥æ•°æ®åˆ°æœ¬åœ° Neo4j

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "=========================================="
echo "çŸ¥è¯†å›¾è°±æ•°æ®å¯¼å…¥å·¥å…·"
echo "=========================================="

# 1. æ£€æŸ¥ Neo4j å®¹å™¨
echo "1. æ£€æŸ¥ Neo4j å®¹å™¨çŠ¶æ€..."
if ! docker ps | grep -q neo4j_faq; then
    echo "âŒ Neo4j å®¹å™¨æœªè¿è¡Œï¼è¯·å…ˆå¯åŠ¨å®¹å™¨ã€‚"
    exit 1
fi
echo "âœ… Neo4j å®¹å™¨è¿è¡Œæ­£å¸¸"

# 2. æµ‹è¯•è¿æ¥
echo "2. æµ‹è¯• Neo4j è¿æ¥..."
if ! docker exec neo4j_faq cypher-shell -u neo4j -p password123 "RETURN 1" &> /dev/null; then
    echo "âŒ æ— æ³•è¿æ¥åˆ° Neo4jï¼è¯·æ£€æŸ¥å¯†ç é…ç½®ã€‚"
    exit 1
fi
echo "âœ… Neo4j è¿æ¥æˆåŠŸ"

# 3. æ£€æŸ¥æºæ–‡æ¡£
echo "3. æ£€æŸ¥æºæ–‡æ¡£..."
if [ ! -d "files" ] || [ -z "$(ls -A files)" ]; then
    echo "âŒ files/ ç›®å½•ä¸ºç©ºï¼è¯·å…ˆæ”¾å…¥æºæ–‡æ¡£ã€‚"
    exit 1
fi
echo "âœ… æ‰¾åˆ°æºæ–‡æ¡£:"
ls -lh files/

# 4. æ¿€æ´»ç¯å¢ƒ
echo "4. æ¿€æ´» Python ç¯å¢ƒ..."
if [ -d ".venv" ]; then
    source .venv/bin/activate
elif [ ! -z "$CONDA_DEFAULT_ENV" ]; then
    conda activate graphrag
else
    echo "âš ï¸  æœªæ£€æµ‹åˆ°è™šæ‹Ÿç¯å¢ƒï¼Œä½¿ç”¨ç³»ç»Ÿ Python"
fi

# 5. æ‰§è¡Œå¯¼å…¥
echo "5. å¼€å§‹å¯¼å…¥æ•°æ®..."
python -m backend.infrastructure.integrations.build.main

# 6. éªŒè¯ç»“æœ
echo "6. éªŒè¯å¯¼å…¥ç»“æœ..."
python -c "
from infrastructure.providers.neo4jdb import get_db_manager
db = get_db_manager()

result = db.graph.query('MATCH (n) RETURN labels(n)[0] as type, count(n) as count')
print('\\nèŠ‚ç‚¹ç»Ÿè®¡:')
for row in result:
    print(f\"  {row['type']}: {row['count']}\")

result = db.graph.query('MATCH (e:__Entity__) RETURN count(e) as total, count(e.embedding) as with_emb')
emb_rate = result[0]['with_emb'] * 100.0 / result[0]['total'] if result[0]['total'] > 0 else 0
print(f\"\\nå®ä½“ Embedding è¦†ç›–ç‡: {emb_rate:.1f}%\")
"

echo ""
echo "=========================================="
echo "âœ… æ•°æ®å¯¼å…¥å®Œæˆï¼"
echo "=========================================="
echo ""
echo "åç»­æ“ä½œ:"
echo "  1. è®¿é—® Neo4j æµè§ˆå™¨: http://localhost:7474"
echo "  2. å¯åŠ¨åç«¯æœåŠ¡: python -m backend.server.main"
echo "  3. å¯åŠ¨å‰ç«¯æœåŠ¡: streamlit run frontend/app.py"
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x import_data.sh

# æ‰§è¡Œå¯¼å…¥
./import_data.sh
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/Neo4jå‘é‡ç´¢å¼•æ•°æ®æ¥æºå’Œå†™å…¥æµç¨‹.md` - æŠ€æœ¯ç»†èŠ‚
- `docs/Chatå·¥ä½œå°å®Œæ•´è°ƒç”¨æµç¨‹.md` - ç³»ç»Ÿæ¶æ„
- `CLAUDE.md` - é¡¹ç›®æ€»ä½“è¯´æ˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-29
**ä½œè€…**: Claude Code
**é€‚ç”¨ç¯å¢ƒ**: æœ¬åœ° Docker Neo4j
