# 数据导入执行记录

**时间**: 2025-12-29 16:58
**目标**: 将 15 个源文档导入到本地 Docker Neo4j (`neo4j_faq` 容器)

---

## 📊 源文档统计

### 文档列表（15个文件）

| 文件名 | 类型 | 内容长度 | 分块数量 | 状态 |
|--------|------|----------|----------|------|
| 2023学生手册.pdf | PDF文档 | 124,850 | 167 | ✅ 已处理 |
| 华东理工大学本科生请假申请表.doc | Word文档 | 54 | 1 | ⚠️ 部分失败 |
| 华东理工大学关于印发《学生勤工助学管理办法》的通知.pdf | PDF文档 | 3,431 | 4 | ✅ 已处理 |
| 华东理工大学《大学英语》课程教学实施方案.pdf | PDF文档 | 600 | 1 | ✅ 已处理 |
| 华东理工大学研究生论文答辩程序.doc | Word文档 | 55 | 1 | ⚠️ 部分失败 |
| 华东理工大学本科生上海市奖学金管理办法.txt | 文本文件 | 2,005 | 3 | ✅ 已处理 |
| 华东理工大学学生先进个人和集体评选办法.txt | 文本文件 | 1,287 | 2 | ✅ 已处理 |
| 华东理工大学社会工作奖评选条例.txt | 文本文件 | 1,698 | 2 | ✅ 已处理 |
| 华东理工大学《退役士兵教育资助管理条例》.txt | 文本文件 | 1,199 | 2 | ✅ 已处理 |
| 华东理工大学学生申诉管理规定.txt | 文本文件 | 3,102 | 4 | ✅ 已处理 |
| 华东理工大学《毕业生基层就业国家资助管理条例》.txt | 文本文件 | 2,458 | 3 | ✅ 已处理 |
| 华东理工大学本科生奖学金评定条例.txt | 文本文件 | 2,463 | 3 | ✅ 已处理 |
| 华东理工大学本科生国家励志奖学金管理办法.txt | 文本文件 | 1,244 | 2 | ✅ 已处理 |
| 华东理工大学本科生国家奖学金管理办法.txt | 文本文件 | 2,015 | 3 | ✅ 已处理 |
| 华东理工大学学生违纪处分规定.txt | 文本文件 | 5,963 | 8 | ✅ 已处理 |

**总计**:
- 文件数: 15 个
- 总字符数: 152,424
- 文本块数: 206 个
- 平均块大小: 926.8 字符

---

## 🔄 执行过程

### 第一次尝试（失败）
- **命令**: `python -m backend.infrastructure.integrations.build.main`
- **错误**: Exit code 139 (Segmentation fault)
- **原因**: PyTorch/HanLP 在加载模型时崩溃（CUDA 相关问题）
- **时间**: 约 5 分钟

### 第二次尝试（当前进行中）
- **命令**: `CUDA_VISIBLE_DEVICES="" OMP_NUM_THREADS=1 MKL_NUM_THREADS=1 python -m backend.infrastructure.integrations.build.main`
- **状态**: 🔄 运行中，但可能卡住
- **进程ID**: f4d4eb

#### 已完成的步骤：

✅ **步骤 0: 清除所有旧索引**
- 删除了 1 个索引
- 1 个索引因约束保护无法删除（这是正常的）

✅ **步骤 1.1: 初始化组件**
- HanLP 中文分词模型下载完成 (43.5 MB)
- 系统检测: 14 CPU 核心, 48GB 内存

✅ **步骤 1.2: 处理文件**
- 15 个文件全部读取成功
- 2 个 .doc 文件部分失败（但有备用内容）

✅ **步骤 1.3: 构建图结构**
- 生成 206 个文本块
- 创建 Document 和 Chunk 节点
- 创建节点间关系（HAS_CHUNK, NEXT_CHUNK）
- 写入数据库耗时: 0.41秒

⏸️ **步骤 1.4: 提取实体和关系（当前状态）**
- **状态**: 进程运行但无新输出（已等待 10+ 分钟）
- **预期**: 需要处理 167 个块，分 16 批次
- **问题**: LLM API 调用可能遇到问题（超时、限流或网络问题）

❌ **步骤 1.5: 写入实体到数据库**
- 未开始

❌ **步骤 2: 构建实体索引和社区**
- 未开始

❌ **步骤 3: 构建 Chunk 索引**
- 未开始

---

## 🐛 问题分析

### 当前卡住的可能原因

1. **LLM API 调用问题**
   - OpenAI API Key 配置: `sk-d62a8fd7954c4278a1d5a8e7eb4e1c12`
   - One-API 地址: `http://localhost:13000/v1`
   - 可能的问题:
     - One-API 服务未启动
     - API 配额用尽
     - 网络连接问题
     - 请求超时设置过短

2. **进程卡死**
   - 虽然进程显示 running，但可能已经死锁
   - 无新输出超过 10 分钟

3. **文件处理问题**
   - .doc 文件读取失败可能影响后续处理
   - 建议将 .doc 转换为 .docx 格式

---

## ✅ 下一步建议

### 方案 1: 检查 One-API 服务状态（推荐）

```bash
# 1. 检查 One-API 容器是否运行
docker ps | grep one-api

# 2. 检查 One-API 可访问性
curl http://localhost:13000/v1/models

# 3. 如果服务未运行，启动它
docker start one-api
# 或重新创建
docker run --name one-api -d --restart always \
  -p 13000:3000 \
  -e TZ=Asia/Shanghai \
  -v ~/data/one-api:/data \
  justsong/one-api
```

### 方案 2: 终止当前进程，使用官方 OpenAI API

```bash
# 1. 修改 .env 文件
nano .env
# 更改:
# OPENAI_BASE_URL='https://api.openai.com/v1'
# OPENAI_API_KEY='sk-your-real-openai-key'

# 2. 重新运行导入
source .venv/bin/activate
python -m backend.infrastructure.integrations.build.main
```

### 方案 3: 分步执行，跳过实体抽取（快速测试）

```bash
# 仅测试文档处理和图结构构建
source .venv/bin/activate
python -c "
from backend.infrastructure.integrations.build.build_graph import KnowledgeGraphBuilder
from backend.infrastructure.pipelines.ingestion.document_processor import DocumentProcessor
from pathlib import Path

processor = DocumentProcessor(Path('files'), chunk_size=500, overlap=100)
docs = processor.process_directory()

print(f'成功处理 {len(docs)} 个文档')
for doc in docs:
    print(f'  - {doc[\"filename\"]}: {doc[\"content_length\"]} 字符')
"
```

### 方案 4: 手动验证当前 Neo4j 状态

```bash
# 查看已导入的数据
docker exec neo4j_faq cypher-shell -u neo4j -p password123 "
MATCH (n)
RETURN labels(n)[0] as type, count(n) as count
ORDER BY count DESC
"

# 如果有 Document 和 Chunk 节点，说明部分导入成功
```

---

## 📝 当前 Neo4j 配置

```env
NEO4J_URI='neo4j://localhost:7687'
NEO4J_USERNAME='neo4j'
NEO4J_PASSWORD='password123'
NEO4J_MAX_POOL_SIZE=10
NEO4J_REFRESH_SCHEMA=false
```

**容器状态**:
- 容器名: neo4j_faq
- 端口: 7474 (HTTP), 7687 (Bolt)
- 状态: Running (Up 45+ hours)

---

## 🔍 调试步骤

1. **检查进程是否真的卡住**:
```bash
# 查看 Python 进程
ps aux | grep "graphrag_agent"

# 检查 CPU 使用率（如果为 0，说明卡住了）
top -p $(pgrep -f "graphrag_agent")
```

2. **检查网络连接**:
```bash
# 测试 One-API 连接
curl -X POST http://localhost:13000/v1/api/v1/chat/completions \
  -H "Content-Type: backend/application/json" \
  -H "Authorization: Bearer sk-d62a8fd7954c4278a1d5a8e7eb4e1c12" \
  -d '{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "测试"}]
  }'
```

3. **查看完整错误日志**:
```bash
# 如果有日志文件
tail -f logs/*.log
```

---

**建议优先执行**: 方案 1 (检查 One-API 服务)

**如果急需测试**: 方案 4 (验证当前状态) + 方案 2 (使用官方 API)
